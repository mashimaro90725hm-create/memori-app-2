<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÂøÜÊ†ñ ¬∑ Memori</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@300;500;700&family=Noto+Serif+KR:wght@300;500;700&family=Noto+Serif+SC:wght@300;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- üèÆ ‰∏≠ÂõΩËâ≤‰∏ªÈ¢òÂèòÈáè (Zhongguose Palette) --- */
        :root {
          /* Ëä°È£üÁôΩ Qi√†ns√® B√°i (ËÉåÊôØÁ±≥ÁôΩ) */
          --color-bg-main: #E2E1E4; 
          /* ‰πåËâ≤ W≈´s√® (ÊñáÂ≠óÊ∑±Ë§ê) */
          --color-text-main: #2D241E; 
          /* ËåúËâ≤ Qi√†ns√® (Âº∫Ë∞ÉÊ∑±Á∫¢) */
          --color-accent: #CB3A56; 
          /* Â´£Á∫¢ YƒÅnh√≥ng (Âº∫Ë∞ÉËâ≤ÊÇ¨ÂÅú) */
          --color-accent-hover: #EF7A82; 
          /* ÊöñË∞ÉÊØõÁéªÁíÉËÉåÊôØ */
          --glass-bg: rgba(255, 253, 248, 0.95); 
          /* ÊöñË∞ÉÊØõÁéªÁíÉËæπÊ°Ü */
          --glass-border: rgba(203, 58, 86, 0.15); 
        }

        /* üé® Âü∫Á°ÄËÆæÁΩÆ */
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: var(--color-bg-main); font-family: 'Noto Serif SC', serif; color: var(--color-text-main); }

        .app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.8s ease; position: relative; }
        .app-container.with-texture::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }

        .glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 4px 20px -1px rgba(45, 36, 30, 0.05); border-radius: 24px; }
        .artistic-border { border-radius: 24px; }

        /* Â∞ÅÈù¢È°µ */
        .cover-stage { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .cover-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(45, 36, 30, 0.7) 0%, transparent 100%); }
        .cover-content { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
        .cover-text { flex: 1; color: #f8f4e6; text-shadow: 0 2px 15px rgba(0,0,0,0.5); padding-left: 50px; text-align: right; }
        .cover-title { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; margin: 0; letter-spacing: 0.05em; color: #fff; }
        .subtitle { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; margin-top: 15px; opacity: 0.9; letter-spacing: 0.3em; }
        .start-btn { margin-top: 60px; padding: 15px 40px; font-size: 1.2rem; background: var(--color-accent); color: white; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(203, 58, 86, 0.4); font-family: 'Zen Old Mincho'; letter-spacing: 2px; }
        .start-btn:hover { background: var(--color-accent-hover); transform: translateY(-3px); }
        .cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; align-items: flex-end; }
        .cover-cat { max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5)); transform: translateX(-10%) scaleX(-1); }

        /* Sidebar */
        .sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
        .sidebar-header { padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { font-size: 1.1rem; font-weight: bold; margin: 0; }
        .add-dict-btn { cursor: pointer; color: var(--color-accent); font-size: 0.9rem; transition: transform 0.2s; }
        .add-dict-btn:hover { transform: scale(1.1); }
        .word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
        .word-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: rgba(255, 253, 248, 0.5); border-left: 2px solid transparent; }
        .word-item.active { background: white; border-left-color: var(--color-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-weight: bold; }
        .word-item:hover { background: rgba(255, 255, 255, 0.8); }
        .local-icon { font-size: 0.7rem; color: #8d6e63; margin-left: 5px; }
        .del-icon { opacity: 0; transition: opacity 0.2s; color: #aaa; cursor: pointer; }
        .word-item:hover .del-icon { opacity: 1; }
        .sidebar-footer { padding-top: 20px; border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 10px; }
        .nav-btn { width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 8px; text-align: center; cursor: pointer; background: rgba(255,255,255,0.5); transition: all 0.2s; font-family: 'Zen Old Mincho'; font-weight: bold; }
        .nav-btn:hover { background: white; color: var(--color-accent); transform: translateY(-2px); }
        
        /* Mascots */
        .shiba-mascot { position: absolute; bottom: 100%; right: 0; width: 110px; cursor: pointer; margin-bottom: 10px; }
        .cat-mascot { position: fixed; bottom: 30px; right: 30px; width: 250px; z-index: 100; pointer-events: none; }
        .cat-img { width: 100%; transform: scaleX(-1); filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1)); }

        /* Main Stage */
        .main-stage { flex: 1; display: flex; flex-direction: column; padding: 20px; z-index: 10; position: relative; }
        
        /* Language Bar (Ordered) */
        .search-bar { margin: 0 20px 20px; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
        .lang-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; margin-right: 15px; }
        .lang-pill { padding: 6px 12px; border-radius: 4px; background: rgba(255,255,255,0.4); cursor: pointer; white-space: nowrap; font-size: 0.9rem; transition: all 0.2s; border: 1px solid transparent; font-family: 'Zen Old Mincho'; }
        .lang-pill.active { background: white; color: var(--color-accent); font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-color: var(--glass-border); }
        .input-group { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.5); border-radius: 8px; padding: 0 15px; }
        .search-input { flex: 1; background: transparent; border: none; padding: 10px; outline: none; font-family: inherit; font-size: 1rem; }
        
        /* --- 4. Elegant Card Design (ÈõÖËá¥Áâà) --- */
        .content-area { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .card-3d { width: 500px; height: 720px; perspective: 1500px; cursor: pointer; }
        .card-inner { width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; position: relative; }
        .card-inner.flipped { transform: rotateY(180deg); }
        /* Á∫ØÁôΩÈõÖËá¥Â∫ï */
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: #fffdf9; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 40px rgba(45, 36, 30, 0.08); padding: 40px; }
        
        /* Front Face (Typography Focus) */
        .front-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; }
        .front-content::after { content: ""; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; border: 1px solid rgba(45,36,30,0.05); pointer-events: none; }
        .main-word { font-size: 4.8rem; font-family: 'Zen Old Mincho', serif; margin-bottom: 10px; color: var(--color-text-main); line-height: 1.1; letter-spacing: -0.02em; }
        .pronunciation { font-size: 1.2rem; color: var(--color-accent); font-family: sans-serif; margin-bottom: 40px; font-weight: 300; letter-spacing: 1px; }
        .meaning { font-size: 1.4rem; line-height: 2; max-width: 90%; font-weight: 500; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 30px; font-family: 'Noto Serif SC'; }
        .card-actions { position: absolute; top: 0; right: 0; display: flex; gap: 10px; z-index: 10; }
        .icon-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #ccc; transition: all 0.2s; }
        .icon-btn:hover { color: var(--color-accent); }
        .icon-btn.active { color: var(--color-accent); }

        /* Back Face */
        .card-face.back { transform: rotateY(180deg); background: #fffefb; }
        .back-scroll { overflow-y: auto; height: 100%; padding-right: 5px; }
        .section-header { font-size: 0.85rem; font-weight: bold; color: var(--color-accent); margin: 30px 0 15px; border-bottom: 2px solid rgba(203,58,86,0.1); padding-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; display: inline-block; }
        .etymology { font-size: 1rem; line-height: 1.9; text-align: justify; color: #555; font-family: 'Noto Serif SC', serif; margin-bottom: 20px; }
        /* ‰æãÂè•ÈõÖËá¥Âåñ */
        .example-item { margin-bottom: 20px; padding-left: 15px; border-left: 2px solid rgba(203,58,86,0.2); }
        .ex-text { font-family: 'Zen Old Mincho', serif; font-size: 1.15rem; margin-bottom: 8px; color: #222; cursor: pointer; line-height: 1.6; }
        .ex-text:hover { color: var(--color-accent); }
        .ex-cn { font-size: 0.9rem; opacity: 0.6; font-family: 'Noto Serif SC'; }
        
        /* 5. ‰∫§‰∫íÂºèÊ†áËÆ∞ (‰ªÖÈü©ËØ≠) */
        .interactive { cursor: pointer; border-bottom: 1px dotted var(--color-accent); transition: background 0.2s; }
        .interactive:hover { background: rgba(203, 58, 86, 0.1); }

        /* Gallery Mode (ÂçïËØçÊú¨) */
        .gallery-view { width: 100%; height: 100%; padding: 30px; display: flex; flex-direction: column; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; overflow-y: auto; padding-bottom: 20px; }
        .gallery-card { background: white; padding: 25px; border-radius: 8px; cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid rgba(0,0,0,0.05); text-align: center; }
        .gallery-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-color: var(--glass-border); }
        .gallery-card h4 { font-size: 1.6rem; font-weight: bold; margin-bottom: 5px; font-family: 'Zen Old Mincho'; }
        .review-btn-main { background: var(--color-accent); color: white; padding: 10px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; letter-spacing: 1px; }

        /* Review Overlay */
        .review-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,253,248,0.98); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .review-card { width: 600px; padding: 60px; background: white; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 20px 60px rgba(0,0,0,0.05); text-align: center; }
        .srs-controls { display: flex; gap: 15px; justify-content: center; margin-top: 40px; }
        .srs-btn { padding: 12px 30px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-family: sans-serif; }

        /* Timeline Mode (ÂÆöÂà∂ÊéíÂ∫è + ÂõæÊ†áÂâçÁΩÆ) */
        .history-view { width: 100%; height: 100%; padding: 20px; display: flex; flex-direction: column; }
        .history-controls { margin-bottom: 20px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; }
        .timeline-input-row { display: flex; gap: 10px; margin-top: 10px; }
        .t-input { padding: 8px; border-radius: 4px; border: 1px solid #ddd; background: rgba(255,255,255,0.8); outline: none; }
        .timeline-container { flex: 1; overflow-y: auto; padding-left: 20px; position: relative; }
        .timeline-line { position: absolute; left: 100px; top: 0; bottom: 0; width: 1px; background: var(--color-accent); opacity: 0.3; }
        .year-group { display: flex; margin-bottom: 30px; align-items: flex-start; }
        .year-label { width: 100px; text-align: right; padding-right: 25px; font-weight: bold; font-family: 'Zen Old Mincho'; font-size: 1.2rem; color: var(--color-accent); position: relative; top: 5px; }
        .events-list { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        
        /* 3. ÂéÜÂè≤Âπ¥Ë°®Êù°ÁõÆÊ†∑Âºè */
        .event-card { background: white; padding: 15px 20px; border-radius: 4px; position: relative; border: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; transition: transform 0.2s; }
        .event-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .event-dot { position: absolute; left: -26px; top: 50%; transform: translateY(-50%); width: 11px; height: 11px; background: #fff; border: 3px solid var(--color-accent); border-radius: 50%; }
        .country-tag { font-size: 0.75rem; font-weight: bold; color: var(--color-text-main); background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px; font-family: sans-serif; letter-spacing: 1px; }
        .event-text { font-family: 'Noto Serif SC'; font-size: 1.05rem; }
        .delete-event { opacity: 0; cursor: pointer; color: #aaa; margin-left: auto; font-size: 0.9rem; }
        .event-card:hover .delete-event { opacity: 1; }

        /* Modal */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-body { background: white; width: 450px; padding: 40px; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.1); }

        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay"></div>
                <div class="cover-content">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat" alt="Cover Cat"></div>
                    <div class="cover-text">
                        <h1 class="cover-title">ÂøÜÊ†ñ ¬∑ Memori</h1>
                        <p class="subtitle">Ë®ÄËëâ„ÅÆËÄÉÂè§Â≠¶</p>
                        <button class="start-btn" @click="enterApp">ÂºÄÂêØ‰π¶Êñã</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container" :style="{ background: currentLangConfig.bg, fontFamily: currentLangConfig.font }">
            
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header">
                    <h3>{{ currentLangConfig.flag }} {{ currentLangConfig.name }}</h3>
                    <div class="add-dict-btn" @click="showImportModal = true" title="Ê∑ªÂä†Êú¨Âú∞ËæûÂÖ∏"><i class="fa-solid fa-plus"></i> Á¶ªÁ∫øÂ∫ì</div>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" 
                         class="word-item" 
                         :class="{ 'active': mode === 'card' && card && item.id === card.id }"
                         @click="loadWord(item)">
                        <span>{{ item.word }}</span>
                        <i v-if="item.isLocal" class="fa-solid fa-scroll local-icon"></i>
                        <i class="fa-solid fa-trash del-icon" @click.stop="deleteWord(item.id)"></i>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="shiba-img" alt="Shiba">
                    </div>
                    <button class="nav-btn" @click="mode = 'gallery'">
                        <i class="fa-solid fa-book"></i> ÂçïËØçÊú¨
                    </button>
                    <button class="nav-btn" @click="mode = 'history'">
                        <i class="fa-solid fa-clock"></i> ÂéÜÂè≤Âπ¥Ë°®
                    </button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism artistic-border">
                    <div class="lang-scroll custom-scroll">
                        <button v-for="key in langOrder" :key="key" 
                                class="lang-pill" 
                                :class="{ 'active': currentLang === key }" 
                                @click="switchLang(key)">
                            {{ langConfig[key].flag }} {{ langConfig[key].name }}
                        </button>
                    </div>
                    <div class="input-group">
                        <input v-model="wordInput" @keyup.enter="handleSearch" :placeholder="`Âú®${currentLangConfig.name}‰∏≠ËÄÉÊçÆ...`" class="search-input">
                        <button @click="handleSearch" class="search-btn">
                            <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                            <i v-else class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </div>
                </div>

                <div class="content-area">
                    <div v-if="mode === 'card' && card" class="card-3d" @click="isFlipped = !isFlipped">
                        <div class="card-inner" :class="{ 'flipped': isFlipped }">
                            <div class="card-face front-content">
                                <div class="card-actions" @click.stop>
                                    <div class="icon-btn" :class="{active: card.isCollected}" @click="toggleCollect">
                                        <i class="fa-solid fa-bookmark"></i>
                                    </div>
                                </div>
                                <h1 class="main-word">{{ card.word }}</h1>
                                <div class="pronunciation">
                                    <span>/ {{ card.reading }} /</span>
                                    <div class="icon-btn" style="display:inline-flex; width:30px; height:30px; margin-left:10px;" @click.stop="speak(card.word, card.lang)">
                                        <i class="fa-solid fa-volume-high"></i>
                                    </div>
                                </div>
                                <p class="meaning" v-html="card.meaning"></p>
                                <div style="margin-top:auto; font-size:0.8rem; color:#999; font-family:sans-serif;">ÁøªËΩ¨Êü•ÁúãËÄÉÊçÆ</div>
                            </div>
                            <div class="card-face back">
                                <div class="back-scroll custom-scroll" @click.stop>
                                    <div v-if="card.etymology">
                                        <div class="section-header">üóùÔ∏è ËØçÊ∫êËÄÉÊçÆ (Wikipedia)</div>
                                        <div class="etymology" v-html="card.etymology"></div>
                                    </div>
                                    
                                    <div class="section-header">üìú ÂÖ∏Á±ç‰æãÂè•</div>
                                    <div v-if="card.examples">
                                        <div v-for="(ex, i) in card.examples" :key="i" class="example-item">
                                            <div class="ex-text" @click.stop="speak(ex.text, card.lang)">
                                                <span v-html="formatInteractiveText(ex.text)"></span> 
                                                <i class="fa-solid fa-volume-low" style="font-size:0.8em; margin-left:5px; opacity:0.5;"></i>
                                            </div>
                                            <div class="ex-cn">{{ ex.cn }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'gallery'" class="gallery-view glass-morphism artistic-border">
                        <div class="gallery-header">
                            <h2 style="font-size:1.8rem; font-weight:bold; font-family:'Zen Old Mincho'">ÊàëÁöÑËóè‰π¶ ({{ filteredHistory.length }})</h2>
                            <button class="review-btn-main" @click="startReview">
                                <i class="fa-solid fa-play"></i> ÂºÄÂßãÂ§ç‰π† ({{ dueCount }})
                            </button>
                        </div>
                        <div class="gallery-grid custom-scroll">
                            <div v-for="item in filteredHistory" :key="item.id" class="gallery-card" @click="loadWord(item)">
                                <h4>{{ item.word }}</h4>
                                <p style="opacity:0.6; font-size:0.9rem;">{{ item.reading }}</p>
                                <i v-if="item.isLocal" class="fa-solid fa-scroll" style="position:absolute; bottom:10px; right:10px; color:#ddd;"></i>
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'review'" class="review-overlay">
                        <div v-if="reviewCard" class="review-card">
                            <h2 style="font-size:3.5rem; margin-bottom:30px; font-family:'Zen Old Mincho'">{{ reviewCard.word }}</h2>
                            <div v-if="!showReviewAnswer">
                                <button class="review-btn-main" @click="showReviewAnswer = true">Êü•ÁúãÈáä‰πâ</button>
                            </div>
                            <div v-else>
                                <p style="font-size:1.2rem; color:var(--color-accent); margin-bottom:15px;">{{ reviewCard.reading }}</p>
                                <p style="margin-bottom:30px; font-size:1.2rem;">{{ reviewCard.meaning }}</p>
                                <div class="srs-controls">
                                    <button class="srs-btn" style="background:#ef4444" @click="handleSRS(1)">Âøò (1Â§©)</button>
                                    <button class="srs-btn" style="background:#f59e0b" @click="handleSRS(2)">Èöæ (3Â§©)</button>
                                    <button class="srs-btn" style="background:#10b981" @click="handleSRS(4)">ÁÜü (7Â§©)</button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center">
                            <h2 style="font-size:2rem; margin-bottom:20px;">‰ªäÊó•Â§ç‰π†ÂÆåÊàê üéâ</h2>
                            <button class="review-btn-main" @click="mode = 'gallery'">ËøîÂõûÂçïËØçÊú¨</button>
                        </div>
                    </div>

                    <div v-if="mode === 'history'" class="history-view glass-morphism artistic-border">
                        <div class="history-controls">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <h2 style="font-size:1.6rem; font-weight:bold; font-family:'Zen Old Mincho'">ÂéÜÂè≤Âπ¥Ë°®</h2>
                                <div>
                                    <button class="lang-pill" :class="{active: historyTab==='asia'}" @click="historyTab='asia'">üåè ‰∫öÊ¥≤</button>
                                    <button class="lang-pill" :class="{active: historyTab==='europe'}" @click="historyTab='europe'">üèõÔ∏è Ê¨ßÊ¥≤</button>
                                </div>
                            </div>
                            <div class="timeline-input-row">
                                <input v-model="newEvent.year" placeholder="Âπ¥‰ªΩ (Â¶Ç BC 221)" class="t-input" style="width:100px;">
                                <input v-model="newEvent.event" placeholder="‰∫ã‰ª∂ÊèèËø∞" class="t-input" style="flex:1;">
                                <input v-model="newEvent.tag" placeholder="ÂõΩÂà´ (CN/JP)" class="t-input" style="width:80px; text-align:center;">
                                <button class="review-btn-main" style="padding:8px 15px;" @click="addTimelineEvent">Ê∑ªÂä†</button>
                            </div>
                        </div>
                        <div class="timeline-container custom-scroll">
                            <div class="timeline-line"></div>
                            <div v-for="group in sortedTimelines" :key="group.year" class="year-group">
                                <div class="year-label">{{ group.year }}</div>
                                <div class="events-list">
                                    <div v-for="item in group.events" :key="item.id" class="event-card">
                                        <div class="event-dot"></div>
                                        <span class="country-tag">{{ item.tag }}</span>
                                        <span class="event-text">{{ item.event }}</span>
                                        <i class="fa-solid fa-trash delete-event" @click="deleteTimelineEvent(item.id)"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div v-if="mode !== 'history' && mode !== 'review'" class="cat-mascot-container" @click="pokeMascot">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" accept="image/*" style="display:none">
                <div class="cat-img-wrapper" @dblclick="$refs.mascotInput.click()" title="ÂèåÂáªÊõ¥Êç¢Áå´Âí™">
                    <img :src="userCat" class="cat-img" alt="Cat Mascot">
                </div>
            </div>
        </div>

        <div v-if="showImportModal" class="modal-mask" @click.self="showImportModal = false">
            <div class="modal-body">
                <h3 style="font-size:1.2rem; font-weight:bold; margin-bottom:15px;">üì• ÂØºÂÖ•Êú¨Âú∞ËæûÂÖ∏ (JSON)</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px;">ÁõÆÊ†áËØ≠Áßç</label>
                    <select v-model="importLang" class="t-input" style="width:100%;">
                        <option v-for="key in langOrder" :key="key" :value="key">{{ langConfig[key].name }}</option>
                    </select>
                </div>
                <input type="file" @change="e => importFile = e.target.files[0]" accept=".json">
                <button class="review-btn-main" style="width:100%; margin-top:20px;" @click="executeImport">Á°ÆËÆ§ÂØºÂÖ•</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // IndexedDB Êï∞ÊçÆÂ∫ì
        class DictionaryDB {
            constructor() { this.dbName = 'MemoriDB_V6_Pure'; this.db = null; }
            async open() {
                return new Promise((resolve) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        ['jp', 'cjp', 'kr', 'zh', 'lzh', 'en', 'de', 'it', 'lat'].forEach(lang => {
                            if (!db.objectStoreNames.contains(lang)) db.createObjectStore(lang, { keyPath: 'word' });
                        });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                });
            }
            async find(lang, word) {
                if (!this.db) await this.open();
                return new Promise((resolve) => {
                    if (!this.db.objectStoreNames.contains(lang)) return resolve(null);
                    const req = this.db.transaction(lang, 'readonly').objectStore(lang).get(word);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            }
            async bulkAdd(lang, items) {
                if (!this.db) await this.open();
                return new Promise((resolve) => {
                    const tx = this.db.transaction(lang, 'readwrite');
                    const store = tx.objectStore(lang);
                    let count = 0;
                    items.forEach(item => {
                        store.put({ 
                            word: item.word || item.wordName, 
                            reading: item.reading || item.pronunciation || '',
                            meaning: item.meaning || item.wordDesc,
                            isLocal: true
                        });
                        count++;
                    });
                    tx.oncomplete = () => resolve(count);
                });
            }
        }

        createApp({
            setup() {
                const db = new DictionaryDB();
                const showCover = ref(true);
                const currentLang = ref('jp');
                const wordInput = ref('');
                const loading = ref(false);
                const isFlipped = ref(false);
                const history = ref([]);
                const card = ref(null);
                
                // 1. ÈªòËÆ§ËøõÂÖ•ÂéÜÂè≤Ê®°Âºè
                const mode = ref('history');
                
                const showImportModal = ref(false);
                const importLang = ref('jp');
                const importFile = ref(null);
                
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };
                const userCat = ref(localStorage.getItem('memori-user-cat') || './my-cat.png');
                const shibaImages = { idle: './shiba/idle.gif', happy: './shiba/happy.gif' };
                const neroState = ref('idle');

                // 6. ‰∏•Ê†ºËØ≠ÁßçÈ°∫Â∫è
                const langOrder = ['jp', 'cjp', 'kr', 'zh', 'lzh', 'en', 'de', 'it', 'lat'];
                const unifiedFont = "'Zen Old Mincho', serif";
                const langConfig = {
                    jp: { name: 'Êó•ËØ≠', flag: 'üáØüáµ', code: 'ja-JP', bg: 'linear-gradient(to top, #fff1eb 0%, #ace0f9 100%)', font: unifiedFont },
                    cjp: { name: 'Âè§ÂÖ∏Êó•ËØ≠', flag: 'üèØ', code: 'ja-JP', bg: '#EBE6DF', font: unifiedFont },
                    kr: { name: 'Èü©ËØ≠', flag: 'üá∞üá∑', code: 'ko-KR', bg: '#F7EFF2', font: "'Noto Serif KR', serif" },
                    zh: { name: 'Áé∞‰ª£Ê±âËØ≠', flag: 'üá®üá≥', code: 'zh-CN', bg: '#FBF8F1', font: "'Noto Serif SC', serif" },
                    lzh: { name: 'Âè§ÂÖ∏Ê±âËØ≠', flag: 'üìú', code: 'zh-CN', bg: '#E9EAE4', font: "'Zen Old Mincho', serif" },
                    en: { name: 'Ëã±ËØ≠', flag: 'üá¨üáß', code: 'en-US', bg: '#E6E8EB', font: "'Playfair Display', serif" },
                    de: { name: 'Âæ∑ËØ≠', flag: 'üá©üá™', code: 'de-DE', bg: '#E8ECEB', font: "'Playfair Display', serif" },
                    it: { name: 'ÊÑèËØ≠', flag: 'üáÆüáπ', code: 'it-IT', bg: '#F8F4E8', font: "'Playfair Display', serif" },
                    lat: { name: 'Êãâ‰∏ÅËØ≠', flag: 'üèõÔ∏è', code: 'it-IT', bg: '#EAE8E6', font: "'Cinzel', serif" }
                };
                const currentLangConfig = computed(() => langConfig[currentLang.value]);

                const filteredHistory = computed(() => history.value.filter(item => item.lang === currentLang.value && item.isCollected));
                
                // Â§ç‰π†Á≥ªÁªü
                const dueCount = computed(() => filteredHistory.value.filter(w => !w.nextReview || w.nextReview <= Date.now()).length);
                const reviewQueue = ref([]);
                const reviewCard = ref(null);
                const showReviewAnswer = ref(false);

                // 1. & 3. ÂéÜÂè≤Âπ¥Ë°®ËÆæÁΩÆ
                const historyTab = ref('asia');
                const timelines = ref({
                    asia: [
                        { id: 1, year: 'BC 7000', event: 'Ê≤≥ÂßÜÊ∏°ÊñáÂåñ', tag: 'CN' },
                        { id: 2, year: '1868', event: 'ÊòéÊ≤ªÁª¥Êñ∞', tag: 'JP' }
                    ],
                    europe: [
                        { id: 3, year: 'BC 27', event: 'ÁΩóÈ©¨Â∏ùÂõΩÂª∫Á´ã', tag: 'IT' },
                        { id: 4, year: '1789', event: 'Ê≥ïÂõΩÂ§ßÈù©ÂëΩ', tag: 'FR' }
                    ]
                });
                const newEvent = ref({ year: '', event: '', tag: 'CN' });

                function parseYear(y) {
                    let num = parseInt(y.replace(/[^0-9]/g, ''));
                    if (y.toUpperCase().includes('BC') || y.includes('Ââç') || y.includes('-')) num = -num;
                    return num;
                }
                const sortedTimelines = computed(() => {
                    const list = timelines.value[historyTab.value];
                    // ÊéíÂ∫èÔºöÂπ¥‰ª£ -> Ê∑ªÂä†È°∫Â∫è (ID)
                    const sorted = [...list].sort((a, b) => parseYear(a.year) - parseYear(b.year) || a.id - b.id);
                    
                    const grouped = [];
                    sorted.forEach(item => {
                        const last = grouped[grouped.length - 1];
                        if (last && last.year === item.year) last.events.push(item);
                        else grouped.push({ year: item.year, events: [item] });
                    });
                    return grouped;
                });

                function addTimelineEvent() {
                    if (!newEvent.value.year || !newEvent.value.event) return;
                    timelines.value[historyTab.value].push({ id: Date.now(), ...newEvent.value });
                    newEvent.value = { year: '', event: '', tag: 'CN' };
                    saveTimelines();
                }
                function deleteTimelineEvent(id) {
                    if(confirm('Âà†Èô§Ê≠§ÂéÜÂè≤‰∫ã‰ª∂Ôºü')) {
                        timelines.value[historyTab.value] = timelines.value[historyTab.value].filter(t => t.id !== id);
                        saveTimelines();
                    }
                }
                function saveTimelines() { localStorage.setItem('memori-timelines', JSON.stringify(timelines.value)); }

                onMounted(async () => {
                    await db.open();
                    const saved = localStorage.getItem('memori-book');
                    if (saved) history.value = JSON.parse(saved);
                    const savedTime = localStorage.getItem('memori-timelines');
                    if (savedTime) timelines.value = JSON.parse(savedTime);
                    
                    const img = new Image(); img.src = coverImages.bg;
                    img.onerror = () => coverImages.bg = 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1600&q=80';
                });

                async function handleSearch() {
                    if (!wordInput.value.trim()) return;
                    loading.value = true;
                    mode.value = 'card';
                    isFlipped.value = false;
                    const query = wordInput.value.trim();
                    const lang = currentLang.value;

                    // Êú¨Âú∞
                    const local = await db.find(lang, query);
                    if (local) {
                        card.value = { ...local, id: Date.now(), lang, isLocal: true, isCollected: false };
                        fetchEnrichment(query, lang);
                        loading.value = false;
                        return;
                    }

                    // ‰∫ëÁ´Ø
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word: query, lang: lang, type: 'full' })
                        });
                        const data = await res.json();
                        card.value = { id: Date.now(), ...data, lang: lang, isLocal: false, isCollected: false };
                    } catch (e) { alert('ÊåñÊéòÂ§±Ë¥•'); }
                    loading.value = false;
                }

                async function fetchEnrichment(word, lang) {
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word, lang, type: 'enrich' })
                        });
                        const data = await res.json();
                        if (card.value.word === word) {
                            card.value.etymology = data.etymology;
                            card.value.examples = data.examples;
                        }
                    } catch (e) { console.log('Ë°•ÂÖ®Â§±Ë¥•'); }
                }

                // 5. ‰ªÖÈü©ËØ≠ÊîØÊåÅ‰∫§‰∫íÂºèÊü•ËØ¢
                function formatInteractiveText(text) {
                    if (!text) return '';
                    if (currentLang.value === 'kr') {
                        return text.replace(/([Í∞Ä-Ìû£]+)/g, '<span class="interactive" onclick="document.dispatchEvent(new CustomEvent(\'search\', {detail:\'$1\'}))">$1</span>');
                    }
                    return text;
                }
                document.addEventListener('search', (e) => { wordInput.value = e.detail; handleSearch(); });

                // 2. Â§ç‰π†ÈÄªËæë (ÈÄöËøáÂçïËØçÊú¨)
                function startReview() {
                    const now = Date.now();
                    reviewQueue.value = filteredHistory.value.filter(w => !w.nextReview || w.nextReview <= now);
                    if(reviewQueue.value.length === 0) { alert('ÊöÇÊó†ÂæÖÂ§ç‰π†ÂçïËØç'); return; }
                    mode.value = 'review';
                    nextReview();
                }
                function nextReview() {
                    if (reviewQueue.value.length === 0) { reviewCard.value = null; return; }
                    reviewCard.value = reviewQueue.value.shift();
                    showReviewAnswer.value = false;
                }
                function handleSRS(level) {
                    const days = level === 1 ? 1 : level === 2 ? 3 : 7;
                    const idx = history.value.findIndex(h => h.id === reviewCard.value.id);
                    if (idx > -1) {
                        history.value[idx].nextReview = Date.now() + (days * 86400000);
                        saveHistory();
                    }
                    nextReview();
                }

                function saveHistory() { localStorage.setItem('memori-book', JSON.stringify(history.value)); }
                function speak(text, lang) { 
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = langConfig[lang]?.code || 'en-US';
                    window.speechSynthesis.speak(u); 
                }
                function handleFileSelect(e) { importFile.value = e.target.files[0]; }
                async function executeImport() {
                    if (!importFile.value) return;
                    const r = new FileReader();
                    r.onload = async (e) => {
                        const json = JSON.parse(e.target.result);
                        await db.bulkAdd(importLang.value, Array.isArray(json)?json:[]);
                        alert('ÂØºÂÖ•ÊàêÂäü'); showImportModal.value = false;
                    };
                    r.readAsText(importFile.value);
                }

                function enterApp() { showCover.value = false; }
                function switchLang(key) { currentLang.value = key; mode.value = 'card'; }
                function loadWord(item) { card.value = item; mode.value = 'card'; isFlipped.value = false; }
                function deleteWord(id) { 
                    if(confirm('Âà†Èô§Ê≠§ËØçÔºü')) {
                        history.value = history.value.filter(i => i.id !== id); 
                        saveHistory(); 
                    }
                }
                function toggleCollect() { 
                    if(!card.value) return; 
                    card.value.isCollected = !card.value.isCollected;
                    const idx = history.value.findIndex(h => h.word === card.value.word && h.lang === card.value.lang);
                    if (idx === -1 && card.value.isCollected) history.value.unshift(card.value);
                    else if (idx > -1) history.value[idx].isCollected = card.value.isCollected;
                    saveHistory();
                }
                function pokeMascot() { neroState.value = 'happy'; setTimeout(()=>neroState.value='idle', 1000); }
                function handleMascotUpload(e) { 
                    const f = e.target.files[0]; 
                    if(f) { const r = new FileReader(); r.onload=ev=>{ userCat.value=ev.target.result; localStorage.setItem('memori-user-cat', ev.target.result); }; r.readAsDataURL(f); }
                }

                return {
                    showCover, enterApp, currentLang, wordInput, loading, neroState, isFlipped, history, card, mode, showImportModal, historyTab, newEvent,
                    langConfig, coverImages, shibaImages, userCat, filteredHistory, sortedTimelines, langOrder, currentLangConfig,
                    handleSearch, speak, handleFileSelect, executeImport, formatInteractiveText,
                    switchLang, loadWord, deleteWord, toggleCollect, pokeMascot, handleMascotUpload,
                    addTimelineEvent, deleteTimelineEvent,
                    startReview, nextReview, handleSRS, reviewQueue, reviewCard, showReviewAnswer, dueCount
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
