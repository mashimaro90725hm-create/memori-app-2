<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memori - è¨€å¶ã®è€ƒå¤å­¦</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- ğŸ® å¿†æ –ä¸»é¢˜ç³»ç»Ÿ V3.0 --- */
:root {
  --color-bg-main: #E2E1E4;
  --color-text-main: #2D241E; 
  --color-accent: #CB3A56;
  --color-accent-hover: #EF7A82; 
  --glass-bg: rgba(255, 253, 248, 0.85);
  --glass-border: rgba(203, 58, 86, 0.15); 
}

* { box-sizing: border-box; }
.app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.8s ease, font-family 0.3s; position: relative; color: var(--color-text-main); }
.app-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }

.glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(110%); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px -1px rgba(45, 36, 30, 0.08); border-radius: 24px; }
.artistic-border { border-radius: 24px; }

/* ä¾§è¾¹æ  */
.sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; border-right: 1px solid rgba(0,0,0,0.05); }
.sidebar-header { padding: 0 10px 16px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
.sidebar-header h3 { font-size: 1.2rem; font-weight: bold; margin: 0; font-family: inherit; }
.import-btn { font-size: 0.8rem; color: var(--color-accent); cursor: pointer; opacity: 0.7; transition: opacity 0.2s; border: none; background: none; }
.import-btn:hover { opacity: 1; text-decoration: underline; }

.word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
.word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: rgba(255, 253, 248, 0.5); border-left: 3px solid transparent; }
.word-item:hover { background: rgba(255, 253, 248, 0.9); transform: translateX(3px); }
.word-item.active { background: white; border-left-color: var(--color-accent); box-shadow: 0 4px 10px rgba(45, 36, 30, 0.08); font-weight: bold; }
.local-badge { font-size: 0.7rem; color: #8d6e63; opacity: 0.8; margin-left: 5px; }

/* ä¸»èˆå° */
.main-stage { flex: 1; position: relative; display: flex; flex-direction: column; padding: 25px; z-index: 10; }
.search-bar { margin: 0 20px 20px; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 50; }
.lang-pills { display: flex; gap: 8px; }
.lang-pill { padding: 6px 12px; border-radius: 8px; background: rgba(255,255,255,0.4); cursor: pointer; border: 1px solid transparent; transition: all 0.3s; font-size: 0.9rem; }
.lang-pill.active { background: white; border-color: var(--color-accent); color: var(--color-accent); font-weight: bold; transform: scale(1.05); }
.search-input { flex: 1; background: transparent; border: none; outline: none; margin: 0 20px; font-size: 1.1rem; color: var(--color-text-main); font-family: inherit; }
.search-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--color-accent); transition: transform 0.2s; }
.search-btn:hover { transform: scale(1.1); }

/* å¡ç‰‡å®¹å™¨ */
.card-container { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 1500px; padding-bottom: 40px; }
.card-body { width: 100%; max-width: 800px; height: 100%; background: #fffdf9; border-radius: 24px; box-shadow: 0 10px 40px rgba(45, 36, 30, 0.08); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--glass-border); position: relative; }

/* å¡ç‰‡å†…å®¹å¸ƒå±€ */
.card-header { padding: 30px 40px; border-bottom: 1px dashed var(--glass-border); background: rgba(255,253,248,0.8); position: relative; }
.word-main { font-size: 3.5rem; font-family: 'Zen Old Mincho', serif; margin: 0; line-height: 1.2; color: var(--color-text-main); }
.word-reading { font-size: 1.2rem; color: var(--color-accent); opacity: 0.8; font-family: sans-serif; margin-top: 5px; display: flex; align-items: center; gap: 10px; }
.local-indicator { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; color: #8d6e63; cursor: help; }

.card-scroll-area { flex: 1; overflow-y: auto; padding: 30px 40px; }
.section-title { font-size: 0.9rem; font-weight: bold; color: var(--color-accent); margin: 25px 0 12px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; border-bottom: 1px solid rgba(203,58,86,0.1); padding-bottom: 5px; }
.meaning-text { font-size: 1.1rem; line-height: 1.8; text-align: justify; margin-bottom: 20px; white-space: pre-wrap; }

/* äº¤äº’å¼éš¾è¯æ ‡è®° */
.interactive-word { border-bottom: 1px dotted var(--color-text-main); cursor: pointer; transition: all 0.2s; color: var(--color-text-main); font-weight: 500; }
.interactive-word:hover { color: var(--color-accent); border-bottom-color: var(--color-accent); background: rgba(203, 58, 86, 0.05); border-radius: 4px; }

/* ä¾‹å¥æ ·å¼ */
.example-box { margin-bottom: 15px; padding: 15px; background: rgba(45,36,30,0.03); border-radius: 12px; border-left: 3px solid var(--color-accent); transition: transform 0.2s; }
.example-box:hover { transform: translateX(5px); background: rgba(45,36,30,0.05); }
.ex-origin { font-family: 'Noto Serif SC', serif; font-size: 1.05rem; margin-bottom: 6px; cursor: pointer; display: flex; justify-content: space-between; }
.ex-trans { font-size: 0.9rem; opacity: 0.7; }

/* è¯æºæ ·å¼ */
.etymology-text { font-size: 1rem; line-height: 1.7; color: #4a4a4a; padding: 15px; background: #fdfbf7; border: 1px solid #eee; border-radius: 12px; font-family: sans-serif; }

/* æ¨¡æ€æ¡† */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.modal-box { background: white; width: 450px; padding: 30px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
.modal-header { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; color: var(--color-text-main); border-bottom: 1px solid #eee; padding-bottom: 10px; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
.file-drop { border: 2px dashed #ddd; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; transition: all 0.3s; color: #888; }
.file-drop:hover { border-color: var(--color-accent); color: var(--color-accent); background: rgba(203,58,86,0.02); }

/* åŠ è½½åŠ¨ç”» */
.archaeology-loading { font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--color-accent); opacity: 0.8; margin-top: 20px; text-align: center; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

/* æ»šåŠ¨æ¡ */
.custom-scroll::-webkit-scrollbar { width: 5px; }
.custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container" :style="{ background: langConfig[currentLang].bg, fontFamily: langConfig[currentLang].font }">
            
            <aside class="sidebar glass-morphism">
                <div class="sidebar-header">
                    <h3>ğŸ“š {{ langConfig[currentLang].name }}</h3>
                    <button class="import-btn" @click="showImportModal = true">
                        <i class="fa-solid fa-file-import"></i> æŒ‚è½½è¾å…¸
                    </button>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" 
                         class="word-item" 
                         :class="{ 'active': currentWord && item.id === currentWord.id }"
                         @click="loadWord(item)">
                        <span>{{ item.word }}</span>
                        <i v-if="item.isLocal" class="fa-solid fa-scroll local-badge" title="æ¥è‡ªæœ¬åœ°å¤ç±"></i>
                    </div>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism">
                    <div class="lang-pills">
                        <button v-for="(cfg, key) in langConfig" :key="key" 
                                class="lang-pill" 
                                :class="{ 'active': currentLang === key }" 
                                @click="switchLang(key)">
                            {{ cfg.flag }} {{ cfg.name }}
                        </button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="handleSearch" 
                           :placeholder="`åœ¨${langConfig[currentLang].name}ä¸­è€ƒæ®...`" 
                           class="search-input">
                    <button @click="handleSearch" class="search-btn" :disabled="loading">
                        <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                        <i v-else class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <div class="card-container">
                    <div v-if="currentWord" class="card-body">
                        
                        <div class="card-header">
                            <h1 class="word-main">{{ currentWord.word }}</h1>
                            <div class="word-reading">
                                <span v-if="currentWord.reading">[{{ currentWord.reading }}]</span>
                                <button class="search-btn" @click="speak(currentWord.word)" style="font-size: 1rem;">
                                    <i class="fa-solid fa-volume-high"></i>
                                </button>
                            </div>
                            <i v-if="currentWord.isLocal" class="fa-solid fa-scroll local-indicator" title="ã€æœ¬åœ°çè—ã€‘ IndexedDB ç›´å‡º"></i>
                        </div>

                        <div class="card-scroll-area custom-scroll">
                            
                            <div class="section-title"><i class="fa-solid fa-book-open"></i> é‡Šä¹‰ (Definition)</div>
                            <div class="meaning-text" v-html="formatInteractiveText(currentWord.meaning)"></div>

                            <div v-if="currentWord.etymology || enriching" class="section-title">
                                <i class="fa-solid fa-landmark"></i> è¯æºè€ƒæ® (Etymology)
                            </div>
                            <div v-if="enriching" class="archaeology-loading">â›ï¸ æ­£åœ¨ä»äº‘ç«¯å‘æ˜å†å²åœ°å±‚...</div>
                            <div v-if="currentWord.etymology" class="etymology-text" v-html="formatInteractiveText(currentWord.etymology)"></div>

                            <div v-if="(currentWord.examples && currentWord.examples.length) || enriching" class="section-title">
                                <i class="fa-solid fa-quote-left"></i> å…¸ç±ä¸ä¾‹å¥ (Context)
                            </div>
                            <div v-if="currentWord.examples">
                                <div v-for="(ex, index) in currentWord.examples" :key="index" class="example-box">
                                    <div class="ex-origin" @click="speak(ex.text)">
                                        <span v-html="formatInteractiveText(ex.text)"></span>
                                        <i class="fa-solid fa-volume-low" style="font-size: 0.8rem; opacity: 0.5;"></i>
                                    </div>
                                    <div class="ex-trans">{{ ex.cn }}</div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div v-else class="text-center opacity-50" style="font-family: 'Zen Old Mincho'">
                        <i class="fa-solid fa-feather fa-3x mb-4"></i>
                        <p>è¾“å…¥è¯æ±‡ï¼Œå¼€å§‹è€ƒå¤æŒ–æ˜...</p>
                    </div>
                </div>
            </main>
        </div>

        <div v-if="showImportModal" class="modal-overlay" @click.self="showImportModal = false">
            <div class="modal-box">
                <div class="modal-header">ğŸ“¥ æŒ‚è½½ç¦»çº¿è¾å…¸ (IndexedDB)</div>
                <div class="form-group">
                    <label class="form-label">1. é€‰æ‹©ç›®æ ‡è¯­ç§åº“</label>
                    <select v-model="importLang" class="w-full p-3 border rounded bg-gray-50">
                        <option v-for="(cfg, key) in langConfig" :key="key" :value="key">{{ cfg.flag }} {{ cfg.name }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">2. ä¸Šä¼  JSON æ•°æ®</label>
                    <div class="file-drop" @click="$refs.fileInput.click()">
                        <p v-if="!importFile">ç‚¹å‡»é€‰æ‹© .json æ–‡ä»¶</p>
                        <p v-else style="color:var(--color-text-main)">{{ importFile.name }}</p>
                        <input type="file" ref="fileInput" accept=".json" style="display:none" @change="handleFileSelect">
                    </div>
                    <p class="text-xs text-gray-400 mt-2">æ ¼å¼: [{"word": "...", "reading": "...", "meaning": "..."}]</p>
                </div>
                <button class="w-full bg-red-800 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition" @click="executeImport">
                    <i class="fa-solid fa-upload"></i> ç¡®è®¤æŒ‚è½½
                </button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // --- IndexedDB æ ¸å¿ƒç±» (å¤šè¯­ç§åˆ†åº“) ---
        class DictionaryDB {
            constructor() {
                this.dbName = 'MemoriDictionaryDB_V3';
                this.db = null;
            }
            async open() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        // ä¸ºæ¯ç§è¯­è¨€å»ºç«‹ Store
                        ['jp', 'cjp', 'zh', 'lzh', 'en', 'de', 'it', 'lat', 'kr'].forEach(lang => {
                            if (!db.objectStoreNames.contains(lang)) {
                                db.createObjectStore(lang, { keyPath: 'word' }); // word ä½œä¸ºä¸»é”®
                            }
                        });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = (e) => reject(e);
                });
            }
            async find(lang, word) {
                if (!this.db) await this.open();
                return new Promise((resolve) => {
                    if (!this.db.objectStoreNames.contains(lang)) return resolve(null);
                    const tx = this.db.transaction(lang, 'readonly');
                    const req = tx.objectStore(lang).get(word);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            }
            async bulkAdd(lang, items) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    if (!this.db.objectStoreNames.contains(lang)) return reject('Language store not found');
                    const tx = this.db.transaction(lang, 'readwrite');
                    const store = tx.objectStore(lang);
                    let count = 0;
                    items.forEach(item => {
                        // æ ‡å‡†åŒ–å­—æ®µ
                        store.put({
                            word: item.word || item.wordName,
                            reading: item.reading || item.pronunciation || '',
                            meaning: item.meaning || item.wordDesc,
                            isLocal: true,
                            // æœ¬åœ°åº“é€šå¸¸åªæœ‰åŸºç¡€é‡Šä¹‰ï¼Œè¯æºä¾‹å¥ç•™ç»™ API è¡¥å…¨
                            etymology: null, 
                            examples: []
                        });
                        count++;
                    });
                    tx.oncomplete = () => resolve(count);
                    tx.onerror = (e) => reject(e);
                });
            }
        }

        createApp({
            setup() {
                const db = new DictionaryDB();
                const currentLang = ref('cjp'); // é»˜è®¤å¤æ—¥è¯­
                const wordInput = ref('');
                const loading = ref(false);
                const enriching = ref(false); // è¡¥å…¨çŠ¶æ€
                const currentWord = ref(null);
                const history = ref([]); // æœç´¢å†å²
                
                // å¯¼å…¥ç›¸å…³
                const showImportModal = ref(false);
                const importLang = ref('cjp');
                const importFile = ref(null);

                const unifiedFont = "'Zen Old Mincho', 'Noto Serif SC', 'Noto Serif JP', serif";
                const langConfig = {
                    cjp: { name: 'å¤å…¸æ—¥è¯­', flag: 'ğŸ¯', code: 'ja-JP', bg: '#EBE6DF', font: unifiedFont },
                    lzh: { name: 'å¤ä»£æ±‰è¯­', flag: 'ğŸ“œ', code: 'zh-CN', bg: '#E9EAE4', font: unifiedFont },
                    lat: { name: 'æ‹‰ä¸è¯­', flag: 'ğŸ›ï¸', code: 'it-IT', bg: '#EAE8E6', font: "'Cinzel', serif" }, // æ‹‰ä¸è¯­ç”¨æ„å¤§åˆ©è¯­å‘éŸ³ä»£ç†
                    jp: { name: 'æ—¥è¯­', flag: 'ğŸ‡¯ğŸ‡µ', code: 'ja-JP', bg: '#F9F1F0', font: unifiedFont },
                    zh: { name: 'ç°ä»£æ±‰è¯­', flag: 'ğŸ‡¨ğŸ‡³', code: 'zh-CN', bg: '#FBF8F1', font: unifiedFont },
                    en: { name: 'è‹±è¯­', flag: 'ğŸ‡¬ğŸ‡§', code: 'en-US', bg: '#E6E8EB', font: "'Playfair Display', serif" },
                    de: { name: 'å¾·è¯­', flag: 'ğŸ‡©ğŸ‡ª', code: 'de-DE', bg: '#E8ECEB', font: "'Playfair Display', serif" },
                    it: { name: 'æ„è¯­', flag: 'ğŸ‡®ğŸ‡¹', code: 'it-IT', bg: '#F8F4E8', font: "'Playfair Display', serif" },
                    kr: { name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·', code: 'ko-KR', bg: '#F7EFF2', font: unifiedFont }
                };

                const filteredHistory = computed(() => history.value.filter(h => h.lang === currentLang.value));

                onMounted(async () => {
                    await db.open();
                    // ç»‘å®š CJK ç‚¹å‡»äº‹ä»¶ (Event Delegation)
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('interactive-word')) {
                            wordInput.value = e.target.innerText;
                            handleSearch();
                        }
                    });
                });

                // --- æ ¸å¿ƒé€»è¾‘ï¼šåŒè½¨æ£€ç´¢ ---
                async function handleSearch() {
                    if (!wordInput.value.trim()) return;
                    const query = wordInput.value.trim();
                    const lang = currentLang.value;
                    
                    loading.value = true;
                    enriching.value = false;
                    currentWord.value = null;

                    try {
                        // 1. æœ¬åœ°æ‹¦æˆª (IndexedDB)
                        const localResult = await db.find(lang, query);
                        
                        if (localResult) {
                            console.log('ğŸ“š æœ¬åœ°å‘½ä¸­:', localResult);
                            currentWord.value = { ...localResult, lang };
                            addToHistory(currentWord.value);
                            loading.value = false; // UI ç«‹å³å“åº”
                            
                            // 2. å±€éƒ¨è¡¥å…¨ (Silent Enrichment)
                            enriching.value = true;
                            fetchEnrichment(query, lang);
                        } else {
                            // 3. å…¨é‡å‘æ˜ (Full Discovery API)
                            console.log('â˜ï¸ æœ¬åœ°æœªæ‰¾åˆ°ï¼Œå‘èµ·äº‘ç«¯è€ƒæ®...');
                            const apiRes = await fetch('/api/openai', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ word: query, lang, type: 'full' })
                            });
                            const data = await apiRes.json();
                            currentWord.value = { ...data, lang, isLocal: false };
                            addToHistory(currentWord.value);
                            loading.value = false;
                        }
                    } catch (e) {
                        alert('æ£€ç´¢å‡ºé”™: ' + e.message);
                        loading.value = false;
                    }
                }

                // å¼‚æ­¥è¡¥å…¨å‡½æ•°
                async function fetchEnrichment(word, lang) {
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word, lang, type: 'enrich' })
                        });
                        const data = await res.json();
                        // ä»…å½“å½“å‰æ˜¾ç¤ºçš„è¯è¿˜æ²¡å˜æ—¶æ›´æ–°ï¼Œé¿å…è¦†ç›–
                        if (currentWord.value && currentWord.value.word === word) {
                            currentWord.value.etymology = data.etymology;
                            currentWord.value.examples = data.examples;
                        }
                        enriching.value = false;
                    } catch (e) {
                        console.error('è¡¥å…¨å¤±è´¥', e);
                        enriching.value = false;
                    }
                }

                // --- è¾å…¸å¯¼å…¥ç³»ç»Ÿ ---
                function handleFileSelect(e) {
                    importFile.value = e.target.files[0];
                }
                async function executeImport() {
                    if (!importFile.value) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const items = Array.isArray(json) ? json : [];
                            const count = await db.bulkAdd(importLang.value, items);
                            alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡è¯ç›®åˆ°ã€${langConfig[importLang.value].name}ã€‘åº“ï¼`);
                            showImportModal.value = false;
                        } catch (err) {
                            alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ JSON æ ¼å¼ã€‚\néœ€è¦æ•°ç»„æ ¼å¼: [{"word":...}, ...]');
                        }
                    };
                    reader.readAsText(importFile.value);
                }

                // --- è¾…åŠ©åŠŸèƒ½ ---
                function addToHistory(item) {
                    // ç®€å•å»é‡
                    const exists = history.value.findIndex(h => h.word === item.word && h.lang === item.lang);
                    if (exists > -1) history.value.splice(exists, 1);
                    history.value.unshift(item);
                }

                function loadWord(item) {
                    currentWord.value = item;
                    // å¦‚æœæ˜¯ä»å†å²è®°å½•ç‚¹å‡»ä¸”æ²¡æœ‰ä¾‹å¥ï¼Œå°è¯•è§¦å‘è¡¥å…¨
                    if (!item.etymology && !item.examples) {
                        enriching.value = true;
                        fetchEnrichment(item.word, item.lang);
                    }
                }

                function switchLang(key) {
                    currentLang.value = key;
                    currentWord.value = null;
                }

                function speak(text) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = langConfig[currentLang.value].code;
                    u.rate = 0.85; // ç¨æ…¢ä¸€ç‚¹ï¼Œé€‚åˆé‰´èµ
                    window.speechSynthesis.speak(u);
                }

                // CJK éš¾è¯é«˜äº®å¤„ç† (HTML String Injection)
                // åç«¯ä¼šè¿”å›æ™®é€šæ–‡æœ¬ï¼Œå‰ç«¯è´Ÿè´£ç”¨ Regex è¯†åˆ«éš¾è¯æ¯”è¾ƒå›°éš¾ï¼Œ
                // è¿™é‡Œæˆ‘ä»¬è®©åç«¯ç›´æ¥è¿”å›å¸¦æ ‡è®°çš„HTMLï¼Œæˆ–è€…å‰ç«¯ç®€å•æŒ‰å­—åˆ†è¯ï¼ˆä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œå‡è®¾åç«¯å·²æ ‡è®°ï¼Œæˆ–è€…å‰ç«¯åšç®€å•çš„æ­£åˆ™ï¼‰
                // ä¸ºäº†å¢å¼ºä½“éªŒï¼Œæˆ‘ä»¬è¿™é‡Œå†™ä¸€ä¸ªç®€å•çš„é€šç”¨é€»è¾‘ï¼šå°†æ‰€æœ‰æ±‰å­—/å‡ååŒ…è£¹åœ¨ span ä¸­ï¼Ÿä¸ï¼Œå¤ªä¹±ã€‚
                // æ–¹æ¡ˆï¼šå®Œå…¨ä¾èµ–åç«¯ Prompt æŒ‡ä»¤åœ¨ JSON ä¸­è¿”å›å¸¦æ ‡ç­¾çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…åœ¨æ­¤å¤„å°†æ‰€æœ‰éæ ‡ç‚¹ç¬¦å·åŒ…è£¹ã€‚
                // æ—¢ç„¶éœ€æ±‚æ˜¯ CJK å¢å¼ºï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸€ä¸ªç®€å•çš„é€»è¾‘ï¼š
                function formatInteractiveText(text) {
                    if (!text) return '';
                    // å¦‚æœåç«¯æ²¡è¿”å› HTML æ ‡ç­¾ï¼Œå‰ç«¯å¼ºè¡Œå¤„ç† CJK å­—ç¬¦
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šå°†è¿ç»­çš„æ±‰å­—æˆ–å‡åè§†ä¸ºä¸€ä¸ªè¯å—ï¼ˆä»…ä½œæ¼”ç¤ºï¼Œæœ€å¥½åç«¯åˆ†è¯ï¼‰
                    // å®é™…ç­–ç•¥ï¼šåç«¯ Prompt å·²è¦æ±‚ CJK éš¾è¯ç”¨ <span> åŒ…è£¹ã€‚è¿™é‡Œåªè´Ÿè´£æ¸²æŸ“ HTMLã€‚
                    // è¡¥å……ï¼šä¸ºäº†è®©æ‰€æœ‰è¯å¯ç‚¹ï¼Œå¯ä»¥ç”¨æ­£åˆ™æ›¿æ¢æ‰€æœ‰ CJK å­—ç¬¦åºåˆ—ã€‚
                    const cjkRegex = /([\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]+)/g;
                    // å¦‚æœæ–‡æœ¬ä¸­å·²ç»åŒ…å«æ ‡ç­¾ï¼Œå°±ä¸å†å¤„ç†ï¼Œå¦åˆ™å¤„ç†
                    if (text.includes('<')) return text; 
                    return text.replace(cjkRegex, '<span class="interactive-word">$1</span>');
                }

                return {
                    langConfig, currentLang, wordInput, loading, enriching, currentWord, filteredHistory,
                    handleSearch, loadWord, switchLang, speak, formatInteractiveText,
                    showImportModal, importLang, importFile, handleFileSelect, executeImport
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
