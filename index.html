<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memori - è¨€å¶ã®è€ƒå¤å­¦</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- ğŸ® å¿†æ –ä¸»é¢˜ç³»ç»Ÿ V3.5 (ä¿®å¤ç‰ˆ) --- */
        :root {
            --color-bg-main: #E2E1E4;
            --color-text-main: #2D241E; 
            --color-accent: #CB3A56;
            --color-accent-hover: #EF7A82; 
            --glass-bg: rgba(255, 253, 248, 0.85);
            --glass-border: rgba(203, 58, 86, 0.15); 
        }

        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: #E2E1E4; font-family: 'Noto Serif SC', serif; }

        .app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.8s ease, font-family 0.3s; position: relative; color: var(--color-text-main); }
        /* çº¹ç†èƒŒæ™¯ */
        .app-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }

        .glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(110%); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px -1px rgba(45, 36, 30, 0.08); border-radius: 24px; }
        .artistic-border { border-radius: 24px; }

        /* ğŸšª å°é¢é¡µ (ç‰ç’ƒå…‰é™¢) */
        .cover-stage.classic-theme { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; overflow: hidden; }
        .cover-overlay-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(45, 36, 30, 0.6) 0%, rgba(45, 36, 30, 0.2) 60%, transparent 100%); }
        .cover-content-layout { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
        .cover-text-group.jp-style { flex: 1; color: #f8f4e6; text-shadow: 0 2px 10px rgba(0,0,0,0.6); padding-left: 50px; text-align: right; z-index: 50; }
        .cover-title-main { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; margin: 0; letter-spacing: 0.05em; color: #fff; }
        .subtitle-main { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; letter-spacing: 0.3em; margin-top: 15px; opacity: 0.95; color: var(--color-bg-main); }
        .start-btn-main.jp-btn { margin-top: 60px; font-family: 'Noto Serif JP', serif; padding: 16px 48px; font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent) 0%, #A62C45 100%); color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: all 0.4s; letter-spacing: 0.1em; box-shadow: 0 4px 20px rgba(203, 58, 86, 0.4); pointer-events: auto; position: relative; z-index: 100; }
        .cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; justify-content: flex-start; align-items: flex-end; z-index: 1; pointer-events: none; }
        .cover-cat-large { max-width: 100%; max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(60, 40, 30, 0.6)); transform: translateX(-10%) scaleX(-1); }

        /* Sidebar */
        .sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
        .sidebar-header { padding: 0 10px 16px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { font-size: 1.2rem; font-weight: bold; margin: 0; font-family: inherit; }
        .import-trigger { font-size: 0.8rem; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
        .word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 10px; border-radius: 16px; cursor: pointer; transition: all 0.2s; color: var(--color-text-main); border-left: 4px solid transparent; position: relative; background: rgba(255, 253, 248, 0.5); }
        .word-item.active { background: white; box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); font-weight: bold; color: var(--color-text-main); }
        .del-icon { opacity: 0; border: none; background: none; color: var(--color-accent); cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .word-item:hover .del-icon { opacity: 1; }
        .sidebar-footer { padding-top: 25px; display: flex; flex-direction: column; gap: 12px; position: relative; border-top: 1px solid var(--glass-border); }
        .action-btn { width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 12px; font-weight: bold; cursor: pointer; background: rgba(255, 253, 248, 0.6); transition: all 0.2s; }
        .action-btn:hover { background: white; color: var(--color-accent); transform: translateY(-2px); }

        /* Mascots */
        .shiba-mascot { position: absolute; bottom: 100%; right: 0px; width: 120px; height: 120px; cursor: pointer; z-index: 20; margin-bottom: 15px; }
        .shiba-img { width: 100%; height: 100%; object-fit: contain; }
        .cat-mascot-container { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 280px; cursor: pointer; z-index: 100; pointer-events: auto; }
        .cat-mascot-img { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }

        /* Main Stage */
        .main-stage { flex: 1; position: relative; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
        .search-bar { margin: 0 20px 25px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .lang-pills { display: flex; gap: 8px; }
        .lang-pill { padding: 5px 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255, 253, 248, 0.5); cursor: pointer; transition: all 0.3s; }
        .lang-pill.active { background: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); font-weight: bold; color: var(--color-accent); }
        .search-input { border: none; background: transparent; padding: 10px; flex: 1; margin: 0 20px; outline: none; font-size: 1.1rem; font-family: inherit; color: var(--color-text-main); }
        .search-btn { border: none; background: transparent; cursor: pointer; font-size: 1.2rem; }

        /* Card 3D */
        .content-area { flex: 1; display: flex; justify-content: center; align-items: center; }
        .card-3d-wrapper { width: 400px; height: 600px; perspective: 1500px; cursor: pointer; z-index: 2; margin: 0 auto; }
        .card-body { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
        .card-body.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; overflow: hidden; display: flex; flex-direction: column; background: #fffdf9; border-radius: 24px; }
        .img-header { height: 50%; width: 100%; position: relative; background: #E2E1E4; overflow: hidden; }
        .cover-img { width: 100%; height: 100%; object-fit: cover; mix-blend-mode: multiply; }
        .text-content { flex: 1; padding: 25px; overflow-y: auto; }
        .main-word { font-size: 2.8rem; margin: 10px 0; font-family: 'Zen Old Mincho', serif; color: var(--color-text-main); line-height: 1.1; }
        .card-face.back { transform: rotateY(180deg); background: rgba(255, 253, 248, 0.95); }
        .back-scroll { padding: 30px; overflow-y: auto; height: 100%; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: var(--color-accent); margin: 20px 0 10px; border-bottom: 1px dashed rgba(203,58,86,0.2); padding-bottom: 5px; }
        .example-box { margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; border-left: 3px solid var(--color-accent); }
        .ex-origin { font-family: 'Noto Serif SC', serif; font-weight: 500; margin-bottom: 4px; }
        .ex-trans { font-size: 0.85rem; opacity: 0.7; }

        /* Timeline */
        .history-stage { flex: 1; margin: 0 20px 20px; padding: 30px; display: flex; flex-direction: column; overflow: hidden; }
        .history-top { border-bottom: 1px solid var(--glass-border); padding-bottom: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .timeline-wrapper { flex: 1; overflow-y: auto; padding-right: 10px; }
        .timeline-list { position: relative; padding-left: 20px; }
        .timeline-spine { position: absolute; left: 100px; top: 0; bottom: 0; width: 2px; background: var(--color-accent); opacity: 0.3; }
        .year-group { display: flex; margin-bottom: 30px; }
        .t-year-label { width: 100px; text-align: right; padding-right: 20px; font-weight: bold; color: var(--color-text-main); font-family: sans-serif; }
        .t-content { flex: 1; background: rgba(255,255,255,0.6); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border); position: relative; }
        .t-dot { position: absolute; left: -26px; top: 18px; width: 14px; height: 14px; border-radius: 50%; background: var(--color-accent); border: 3px solid #fff; }

        /* äº¤äº’å¼æ ‡è®° */
        .interactive-word { border-bottom: 1px dashed var(--color-accent); cursor: pointer; }
        .interactive-word:hover { background: rgba(203, 58, 86, 0.1); }

        /* åŠ¨æ•ˆ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay-gradient"></div>
                <div class="cover-content-layout">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat-large" alt="Cover Cat"></div>
                    <div class="cover-text-group jp-style">
                        <h1 class="cover-title-main">Memori</h1>
                        <p class="subtitle-main">è¨€è‘‰ã®è€ƒå¤å­¦</p>
                        <button class="start-btn-main jp-btn" @click="enterApp">æ¢ç´¢ã‚’å§‹ã‚ã‚‹</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container" :style="{ background: langConfig[currentLang].bg, fontFamily: langConfig[currentLang].font }">
            
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header">
                    <h3>{{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }}</h3>
                    <span class="import-trigger" @click="showImportModal = true"><i class="fa-solid fa-file-import"></i></span>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" 
                         class="word-item" 
                         :class="{ 'active': mode === 'card' && card && item.id === card.id }"
                         @click="loadWord(item)">
                        <span>{{ item.word }}</span>
                        <div class="item-actions"><button class="del-icon" @click.stop="deleteWord(item.id)">Ã—</button></div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="shiba-img" alt="Shiba">
                    </div>
                    <button class="action-btn" @click="mode = 'gallery'">ğŸ“– è—å“é¦†</button>
                    <button class="action-btn" @click="mode = 'history'">ğŸ“œ å†å²å¹´è¡¨</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism artistic-border">
                    <div class="lang-pills">
                        <button v-for="(cfg, key) in langConfig" :key="key" 
                                class="lang-pill" 
                                :class="{ 'active': currentLang === key }" 
                                @click="switchLang(key)">
                            {{ cfg.flag }}
                        </button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="handleSearch" 
                           :placeholder="`åœ¨${langConfig[currentLang].name}ä¸­è€ƒæ® (æ”¯æŒä¸­å¤–äº’æŸ¥)...`" 
                           class="search-input">
                    <button @click="handleSearch" class="search-btn">
                        <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                        <i v-else class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <div class="content-area">
                    <div v-if="mode === 'card' && card" class="card-3d-wrapper" @click="isFlipped = !isFlipped">
                        <div class="card-body" :class="{ 'is-flipped': isFlipped }">
                            <div class="card-face front glass-morphism artistic-border">
                                <div class="img-header">
                                    <img :src="card.imageUrl" class="cover-img" @error="handleImageError">
                                </div>
                                <div class="text-content custom-scroll">
                                    <h1 class="main-word">{{ card.word }}</h1>
                                    <div class="pronunciation">
                                        <span>/ {{ card.reading }} /</span>
                                        <button class="speaker-btn" @click.stop="speak(card.word, card.lang)"><i class="fa-solid fa-volume-high"></i></button>
                                    </div>
                                    <p style="margin-top:20px; opacity:0.8; line-height:1.6;" v-html="formatInteractiveText(card.meaning)"></p>
                                    <div style="margin-top:auto; font-size:0.8rem; color:#888; text-align:center;">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹è€ƒæ® <i class="fa-solid fa-rotate"></i></div>
                                </div>
                            </div>
                            <div class="card-face back glass-morphism artistic-border">
                                <div class="back-scroll custom-scroll">
                                    <div class="section-title">ğŸ—ï¸ è¯æºè€ƒæ® (Etymology)</div>
                                    <p style="text-align:justify; line-height:1.8;" v-html="formatInteractiveText(card.etymology || 'æ­£åœ¨ä»äº‘ç«¯å‘æ˜å†å²åœ°å±‚...')"></p>
                                    
                                    <div class="section-title">ğŸ“œ å…¸ç±ä¾‹å¥ (Sentences)</div>
                                    <div v-if="card.examples && card.examples.length">
                                        <div v-for="(ex, i) in card.examples" :key="i" class="example-box">
                                            <div class="ex-origin" @click.stop="speak(ex.text, card.lang)">
                                                <span v-html="formatInteractiveText(ex.text)"></span> ğŸ”Š
                                            </div>
                                            <div class="ex-trans">{{ ex.cn }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'gallery'" class="gallery-mode custom-scroll" style="width:100%; height:100%;">
                        <h2 style="font-size:2rem; margin-bottom:20px; font-family:'Zen Old Mincho'">é¦™æ°›è—å“é¦†</h2>
                        <div v-if="filteredHistory.length === 0" style="opacity:0.5">æš‚æ— è—å“ï¼Œè¯·å…ˆå»è€ƒæ®è¯æ±‡ã€‚</div>
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;">
                            <div v-for="item in filteredHistory" :key="item.id" class="glass-morphism" style="padding:20px; cursor:pointer;" @click="loadWord(item)">
                                <h3 style="font-size:1.5rem; font-weight:bold;">{{ item.word }}</h3>
                                <p style="opacity:0.6;">{{ item.reading }}</p>
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'history'" class="history-stage glass-morphism artistic-border">
                        <div class="history-top">
                            <h1 style="font-size:1.8rem; font-weight:bold;">å†å²å¤§äº‹å¹´è¡¨</h1>
                            <div class="history-tabs">
                                <button @click="historyTab = 'asia'" :style="{fontWeight: historyTab==='asia'?'bold':'normal'}">ğŸŒ äºšæ´²</button>
                                <button @click="historyTab = 'europe'" :style="{fontWeight: historyTab==='europe'?'bold':'normal'}">ğŸ›ï¸ æ¬§æ´²</button>
                            </div>
                        </div>
                        <div class="timeline-wrapper custom-scroll">
                            <div class="timeline-list">
                                <div class="timeline-spine"></div>
                                <div v-for="group in groupedTimelines" :key="group.year" class="year-group">
                                    <div class="t-year-label">{{ group.year }}</div>
                                    <div class="events-container">
                                        <div v-for="item in group.events" :key="item.id" class="t-content">
                                            <div class="t-dot"></div>
                                            {{ item.event }} <span style="font-size:0.8rem; opacity:0.6;">{{ item.tag }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div v-if="mode !== 'history'" class="cat-mascot-container" @click="pokeMascot">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" accept="image/*" style="display:none">
                <div class="cat-img-wrapper" @dblclick="$refs.mascotInput.click()" title="åŒå‡»æ›´æ¢çŒ«å’ª">
                    <img :src="userCat" class="cat-mascot-img" alt="Cat Mascot">
                </div>
            </div>
        </div>

        <div v-if="showImportModal" class="modal-overlay" @click.self="showImportModal = false">
            <div class="modal-box">
                <h3 style="font-size:1.2rem; font-weight:bold; margin-bottom:15px;">ğŸ“¥ æŒ‚è½½ç¦»çº¿è¾å…¸</h3>
                <p style="font-size:0.9rem; margin-bottom:10px;">è¯·ä¸Šä¼  JSON æ ¼å¼çš„è¾å…¸æ–‡ä»¶</p>
                <input type="file" @change="handleFileSelect" accept=".json">
                <button @click="executeImport" style="width:100%; margin-top:20px; padding:10px; background:var(--color-accent); color:white; border-radius:8px;">ç¡®è®¤æŒ‚è½½</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // IndexedDB æ•°æ®åº“
        class DictionaryDB {
            constructor() { this.dbName = 'MemoriDB_V3_Pure'; this.db = null; }
            async open() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        ['jp', 'cjp', 'zh', 'lzh', 'en', 'de', 'it', 'lat', 'kr'].forEach(lang => {
                            if (!db.objectStoreNames.contains(lang)) db.createObjectStore(lang, { keyPath: 'word' });
                        });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = (e) => reject(e);
                });
            }
            async find(lang, word) {
                if (!this.db) await this.open();
                return new Promise((resolve) => {
                    if (!this.db.objectStoreNames.contains(lang)) return resolve(null);
                    const tx = this.db.transaction(lang, 'readonly');
                    const req = tx.objectStore(lang).get(word);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            }
            async bulkAdd(lang, items) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    if (!this.db.objectStoreNames.contains(lang)) return reject('Invalid Lang');
                    const tx = this.db.transaction(lang, 'readwrite');
                    const store = tx.objectStore(lang);
                    let count = 0;
                    items.forEach(item => {
                        store.put({ 
                            word: item.word || item.wordName, 
                            reading: item.reading || item.pronunciation || '',
                            meaning: item.meaning || item.wordDesc,
                            isLocal: true
                        });
                        count++;
                    });
                    tx.oncomplete = () => resolve(count);
                    tx.onerror = (e) => reject(e);
                });
            }
        }

        createApp({
            setup() {
                const db = new DictionaryDB();
                const showCover = ref(true);
                const currentLang = ref('cjp');
                const wordInput = ref('');
                const loading = ref(false);
                const imageLoading = ref(false);
                const neroState = ref('idle');
                const isFlipped = ref(false);
                const history = ref([]);
                const card = ref(null);
                const mode = ref('gallery');
                const showImportModal = ref(false);
                const importFile = ref(null);
                const historyTab = ref('asia');

                // èµ„æºé…ç½® (ä½¿ç”¨ç½‘ç»œå…œåº•å›¾é˜²æ­¢ç™½å±)
                const defaultBg = 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1600&q=80'; 
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };
                const shibaImages = { idle: './shiba/idle.gif', thinking: './shiba/run.gif', happy: './shiba/happy.gif' };
                const userCat = ref(localStorage.getItem('memori-user-cat') || './my-cat.png');

                // 9ç§è¯­è¨€é…ç½®
                const langConfig = {
                    cjp: { name: 'å¤å…¸æ—¥è¯­', flag: 'ğŸ¯', code: 'ja-JP', bg: 'linear-gradient(to top, #EBE6DF 0%, #F2EFE8 100%)', accent: '#5A3D30', font: "'Zen Old Mincho', serif" },
                    lzh: { name: 'å¤ä»£æ±‰è¯­', flag: 'ğŸ“œ', code: 'zh-CN', bg: 'linear-gradient(to top, #E9EAE4 0%, #F4F5F0 100%)', accent: '#41555D', font: "'Zen Old Mincho', serif" },
                    jp: { name: 'æ—¥è¯­', flag: 'ğŸ‡¯ğŸ‡µ', code: 'ja-JP', bg: 'linear-gradient(to top, #F9F1F0 0%, #FCEFE8 100%)', accent: '#CB3A56', font: "'Zen Old Mincho', serif" },
                    zh: { name: 'ç°ä»£æ±‰è¯­', flag: 'ğŸ‡¨ğŸ‡³', code: 'zh-CN', bg: 'linear-gradient(120deg, #FBF8F1 0%, #F6F4EF 100%)', accent: '#9D2933', font: "'Noto Serif SC', serif" },
                    en: { name: 'è‹±è¯­', flag: 'ğŸ‡¬ğŸ‡§', code: 'en-US', bg: 'linear-gradient(-20deg, #E6E8EB 0%, #EDF1F4 100%)', accent: '#1772B4', font: "'Playfair Display', serif" },
                    de: { name: 'å¾·è¯­', flag: 'ğŸ‡©ğŸ‡ª', code: 'de-DE', bg: 'linear-gradient(to top, #E8ECEB 0%, #EFF2F1 100%)', accent: '#374E59', font: "'Playfair Display', serif" },
                    it: { name: 'æ„è¯­', flag: 'ğŸ‡®ğŸ‡¹', code: 'it-IT', bg: 'linear-gradient(120deg, #F8F4E8 0%, #FAF6EE 100%)', accent: '#8E4932', font: "'Playfair Display', serif" },
                    lat: { name: 'æ‹‰ä¸è¯­', flag: 'ğŸ›ï¸', code: 'it-IT', bg: 'linear-gradient(to top, #EAE8E6 0%, #F0EEEC 100%)', accent: '#605A54', font: "'Cinzel', serif" },
                    kr: { name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·', code: 'ko-KR', bg: 'linear-gradient(to top, #F7EFF2 0%, #F9EDF1 100%)', accent: '#B25D7E', font: "'Noto Serif KR', serif" }
                };

                const filteredHistory = computed(() => history.value.filter(item => item.lang === currentLang.value));

                // å†å²å¹´è¡¨æ•°æ® (å®Œæ•´24æ¡)
                const timelines = ref({
                    asia: [
                        { id: 1, year: 'å‰7000', event: 'æ²³å§†æ¸¡æ–‡åŒ–', tag: 'ğŸ‡¨ğŸ‡³' },
                        { id: 1001, year: 'å‰1600', event: 'å•†æœå»ºç«‹', tag: 'ğŸº' },
                        { id: 1002, year: 'å‰1046', event: 'ç‰§é‡ä¹‹æˆ˜', tag: 'âš”ï¸' },
                        { id: 100, year: 'å‰221', event: 'ç§¦å§‹çš‡ç»Ÿä¸€', tag: 'ğŸ§±' },
                        { id: 1003, year: 'å‰138', event: 'å¼ éªé€šè¥¿åŸŸ', tag: 'ğŸ«' },
                        { id: 1004, year: '57', event: 'æ±‰å§”å¥´å›½ç‹å°', tag: 'ğŸ‡¯ğŸ‡µ' },
                        { id: 1005, year: '645', event: 'å¤§åŒ–æ”¹æ–°', tag: 'ğŸ“œ' },
                        { id: 1006, year: '1405', event: 'éƒ‘å’Œä¸‹è¥¿æ´‹', tag: 'â›µ' },
                        { id: 1007, year: '1443', event: 'è®­æ°‘æ­£éŸ³', tag: 'ğŸ‡°ğŸ‡·' },
                        { id: 1008, year: '1600', event: 'å…³åŸä¹‹æˆ˜', tag: 'ğŸ¯' },
                        { id: 1009, year: '1868', event: 'æ˜æ²»ç»´æ–°', tag: 'âš™ï¸' },
                        { id: 1010, year: '1911', event: 'è¾›äº¥é©å‘½', tag: 'ğŸš©' }
                    ],
                    europe: [
                        { id: 2001, year: 'å‰3000', event: 'å·¨çŸ³é˜µ', tag: 'ğŸª¨' },
                        { id: 201, year: 'å‰753', event: 'ç½—é©¬å»ºåŸ', tag: 'ğŸ›ï¸' },
                        { id: 2002, year: 'å‰490', event: 'é©¬æ‹‰æ¾æˆ˜å½¹', tag: 'ğŸƒ' },
                        { id: 2003, year: 'å‰27', event: 'ç½—é©¬å¸å›½å»ºç«‹', tag: 'ğŸ‘‘' },
                        { id: 2004, year: '476', event: 'è¥¿ç½—é©¬ç­äº¡', tag: 'ğŸ“‰' },
                        { id: 2005, year: '1066', event: 'è¯ºæ›¼å¾æœ', tag: 'ğŸ›¡ï¸' },
                        { id: 2006, year: '1215', event: 'å¤§å®ªç« ', tag: 'ğŸ“œ' },
                        { id: 2007, year: '1453', event: 'å›å£«å¦ä¸å ¡é™·è½', tag: 'â˜ªï¸' },
                        { id: 2008, year: '1517', event: 'å®—æ•™æ”¹é©', tag: 'ğŸ”¨' },
                        { id: 202, year: '1789', event: 'æ³•å›½å¤§é©å‘½', tag: 'ğŸ‡«ğŸ‡·' },
                        { id: 2009, year: '1914', event: 'ä¸€æˆ˜çˆ†å‘', tag: 'ğŸ’£' },
                        { id: 2010, year: '1939', event: 'äºŒæˆ˜çˆ†å‘', tag: 'ğŸ”¥' }
                    ]
                });
                const groupedTimelines = computed(() => { 
                    const list = timelines.value[historyTab.value];
                    return list.map(item => ({ year: item.year, events: [item] })); // ç®€åŒ–åˆ†ç»„é€»è¾‘
                });

                onMounted(async () => {
                    await db.open();
                    const saved = localStorage.getItem('memori-book');
                    if (saved) history.value = JSON.parse(saved);
                    
                    // å›¾ç‰‡é”™è¯¯å…œåº•
                    const img = new Image();
                    img.src = coverImages.bg;
                    img.onerror = () => { coverImages.bg = defaultBg; };
                });

                // æ ¸å¿ƒï¼šåŒè½¨æ£€ç´¢ + ä¸­å¤–äº’æŸ¥
                async function handleSearch() {
                    if (!wordInput.value.trim()) return;
                    loading.value = true;
                    imageLoading.value = true;
                    mode.value = 'card';
                    isFlipped.value = false;
                    
                    const query = wordInput.value.trim();
                    const lang = currentLang.value;

                    // 1. æœ¬åœ°æŸ¥æ‰¾
                    const localHit = await db.find(lang, query);
                    if (localHit) {
                        card.value = { ...localHit, id: Date.now(), lang, isLocal: true, imageUrl: getPlaceholderImg(query) };
                        fetchEnrichment(query, lang); // åå°è¡¥å…¨
                        loading.value = false;
                        saveHistory();
                        return;
                    }

                    // 2. äº‘ç«¯å‘æ˜ (æ”¯æŒäº’æŸ¥)
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word: query, lang: lang, type: 'full' })
                        });
                        const data = await res.json();
                        
                        card.value = {
                            id: Date.now(),
                            ...data, // API è¿”å›çš„æ•°æ®
                            lang: lang,
                            isLocal: false,
                            imageUrl: getPlaceholderImg(data.word) // ä½¿ç”¨è¿”å›çš„ç›®æ ‡è¯ç”Ÿæˆå›¾ç‰‡
                        };
                        saveHistory();
                    } catch (e) {
                        alert('è€ƒå¤æŒ–æ˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Key');
                    } finally {
                        loading.value = false;
                    }
                }

                async function fetchEnrichment(word, lang) {
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word, lang, type: 'enrich' })
                        });
                        const data = await res.json();
                        if (card.value.word === word) {
                            card.value.etymology = data.etymology;
                            card.value.examples = data.examples;
                        }
                    } catch (e) { console.log('è¡¥å…¨å¤±è´¥'); }
                }

                function saveHistory() {
                    const idx = history.value.findIndex(h => h.word === card.value.word && h.lang === card.value.lang);
                    if (idx > -1) history.value.splice(idx, 1);
                    history.value.unshift({ ...card.value });
                    localStorage.setItem('memori-book', JSON.stringify(history.value));
                }

                function getPlaceholderImg(keyword) {
                    return `https://pollinations.ai/p/${encodeURIComponent(keyword + ' ancient artifact museum lighting')}?width=800&height=1000&nologo=true&model=flux`;
                }

                function handleImageError(e) { e.target.src = 'https://via.placeholder.com/400x600?text=No+Image'; }
                function speak(text, lang) { 
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = langConfig[lang]?.code || 'en-US';
                    window.speechSynthesis.speak(u); 
                }
                function handleFileSelect(e) { importFile.value = e.target.files[0]; }
                async function executeImport() {
                    if (!importFile.value) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const count = await db.bulkAdd(currentLang.value, Array.isArray(json) ? json : []);
                            alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡!`);
                            showImportModal.value = false;
                        } catch(err) { alert('JSON æ ¼å¼é”™è¯¯'); }
                    };
                    reader.readAsText(importFile.value);
                }
                function formatInteractiveText(text) { 
                    if(!text) return '';
                    // ç®€å•çš„æ­£åˆ™ï¼Œå°†ä¸­æ—¥éŸ©å­—ç¬¦åŒ…è£¹
                    return text.replace(/([\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]+)/g, '<span class="interactive-word" onclick="document.dispatchEvent(new CustomEvent(\'search-word\', {detail: \'$1\'}))">$1</span>');
                }
                // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
                document.addEventListener('search-word', (e) => {
                    wordInput.value = e.detail;
                    handleSearch();
                });

                // å…¶ä»–è¾…åŠ©å‡½æ•°
                function enterApp() { showCover.value = false; }
                function switchLang(key) { currentLang.value = key; mode.value = 'card'; }
                function loadWord(item) { card.value = item; mode.value = 'card'; isFlipped.value = false; }
                function deleteWord(id) { history.value = history.value.filter(i => i.id !== id); localStorage.setItem('memori-book', JSON.stringify(history.value)); }
                function deleteGalleryItem(id) { deleteWord(id); }
                function clearCurrentHistory() { if(confirm('æ¸…ç©ºå½“å‰è¯­è¨€å†å²ï¼Ÿ')) { history.value = history.value.filter(i => i.lang !== currentLang.value); localStorage.setItem('memori-book', JSON.stringify(history.value)); } }
                function toggleCollect() { card.value.isCollected = !card.value.isCollected; saveHistory(); }
                function toggleImageLock() { card.value.isImageLocked = !card.value.isImageLocked; saveHistory(); }
                function pokeMascot() { neroState.value = 'happy'; setTimeout(()=>neroState.value='idle', 1000); }
                function handleMascotUpload(e) { 
                    const f = e.target.files[0]; 
                    if(f) { const r = new FileReader(); r.onload=ev=>{ userCat.value=ev.target.result; localStorage.setItem('memori-user-cat', ev.target.result); }; r.readAsDataURL(f); }
                }

                return {
                    showCover, enterApp, currentLang, wordInput, loading, imageLoading, neroState, isFlipped, history, card, mode, showImportModal, historyTab,
                    langConfig, coverImages, shibaImages, userCat, filteredHistory, timelines, groupedTimelines,
                    handleSearch, speak, handleImageError, handleFileSelect, executeImport, formatInteractiveText,
                    switchLang, loadWord, deleteWord, deleteGalleryItem, clearCurrentHistory, toggleCollect, toggleImageLock, pokeMascot, handleMascotUpload,
                    getTagStyle: () => ({}) // ç®€åŒ–æ ·å¼
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
