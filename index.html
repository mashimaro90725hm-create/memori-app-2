<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memori - è¨€å¶ã®è€ƒå¤å­¦</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- ğŸ® ä¸­å›½è‰²ä¸»é¢˜å˜é‡ (Zhongguose Palette) --- */
:root {
  /* èŠ¡é£Ÿç™½ QiÃ nsÃ¨ BÃ¡i (èƒŒæ™¯ç±³ç™½) */
  --color-bg-main: #E2E1E4; 
  /* ä¹Œè‰² WÅ«sÃ¨ (æ–‡å­—æ·±è¤) */
  --color-text-main: #2D241E; 
  /* èŒœè‰² QiÃ nsÃ¨ (å¼ºè°ƒæ·±çº¢) */
  --color-accent: #CB3A56; 
  /* å«£çº¢ YÄnhÃ³ng (å¼ºè°ƒè‰²æ‚¬åœ) */
  --color-accent-hover: #EF7A82; 
  /* æš–è°ƒæ¯›ç»ç’ƒèƒŒæ™¯ */
  --glass-bg: rgba(255, 253, 248, 0.75); 
  /* æš–è°ƒæ¯›ç»ç’ƒè¾¹æ¡† */
  --glass-border: rgba(203, 58, 86, 0.15); 
}

/* ğŸ¨ Memori Design System v44.0 (Final Fixes & Layout) */
* { box-sizing: border-box; }
/* ä½¿ç”¨ CSS å˜é‡åº”ç”¨æ–°ä¸»é¢˜è‰² */
.app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.5s ease, font-family 0.3s; position: relative; color: var(--color-text-main); }
.app-container.with-texture::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }
/* æ›´æ–°æ¯›ç»ç’ƒæ ·å¼ä»¥åŒ¹é…æš–è‰²è°ƒ */
.glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(110%); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px -1px rgba(45, 36, 30, 0.08), 0 2px 4px -1px rgba(45, 36, 30, 0.04), inset 0 0 20px rgba(255, 253, 248, 0.3); border-radius: 24px; }
.artistic-border { border-radius: 24px; }

/* ğŸšª å°é¢é¡µä¿®å¤ï¼šå¤„ç†çŒ«å’ªé®æŒ¡æŒ‰é’®é—®é¢˜ */
.cover-stage.classic-theme { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; overflow: hidden; }
.cover-overlay-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(45, 36, 30, 0.6) 0%, rgba(45, 36, 30, 0.2) 60%, transparent 100%); }
.cover-content-layout { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
.cover-text-group.jp-style { flex: 1; color: #f8f4e6; text-shadow: 0 2px 10px rgba(0,0,0,0.6); padding-left: 50px; text-align: right; z-index: 50; }
.cover-title-main { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; margin: 0; letter-spacing: 0.05em; color: #fff; }
.subtitle-main { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; letter-spacing: 0.3em; margin-top: 15px; opacity: 0.95; color: var(--color-bg-main); }
.poem-main { font-family: 'Zen Old Mincho', serif; font-size: 1.3rem; line-height: 2; margin-top: 50px; opacity: 0.9; }
.start-btn-main.jp-btn { margin-top: 60px; font-family: 'Noto Serif JP', serif; padding: 16px 48px; font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent) 0%, #A62C45 100%); color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: all 0.4s; letter-spacing: 0.1em; box-shadow: 0 4px 20px rgba(203, 58, 86, 0.4); pointer-events: auto; position: relative; z-index: 100;}
.start-btn-main.jp-btn:hover { transform: translateY(-3px) scale(1.02); background: linear-gradient(135deg, var(--color-accent-hover) 0%, var(--color-accent) 100%); box-shadow: 0 8px 30px rgba(203, 58, 86, 0.5); }
/* çŒ«å’ªåœ¨å·¦ä¾§ï¼Œç¼©å°å æ¯”ï¼Œç‚¹å‡»ç©¿é€ */
.cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; justify-content: flex-start; align-items: flex-end; z-index: 1; pointer-events: none; }
.cover-cat-large { max-width: 100%; max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(60, 40, 30, 0.6)); transform: translateX(-10%) scaleX(-1); }
.fade-enter-active, .fade-leave-active { transition: opacity 1s ease; }
.fade-enter-from, .fade-leave-to { opacity: 0; }

/* Sidebar */
.sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
.sidebar-header { padding: 0 10px 16px; border-bottom: 1px solid var(--glass-border); }
.sidebar-header h3 { font-size: 1.2rem; font-weight: bold; margin: 0; display: flex; justify-content: space-between; font-family: inherit; }
.count { font-size: 0.8rem; opacity: 0.7; font-family: sans-serif; }
.word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
.custom-scroll::-webkit-scrollbar { width: 6px; }
.custom-scroll::-webkit-scrollbar-track { background: rgba(45, 36, 30, 0.05); border-radius: 3px; }
.custom-scroll::-webkit-scrollbar-thumb { background: rgba(45, 36, 30, 0.2); border-radius: 3px; }
.word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 10px; border-radius: 16px; cursor: pointer; transition: all 0.2s; color: var(--color-text-main); border-left: 4px solid transparent; position: relative; background: rgba(255, 253, 248, 0.5); }
.word-item:hover { background: rgba(255, 253, 248, 0.85); transform: translateX(2px); }
.word-item.active { background: white; box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); font-weight: bold; color: var(--color-text-main); }
.item-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; position: absolute; right: 12px; z-index: 20; background: var(--glass-bg); border-radius: 8px; padding: 3px; box-shadow: 0 2px 8px rgba(45, 36, 30, 0.1); }
.word-item:hover .item-actions { opacity: 1; }
.del-icon { opacity: 0.8; border: none; background: none; color: var(--color-accent); cursor: pointer; font-weight: bold; padding: 4px 8px; font-size: 1.1rem; transition: opacity 0.2s; }
.del-icon:hover { opacity: 1; }
.sidebar-footer { padding-top: 25px; display: flex; flex-direction: column; gap: 12px; position: relative; border-top: 1px solid var(--glass-border); }
.action-btn.artistic-btn { width: 100%; padding: 14px; border: none; border-radius: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: inherit; transition: all 0.2s; letter-spacing: 0.5px; }
.action-btn.primary { color: white; box-shadow: 0 4px 12px rgba(203, 58, 86, 0.25); }
.action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(203, 58, 86, 0.35); background-color: var(--color-accent-hover) !important; }
.action-btn.outline { background: rgba(255, 253, 248, 0.6); color: var(--color-text-main); border: 1px solid var(--glass-border); }
.action-btn.outline:hover { background: white; border-color: var(--color-accent); transform: translateY(-2px); color: var(--color-accent); }

/* Mascots */
.shiba-mascot { position: absolute; bottom: 100%; right: 0px; width: 135px; height: 135px; cursor: pointer; z-index: 20; transition: transform 0.2s; margin-bottom: 15px; }
.shiba-mascot:hover { transform: scale(1.05) rotate(3deg); }
.shiba-img { width: 100%; height: 100%; object-fit: contain; drop-shadow: 0 5px 15px rgba(45, 36, 30, 0.15); }
.shiba-bubble { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: white; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); animation: popIn 0.3s; color: var(--color-text-main); }
.shiba-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: white transparent transparent transparent; }
.cat-mascot-container { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 280px; cursor: pointer; z-index: 100; transition: transform 0.3s ease; }
.cat-mascot-container:hover { transform: scale(1.03); }
.cat-img-wrapper { width: 100%; height: 100%; transform: scaleX(-1); filter: drop-shadow(0 10px 25px rgba(45, 36, 30, 0.3)); }
.cat-mascot-img { width: 100%; height: 100%; object-fit: contain; }
.idle-anim { animation: float 3.5s ease-in-out infinite; }
.thinking-anim { animation: tilt 0.6s ease-in-out infinite alternate; }
.cat-mascot-container.poked .cat-mascot-img { animation: jump 0.5s cubic-bezier(0.28, 0.84, 0.42, 1); }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
@keyframes tilt { 0% { transform: rotate(-6deg); } 100% { transform: rotate(6deg); } }
@keyframes jump { 0% { transform: scale(1,1) translateY(0); } 30% { transform: scale(0.92,1.08) translateY(-50px); } 100% { transform: scale(1,1) translateY(0); } }
.cat-bubble { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 20px; font-size: 1.1rem; font-weight: bold; white-space: nowrap; box-shadow: 0 5px 15px rgba(45, 36, 30, 0.15); animation: popIn 0.3s; color: var(--color-text-main); }
.cat-bubble::after { content: ''; position: absolute; bottom: -8px; left: 50%; margin-left: -8px; border-width: 8px; border-style: solid; border-color: white transparent transparent transparent; }
@keyframes popIn { from { opacity: 0; transform: translateX(-50%) scale(0.5) translateY(20px); } to { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); } }

/* Main Stage & Transitions */
.main-stage { flex: 1; position: relative; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
.search-bar { margin: 0 20px 25px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
.lang-pills { display: flex; gap: 10px; }
.lang-pill { width: 36px; height: 36px; border-radius: 12px; border: 1px solid transparent; background: rgba(255, 253, 248, 0.5); cursor: pointer; font-size: 18px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; color: var(--color-text-main); }
.lang-pill.active { background: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); border-color: var(--glass-border); }
.search-input { border: none; background: transparent; padding: 10px; flex: 1; margin: 0 25px; outline: none; font-size: 1.2rem; font-family: inherit; color: var(--color-text-main); }
.search-input::placeholder { color: rgba(45, 36, 30, 0.5); }
.search-btn { border: none; background: transparent; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s; }
.search-btn:hover { transform: scale(1.1); color: var(--color-accent-hover) !important; }
.fade-mode-enter-active, .fade-mode-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
.fade-mode-enter-from { opacity: 0; transform: translateY(10px); }
.fade-mode-leave-to { opacity: 0; transform: translateY(-10px); }

/* Gallery Mode */
.gallery-mode { display: flex; flex-direction: column; overflow-y: auto; padding: 25px 50px; }
.gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
.gallery-title { font-size: 1.8rem; font-weight: bold; margin: 0; }
.clear-history-icon { border: none; background: none; color: #aaa; cursor: pointer; font-size: 1.2rem; transition: color 0.3s; padding: 5px; }
.clear-history-icon:hover { color: var(--color-accent); }
.gallery-list { display: flex; flex-direction: column; gap: 16px; padding-bottom: 50px; }
.gallery-row-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; border-radius: 16px; cursor: pointer; transition: all 0.3s; background: rgba(255, 253, 248, 0.6); border: 1px solid var(--glass-border); position: relative; overflow: hidden; }
.gallery-row-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: rgba(203, 58, 86, 0.2); transition: width 0.3s; }
.gallery-row-item:hover { transform: translateX(5px); background: rgba(255, 253, 248, 0.9); box-shadow: 0 5px 15px rgba(45, 36, 30, 0.06); }
.gallery-row-item:hover::before { width: 10px; background: var(--color-accent); }
.row-left { display: flex; flex-direction: column; }
.row-word { font-size: 1.4rem; font-weight: bold; color: var(--color-text-main); font-family: 'Zen Old Mincho', serif; }
.row-reading { font-size: 0.9rem; color: rgba(45, 36, 30, 0.7); margin-top: 4px; font-family: sans-serif; }
.row-right { font-size: 1.2rem; color: #ccc; transition: transform 0.3s; display: flex; align-items: center; gap: 15px; }
.gallery-row-item:hover .row-right { transform: translateX(5px); color: var(--color-text-main); }
.row-del-btn { opacity: 0; border: none; background: none; color: var(--color-accent); cursor: pointer; transition: opacity 0.3s; font-size: 1rem; }
.gallery-row-item:hover .row-del-btn { opacity: 1; }
.empty-state { text-align: center; color: rgba(45, 36, 30, 0.5); font-size: 1.2rem; margin-top: 50px; }
.flower-field-container { margin-bottom: 30px; background: rgba(255, 253, 248, 0.4); padding: 20px; border-radius: 20px; border: 1px solid var(--glass-border); }
.field-label { font-size: 0.9rem; color: rgba(45, 36, 30, 0.7); margin-bottom: 15px; letter-spacing: 1px; }
.flower-grid { display: flex; gap: 15px; flex-wrap: wrap; }
.flower-item { width: 60px; height: 60px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); transition: transform 0.3s; border: 1px solid var(--glass-border); }
.flower-item:hover { transform: scale(1.1); }
.flower-img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }

/* Orchard */
.review-with-tree { display: flex; gap: 30px; justify-content: center; padding: 0 40px; }
.review-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.orchard-sidebar { width: 280px; padding: 25px; display: flex; flex-direction: column; align-items: center; border-radius: 24px; background: var(--glass-bg); height: 640px; justify-content: space-between; }
.orchard-sidebar h3 { font-size: 1.2rem; color: var(--color-text-main); margin-bottom: 10px; }
.tree-display { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; }
.tree-img { width: 100%; max-height: 300px; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(45, 36, 30, 0.2)); transition: all 0.5s; }
.tree-stats { text-align: center; background: rgba(255, 253, 248, 0.7); padding: 15px; border-radius: 12px; width: 100%; border: 1px solid var(--glass-border); }
.tree-status { font-weight: bold; color: #2E7D32; margin-top: 5px; }

/* Card 3D */
.card-3d-wrapper { width: 400px; height: 600px; perspective: 1500px; cursor: pointer; z-index: 2; }
.card-body { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
.card-body.is-flipped { transform: rotateY(180deg); }
.card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; overflow: hidden; display: flex; flex-direction: column; background: #F3F2F0; border-radius: 24px; }
.img-header { height: 55%; width: 100%; position: relative; background: #E2E1E4; border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
.img-header.loading { animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { background-color: #E2E1E4; } 50% { background-color: #D6D5D8; } 100% { background-color: #E2E1E4; } }
.cover-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; mix-blend-mode: multiply; }
.img-loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(45, 36, 30, 0.4); font-size: 2.5rem; }
.overlay-actions { position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; gap: 10px; }
.icon-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 253, 248, 0.85); border: 1px solid var(--glass-border); cursor: pointer; backdrop-filter: blur(6px); transition: transform 0.2s, background 0.2s; color: var(--color-text-main); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(45, 36, 30, 0.1); }
.icon-btn:hover { transform: scale(1.08); background: white; color: var(--color-accent); }
.star-btn i.starred { color: var(--color-accent); text-shadow: 0 0 5px rgba(203, 58, 86, 0.3); }
.text-content { flex: 1; padding: 20px 30px; display: flex; flex-direction: column; align-items: center; justify-content: space-around; background: rgba(255, 253, 248, 0.5); overflow-y: auto; }
.word-group { position: relative; display: inline-block; margin-bottom: 8px; }
.main-word { font-size: 3.2rem; margin: 10px 0; line-height: 1.2; text-align: center; position: relative; z-index: 2; letter-spacing: -0.03em; color: var(--color-text-main); font-family: 'Zen Old Mincho', serif; }
.pronunciation { display: flex; align-items: center; gap: 12px; color: rgba(45, 36, 30, 0.7); font-size: 1.15rem; margin-bottom: 15px; }
.simple-en { font-style: italic; color: rgba(45, 36, 30, 0.6); font-size: 0.95rem; margin-top: 12px; font-family: serif; text-align: center; }
.flip-hint { margin-top: auto; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.2px; color: rgba(45, 36, 30, 0.5); display: flex; align-items: center; gap: 6px; font-weight: 500; }
.speaker-btn { width: 34px; height: 34px; border-radius: 50%; background: rgba(45, 36, 30, 0.08); border: none; cursor: pointer; color: var(--color-text-main); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.speaker-btn:hover { background: var(--color-accent); color: white; }
.meta-info { margin-top: 18px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
.meta-tag { font-size: 0.85rem; background: rgba(45, 36, 30, 0.06); padding: 5px 12px; border-radius: 10px; color: rgba(45, 36, 30, 0.8); font-weight: 500; }
.card-face.back { transform: rotateY(180deg); background: rgba(255, 253, 248, 0.9); }
.back-header { padding: 22px 30px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 253, 248, 0.6); }
.back-header h3 { margin: 0; font-size: 1.6rem; color: var(--color-text-main); font-family: 'Zen Old Mincho', serif; }
.back-actions { display: flex; gap: 12px; }
.back-scroll { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 25px; }
.info-block .label { display: block; font-size: 0.8rem; text-transform: uppercase; color: rgba(45, 36, 30, 0.6); letter-spacing: 1.2px; margin-bottom: 8px; font-weight: 600; }
.info-block p { font-size: 1.1rem; line-height: 1.7; color: var(--color-text-main); margin: 0; text-align: justify; font-family: sans-serif; }
.example-row { margin-bottom: 15px; border-left: 3px solid rgba(203, 58, 86, 0.3); padding-left: 12px; }
.ex-text { font-size: 1.05rem; color: var(--color-text-main); font-style: italic; margin-bottom: 5px; cursor: pointer; transition: color 0.2s; font-family: serif; }
.ex-text:hover { color: var(--color-accent); }
.ex-cn { font-size: 0.9rem; color: rgba(45, 36, 30, 0.7); }
.html-content { font-size: 1.05rem; line-height: 1.7; color: var(--color-text-main); text-align: left; }
.html-content img { max-width: 100%; border-radius: 10px; margin: 12px 0; box-shadow: 0 4px 10px rgba(45, 36, 30, 0.08); }
.html-content b { font-weight: 700; color: var(--color-accent); }

/* Review Card */
.review-card { width: 400px; height: 600px; background: rgba(255, 253, 248, 0.95) !important; box-shadow: 0 10px 40px rgba(45, 36, 30, 0.15); border: 1px solid var(--glass-border); display: flex; flex-direction: column; overflow: hidden; border-radius: 24px; }
.review-upper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; position: relative; z-index: 2; }
.review-img-holder { width: 140px; height: 140px; border-radius: 50%; overflow: hidden; margin-bottom: 25px; border: 5px solid #F3F2F0; box-shadow: 0 10px 25px rgba(45, 36, 30, 0.15); background: #E2E1E4; }
.review-lower { background: rgba(255, 253, 248, 0.6); border-top: 1px solid var(--glass-border); height: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; position: relative; z-index: 2; }
.reveal-btn { background: var(--color-text-main); color: #F3F2F0; border: none; padding: 14px 36px; border-radius: 28px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; font-size: 1.1rem; }
.reveal-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(45, 36, 30, 0.2); background: var(--color-accent); }
.r-answer { width: 100%; text-align: center; animation: fadeIn 0.4s ease; }
.r-reading { font-size: 1.3rem; color: rgba(45, 36, 30, 0.8); margin-bottom: 8px; }
.srs-actions { display: flex; gap: 12px; width: 100%; }
.srs-btn { flex: 1; padding: 14px 0; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; color: white; font-size: 1.1rem; transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
.srs-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(45, 36, 30, 0.15); }
.again { background: #CB3A56; } /* èŒœè‰² */
.hard { background: #F28E16; } /* ç¼ƒè‰² */
.good { background: #8FAB1D; } /* æŸ³é»„ */
.easy { background: #2C9678; } /* ç«¹é’ */
.exit-btn { margin-top: 25px; border: none; background: none; color: rgba(45, 36, 30, 0.6); text-decoration: underline; cursor: pointer; font-size: 1rem; }

/* Timeline List */
.history-stage { flex: 1; margin: 0 20px 20px; padding: 35px; display: flex; flex-direction: column; overflow: hidden; }
.history-top { flex-shrink: 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 25px; margin-bottom: 25px; }
.history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.history-header h1 { font-size: 2rem; margin: 0; font-family: 'Zen Old Mincho', serif; }
.close-mode-btn { background: none; border: none; font-size: 1.6rem; color: #aaa; cursor: pointer; transition: color 0.2s; }
.close-mode-btn:hover { color: var(--color-accent); }
.history-tabs { display: flex; gap: 25px; margin-bottom: 25px; align-items: center; }
.history-tabs button { background: none; border: none; font-size: 1.15rem; cursor: pointer; opacity: 0.6; padding-bottom: 6px; border-bottom: 3px solid transparent; font-family: inherit; transition: all 0.3s; font-weight: 500; color: var(--color-text-main); }
.history-tabs button.active { opacity: 1; border-bottom-color: currentColor; font-weight: bold; }
.timeline-input-group { background: rgba(255, 253, 248, 0.6); padding: 18px; border-radius: 18px; transition: all 0.3s; border: 1px solid var(--glass-border); }
.timeline-input-group.editing { background: #FFF3E0; border: 1px solid #FFB74D; }
.input-header { font-size: 0.85rem; font-weight: bold; margin-bottom: 12px; color: rgba(45, 36, 30, 0.7); text-transform: uppercase; letter-spacing: 1.2px; display: flex; justify-content: space-between; align-items: center; }
.cancel-edit-btn { border: none; background: none; color: var(--color-accent); cursor: pointer; font-size: 0.85rem; text-decoration: underline; }
.input-row { display: flex; gap: 12px; }
.t-input { border: 1px solid var(--glass-border); padding: 10px 14px; border-radius: 10px; background: rgba(255, 253, 248, 0.8); outline: none; font-family: inherit; font-size: 1rem; transition: border-color 0.2s; color: var(--color-text-main); }
.t-input:focus { border-color: var(--color-accent); }
.t-input.year { width: 110px; }
.t-input.tag { width: 70px; text-align: center; }
.t-input.event { flex: 1; }
.t-btn { border: none; color: white; padding: 0 24px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: transform 0.2s, box-shadow 0.2s; }
.t-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(203, 58, 86, 0.3); background-color: var(--color-accent-hover) !important; }
.tags-input { width: 100%; margin-top: 10px; }
.timeline-wrapper { flex: 1; overflow-y: auto; padding-right: 20px; scroll-padding-top: 20px; }
.timeline-list { position: relative; padding-left: 15px; padding-top: 10px; }
.timeline-spine { position: absolute; left: 95px; top: 0; bottom: 0; width: 3px; background: currentColor; z-index: 0; border-radius: 1.5px; opacity: 0.4; }
.year-group { display: flex; align-items: flex-start; margin-bottom: 40px; position: relative; }
.t-year-label { width: 95px; text-align: right; padding-right: 30px; flex-shrink: 0; position: sticky; top: 0; align-self: flex-start; padding-top: 8px; }
.year-number { font-weight: 800; font-size: 1.2rem; color: var(--color-text-main); background: rgba(255, 253, 248, 0.95); padding: 4px 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(45, 36, 30, 0.06); font-family: sans-serif; border: 1px solid var(--glass-border); }
.events-container { flex: 1; display: flex; flex-direction: column; gap: 18px; }
.t-item-box { display: flex; align-items: center; position: relative; transition: all 0.3s; cursor: grab; }
.t-item-box:active { cursor: grabbing; }
.t-item-box.starred .t-content { border-left: 5px solid #FFD700; background: #FFFDE7; }
.t-dot { width: 16px; height: 16px; border-radius: 50%; position: absolute; left: -26px; top: 22px; border: 4px solid #F3F2F0; box-shadow: 0 2px 6px rgba(45, 36, 30, 0.15); z-index: 2; }
.t-content { flex: 1; background: rgba(255, 253, 248, 0.9); padding: 15px 22px; transition: transform 0.2s, box-shadow 0.2s; position: relative; border: 1px solid var(--glass-border); }
.t-content:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(45, 36, 30, 0.08); }
.t-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.t-icon { font-size: 1.4rem; }
.t-tags { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }
.custom-tag { font-size: 0.75rem; padding: 3px 10px; border-radius: 8px; font-weight: 600; letter-spacing: 0.5px; }
.t-text { flex: 1; font-size: 1.1rem; color: var(--color-text-main); line-height: 1.6; font-weight: 500; font-family: 'Noto Serif SC', sans-serif; }
.t-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; background: var(--glass-bg); padding: 4px; border-radius: 8px; position: absolute; right: 12px; top: 12px; box-shadow: 0 2px 8px rgba(45, 36, 30, 0.1); border: 1px solid var(--glass-border); }
.t-content:hover .t-actions { opacity: 1; }
.t-act-btn { border: none; background: none; cursor: pointer; color: rgba(45, 36, 30, 0.4); padding: 5px 7px; font-size: 1rem; transition: color 0.2s; }
.t-act-btn:hover { color: var(--color-text-main); transform: scale(1.1); }
.t-act-btn.del:hover { color: var(--color-accent); }
.t-act-btn.star:hover, .t-act-btn.star.active { color: #FFD700; }
.drag-handle { color: rgba(45, 36, 30, 0.3); cursor: grab; padding: 0 6px; font-size: 1.3rem; }

@media (max-width: 768px) {
  .app-container { flex-direction: column-reverse; height: auto; overflow-y: auto; }
  .sidebar { width: auto; height: auto; border-right: none; border-top: 1px solid var(--glass-border); margin: 0; padding: 25px; border-radius: 24px 24px 0 0; }
  .main-stage { height: 100vh; padding: 15px; }
  .card-3d-wrapper { width: 100%; height: 70vh; max-height: 600px; }
  .cat-mascot-container { bottom: 25px; right: 25px; width: 180px; height: 180px; }
  .cover-content-layout { flex-direction: column-reverse; justify-content: center; height: auto; padding: 40px 20px; gap: 30px; }
  .cover-text-group.jp-style { padding-left: 0; text-align: center; margin-bottom: 20px; }
  .cover-title-main { font-size: 3.5rem; }
  .cover-cat-wrapper { justify-content: center; align-items: center; height: auto; flex: 1; }
  .cover-cat-large { max-height: 45vh; transform: scaleX(-1); }
  .search-bar { margin: 0 0 20px; }
  .history-stage { margin: 0 0 20px; padding: 25px; }
  .gallery-mode { padding: 20px; }
  .review-with-tree { flex-direction: column; gap: 15px; }
  .orchard-sidebar { width: 100%; height: auto; flex-direction: row; }
  .tree-img { height: 80px; }
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay-gradient"></div>
                <div class="cover-content-layout">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat-large" alt="Cover Cat"></div>
                    <div class="cover-text-group jp-style">
                        <h1 class="cover-title-main">Memori</h1>
                        <p class="subtitle-main">è¨€è‘‰ã®è€ƒå¤å­¦</p>
                        <div class="poem-main"><p>æ™‚ã®ç ‚ã«åŸ‹ã‚‚ã‚ŒãŸã€</p><p>è¨€è‘‰ã®æ¬ ç‰‡ã‚’æ¢ã—ã¦ã€‚</p></div>
                        <button class="start-btn-main jp-btn" @click="enterApp">æ¢ç´¢ã‚’å§‹ã‚ã‚‹</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container with-texture" :style="{ background: langConfig[currentLang].bg, fontFamily: langConfig[currentLang].font }">
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header">
                    <h3 :style="{ color: langConfig[currentLang].accent }">
                        {{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }} 
                        <span class="count">{{ filteredHistory.length }} è¯</span>
                    </h3>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" 
                         class="word-item" 
                         :class="{ 'active': mode === 'card' && item.id === card.id }"
                         :style="(mode === 'card' && item.id === card.id) ? { borderLeftColor: langConfig[currentLang].accent } : {}"
                         @click="loadWord(item)">
                        <span class="word-text">{{ item.word }}</span>
                        <div class="item-actions"><button class="del-icon" @click.stop="deleteWord(item.id)">Ã—</button></div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="shiba-img" alt="Shiba">
                        <div v-if="neroState === 'thinking'" class="shiba-bubble">å—…å—…...</div>
                        <div v-if="neroState === 'happy'" class="shiba-bubble">é¦™ï¼</div>
                    </div>
                    <button class="action-btn primary artistic-btn" @click="startReview" :style="{ backgroundColor: langConfig[currentLang].accent }"><i class="fa-solid fa-layer-group"></i> å¤ä¹ </button>
                    <button class="action-btn outline artistic-btn" @click="mode = 'gallery'"><i class="fa-solid fa-images"></i> è—å“é¦†</button>
                    <button class="action-btn outline artistic-btn" @click="mode = 'history'"><i class="fa-solid fa-scroll"></i> å†å²å¹´è¡¨</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism artistic-border">
                    <div class="lang-pills">
                        <button v-for="(cfg, key) in langConfig" :key="key" @click="switchLang(key)" class="lang-pill" :class="{ 'active': currentLang === key }" :title="cfg.scent">{{ cfg.flag }}</button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="generateCard" :placeholder="\`å¯»æ‰¾\${langConfig[currentLang].name}çš„å‘³é“...\`" class="search-input">
                    <button @click="generateCard" class="search-btn" :disabled="loading" :style="{ color: langConfig[currentLang].accent }"><i v-if="loading" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <Transition name="fade-mode" mode="out-in">
                    <div v-if="mode === 'gallery'" class="content-area gallery-mode custom-scroll" key="gallery">
                        <div class="flower-field-container" v-if="flowerField.length > 0">
                            <div class="field-label">å·²æ”¶è— {{ filteredHistory.length }} è¯ Â· èŠ±ç”°ç››å¼€ä¸­</div>
                            <div class="flower-grid"><div v-for="flower in flowerField" :key="flower.id" class="flower-item" title="æ¯50è¯ç»½æ”¾ä¸€æœµ"><img :src="flower.img" class="flower-img" @error="handleImageError"></div></div>
                        </div>
                        <div class="gallery-header">
                            <h2 class="gallery-title" :style="{ color: langConfig[currentLang].accent }"><i class="fa-solid fa-bottle-droplet"></i> é¦™æ°›è—å“é¦†</h2>
                            <button v-if="filteredHistory.length > 0" @click="clearCurrentHistory" class="clear-history-icon" title="æ•£å»æ—§é¦™"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div v-if="filteredHistory.length === 0" class="empty-state"><p>ç©ºæ°”ä¸­è¿˜æœªç•™ä¸‹è¯è¯­çš„é¦™æ°”...</p></div>
                        <div class="gallery-list">
                            <div v-for="item in filteredHistory" :key="item.id" class="gallery-row-item glass-morphism" @click="loadWord(item)">
                                <div class="row-left"><span class="row-word">{{ item.word }}</span><span class="row-reading">{{ item.reading }}</span></div>
                                <div class="row-right">
                                    <button class="row-del-btn" @click.stop="deleteGalleryItem(item.id)" title="ç§»é™¤æ­¤è¯"><i class="fa-solid fa-trash"></i></button>
                                    <span class="row-arrow" :style="{color: langConfig[currentLang].accent}"><i class="fa-solid fa-feather"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'card'" class="content-area" key="card">
                        <div class="card-3d-wrapper" @click="isFlipped = !isFlipped">
                            <div class="card-body" :class="{ 'is-flipped': isFlipped }">
                                <div class="card-face front glass-morphism artistic-border">
                                    <div class="img-header" :class="{ 'loading': imageLoading }">
                                        <img :src="card.imageUrl" class="cover-img" @error="handleImageError" @load="imageLoading = false">
                                        <div v-if="imageLoading" class="img-loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                                        <div class="overlay-actions">
                                            <button class="icon-btn star-btn" @click.stop="toggleCollect" :title="card.isCollected ? 'å–æ¶ˆæ”¶è—' : 'åŠ å…¥å•è¯æœ¬'"><i class="fa-solid fa-star" :class="{ 'starred': card.isCollected }"></i></button>
                                            <button class="icon-btn" @click.stop="toggleImageLock"><i class="fa-solid" :class="card.isImageLocked ? 'fa-lock' : 'fa-lock-open'"></i></button>
                                        </div>
                                    </div>
                                    <div class="text-content custom-scroll">
                                        <div class="word-display"><p v-if="card.lang === 'zh' && card.pinyin" class="pinyin">{{ card.pinyin }}</p><div class="word-group"><h2 class="main-word">{{ card.word }}</h2></div><div class="pronunciation"><span>{{ card.reading }}</span><button class="speaker-btn" @click.stop="speak(card.word, card.lang)"><i class="fa-solid fa-volume-high"></i></button></div></div>
                                        <div class="meta-info"><span v-if="card.word_details" class="meta-tag">{{ card.word_details }}</span></div><p v-if="card.simple_english" class="simple-en">{{ card.simple_english }}</p><div class="flip-hint">é—»é¦™è¯†ä¹‰ <i class="fa-solid fa-arrow-right-long"></i></div>
                                    </div>
                                </div>
                                <div class="card-face back glass-morphism artistic-border">
                                    <div class="back-header" @click.stop><h3>{{ card.word }}</h3><div class="back-actions"><button class="icon-btn sm" @click.stop="speak(card.word, card.lang)"><i class="fa-solid fa-volume-high"></i></button><button class="icon-btn sm" @click.stop="isFlipped = !isFlipped"><i class="fa-solid fa-rotate-left"></i></button></div></div>
                                    <div class="back-scroll custom-scroll" @click.stop><div class="info-block meaning"><span class="label">é‡Šä¹‰</span><div class="html-content" v-html="card.meaning"></div></div><div v-if="card.etymology" class="info-block etymology"><span class="label">å‰è°ƒ (è¯æº)</span><p>{{ card.etymology }}</p></div><div v-if="card.examples && card.examples.length" class="info-block examples"><span class="label">ä¸­è°ƒ (ä¾‹å¥)</span><div v-for="(ex, i) in card.examples" :key="i" class="example-row"><p class="ex-text" @click="speak(ex.text, card.lang)">{{ ex.text }}</p><p class="ex-cn">{{ ex.cn }}</p></div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'history'" class="history-stage glass-morphism artistic-border" key="history">
                        <div class="history-top"><div class="history-header"><h1 :style="{ color: langConfig[currentLang].accent }">å†å²å¤§äº‹å¹´è¡¨</h1><button class="close-mode-btn" @click="mode = 'card'"><i class="fa-solid fa-xmark"></i></button></div><div class="history-tabs"><button :class="{ active: historyTab === 'asia' }" @click="historyTab = 'asia'">ğŸŒ äºšæ´²å²</button><button :class="{ active: historyTab === 'europe' }" @click="historyTab = 'europe'">ğŸ›ï¸ æ¬§æ´²å²</button></div><div class="timeline-input-group" :class="{ 'editing': isEditingTimeline }"><div class="input-header">{{ isEditingTimeline ? 'âœï¸ ç¼–è¾‘æ¡ç›®' : 'âœï¸ æ·»åŠ æ–°å†å²' }}<button v-if="isEditingTimeline" class="cancel-edit-btn" @click="cancelEdit">å–æ¶ˆ</button></div><div class="input-row"><input v-model="newEvent.year" placeholder="å¹´ä»½" class="t-input year"><input v-model="newEvent.tag" placeholder="å›¾æ ‡" class="t-input tag" @blur="autoMapIcon"><input v-model="newEvent.event" placeholder="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ" class="t-input event"><button @click="addTimelineEvent" class="t-btn" :style="{background: langConfig[currentLang].accent}">{{ isEditingTimeline ? 'ä¿å­˜' : 'æ·»åŠ ' }}</button></div><input v-model="newEvent.tagsInput" placeholder="æ ‡ç­¾ (å¯é€‰ï¼Œç©ºæ ¼åˆ†éš”)" class="t-input tags-input" style="width:100%; margin-top:8px;"></div></div>
                        <div class="timeline-wrapper custom-scroll"><div class="timeline-list"><div class="timeline-spine" :style="{ background: langConfig[currentLang].accent, opacity: 0.4 }"></div><div v-for="group in groupedTimelines" :key="group.year" class="year-group"><div class="t-year-label"><span class="year-number" :style="{ color: langConfig[currentLang].accent }">{{ group.year }}</span></div><div class="events-container"><div v-for="item in group.events" :key="item.id" class="t-item-box" :class="{ 'starred': item.isStarred }" draggable="true" @dragstart="onDragStart($event, item)" @drop="onDrop($event, item)" @dragover.prevent><div class="t-dot" :style="{background: langConfig[currentLang].accent}"></div><div class="t-content artistic-border"><div class="t-header"><span class="t-icon">{{ item.tag }}</span><div v-if="item.tags" class="t-tags"><span v-for="t in item.tags" :key="t" class="custom-tag" :style="getTagStyle(t)">{{ t }}</span></div><div class="t-actions"><span class="drag-handle">â‹®â‹®</span><button class="t-act-btn star" @click="toggleStar(item)" :class="{ active: item.isStarred }">â˜…</button><button class="t-edit" @click="editTimelineEvent(item)"><i class="fa-solid fa-pen"></i></button><button class="t-del" @click="deleteTimelineEvent(item.id)">Ã—</button></div></div><span class="t-text">{{ item.event }}</span></div></div></div></div></div></div>
                    </div>

                    <div v-else-if="mode === 'review' && reviewCard" class="content-area review-with-tree" key="review">
                        <div class="review-center">
                            <div class="review-card glass-morphism artistic-border">
                                <div class="review-upper"><div class="review-img-holder"><img :src="reviewCard.imageUrl" class="r-img" @error="handleImageError"></div><h2 class="r-word">{{ reviewCard.word }}</h2><button class="r-speak" @click="speak(reviewCard.word, reviewCard.lang)"><i class="fa-solid fa-volume-high"></i></button></div>
                                <div class="review-lower"><div v-if="!showReviewAnswer" class="r-mask"><button class="reveal-btn artistic-btn" @click="showReviewAnswer = true">æ­å¼€è°œåº•</button></div><div v-else class="r-answer"><p class="r-reading">{{ reviewCard.reading }}</p><div class="html-content" v-html="reviewCard.meaning"></div><div class="srs-actions"><button class="srs-btn again artistic-btn" @click="handleSRS(1)">å¿˜</button><button class="srs-btn hard artistic-btn" @click="handleSRS(2)">éš¾</button><button class="srs-btn good artistic-btn" @click="handleSRS(3)">ä¼š</button><button class="srs-btn easy artistic-btn" @click="handleSRS(4)">ç†Ÿ</button></div></div></div></div>
                        </div>
                        <div class="orchard-sidebar glass-morphism">
                            <h3>è®°å¿†ä¹‹æ ‘</h3>
                            <div class="tree-display">
                                <img :src="treeStage.img" class="tree-img" alt="Memory Tree" @error="handleTreeError">
                            </div>
                            <div class="tree-stats"><p>å·²å¤ä¹ : <strong>{{ currentReviewCount }}</strong></p><p class="tree-status">çŠ¶æ€: {{ treeStage.stage === 'fruit' ? 'ğŸ’ æœå®ç´¯ç´¯' : (treeStage.stage === 'tree' ? 'ğŸŒ³ æç¹å¶èŒ‚' : (treeStage.stage === 'sapling' ? 'ğŸŒ¿ èŒå£®æˆé•¿' : 'ğŸŒ± æ­£åœ¨èŒèŠ½')) }}</p></div>
                            <button class="exit-btn" @click="mode = 'card'">æš‚åœè€•è€˜</button>
                        </div>
                    </div>
                </Transition>
            </main>

            <div v-if="mode !== 'history'" class="cat-mascot-container" @click="pokeMascot" :class="{ 'poked': neroState === 'happy' }" title="åŒå‡»ä¸Šä¼ çŒ«å’ª" @dblclick="triggerMascotInput">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" accept="image/*" style="display:none">
                <div class="cat-img-wrapper"><img :src="userCat" class="cat-mascot-img" :class="neroState === 'thinking' ? 'thinking-anim' : 'idle-anim'" alt="Cat Mascot"></div>
                <div v-if="neroState === 'thinking'" class="cat-bubble">æŒ–æ˜ä¸­...</div>
                <div v-if="neroState === 'happy'" class="cat-bubble">å–µ~âœ¨</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const showCover = ref(true);
                function enterApp() { showCover.value = false; }

                const currentLang = ref('jp');
                const wordInput = ref('');
                const loading = ref(false);
                const imageLoading = ref(false);
                const neroState = ref('idle'); 
                const isFlipped = ref(false);
                const history = ref([]); 
                const showConjugation = ref(false);
                const mascotInput = ref(null);

                const reviewCounts = ref(JSON.parse(localStorage.getItem('memori-review-counts') || '{}'));

                const shibaImages = { idle: './shiba/idle.gif', thinking: './shiba/run.gif', happy: './shiba/happy.gif' };
                const defaultCat = './my-cat.png'; 
                const userCat = ref(localStorage.getItem('memori-user-cat') || defaultCat);
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };

                const mode = ref('gallery'); 
                const reviewQueue = ref([]);
                const reviewCard = ref(null);
                const showReviewAnswer = ref(false);

                const historyTab = ref('asia');
                const isEditingTimeline = ref(false);
                const editingEventId = ref(null);
                const newEvent = ref({ year: '', event: '', tag: 'ğŸº', tagsInput: '' });

                const iconMap = { 'ä¸­å›½': 'ğŸ‡¨ğŸ‡³', 'CN': 'ğŸ‡¨ğŸ‡³', 'ä¸­': 'ğŸ‡¨ğŸ‡³', 'æ—¥æœ¬': 'ğŸ‡¯ğŸ‡µ', 'JP': 'ğŸ‡¯ğŸ‡µ', 'æ—¥': 'ğŸ‡¯ğŸ‡µ', 'éŸ©å›½': 'ğŸ‡°ğŸ‡·', 'KR': 'ğŸ‡°ğŸ‡·', 'è‹±å›½': 'ğŸ‡¬ğŸ‡§', 'æ³•å›½': 'ğŸ‡«ğŸ‡·', 'å¾·å›½': 'ğŸ‡©ğŸ‡ª', 'æ„å¤§åˆ©': 'ğŸ‡®ğŸ‡¹', 'ç¾å›½': 'ğŸ‡ºğŸ‡¸', 'ä¿„å›½': 'ğŸ‡·ğŸ‡º', 'åŸƒåŠ': 'ğŸ‡ªğŸ‡¬', 'ç½—é©¬': 'ğŸ›ï¸', 'ç§¦': 'ğŸ§±', 'æ±‰': 'ğŸ‘˜', 'å”': 'ğŸ¯', 'å®‹': 'ğŸ“œ', 'æ˜': 'ğŸ®', 'æ¸…': 'ğŸ‰', 'è‰ºæœ¯': 'ğŸ¨', 'è€ƒå¤': 'ğŸº' };
                function autoMapIcon() { const val = newEvent.value.tag.trim(); if (iconMap[val]) newEvent.value.tag = iconMap[val]; }

                function getTagStyle(str) { let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); const hue = Math.abs(hash % 360); return { backgroundColor: `hsl(${hue}, 15%, 90%)`, color: `hsl(${hue}, 40%, 35%)`, border: `1px solid hsl(${hue}, 20%, 80%)` }; }

                const timelines = ref({
                    asia: [ { id: 1, year: 'å‰7000', event: 'æ²³å§†æ¸¡æ–‡åŒ–', tag: 'ğŸ‡¨ğŸ‡³', tags: ['è€ƒå¤'] }, { id: 100, year: 'å‰221', event: 'ç§¦å§‹çš‡ç»Ÿä¸€', tag: 'ğŸ‡¨ğŸ‡³', tags: ['ç»Ÿä¸€'] } ],
                    europe: [ { id: 201, year: 'å‰753', event: 'ç½—é©¬å»ºåŸ', tag: 'ğŸ›ï¸', tags: ['ä¼ è¯´'] }, { id: 202, year: '1789', event: 'æ³•å›½å¤§é©å‘½', tag: 'ğŸ‡«ğŸ‡·', tags: ['é©å‘½'] } ]
                });

                const unifiedFont = "'Zen Old Mincho', 'Noto Serif SC', 'Noto Serif JP', 'Noto Serif KR', serif";

                const langConfig = {
                    jp: { name: 'æ—¥è¯­', scent: 'æ¨±ä¸å’Œçº¸', plant: 'cherry blossom', scentColor: '244, 165, 179', flag: 'ğŸ‡¯ğŸ‡µ', voice: 'ja-JP', bg: 'linear-gradient(to top, #F9F1F0 0%, #FCEFE8 100%)', accent: '#CB3A56', text: '#4B2F32', font: unifiedFont },
                    zh: { name: 'ç°ä»£æ±‰è¯­', scent: 'æœ±ç ‚ä¸èŒ¶', plant: 'peony flower', scentColor: '157, 41, 51', flag: 'ğŸ‡¨ğŸ‡³', voice: 'zh-CN', bg: 'linear-gradient(120deg, #FBF8F1 0%, #F6F4EF 100%)', accent: '#9D2933', text: '#2E211B', font: unifiedFont },
                    lzh: { name: 'å¤ä»£æ±‰è¯­', scent: 'æª€é¦™', plant: 'lotus flower', scentColor: '76, 92, 106', flag: 'ğŸ“œ', voice: 'zh-CN', bg: 'linear-gradient(to top, #E9EAE4 0%, #F4F5F0 100%)', accent: '#41555D', text: '#1B2124', font: unifiedFont },
                    en: { name: 'è‹±è¯­', scent: 'ç¾Šçš®å·', plant: 'english rose', scentColor: '23, 114, 180', flag: 'ğŸ‡¬ğŸ‡§', voice: 'en-US', bg: 'linear-gradient(-20deg, #E6E8EB 0%, #EDF1F4 100%)', accent: '#1772B4', text: '#151D29', font: "'Playfair Display', serif" },
                    cjp: { name: 'å¤å…¸æ—¥è¯­', scent: 'æ¯å¢¨', plant: 'bonsai pine', scentColor: '109, 88, 67', flag: 'ğŸ¯', voice: 'ja-JP', bg: 'linear-gradient(to top, #EBE6DF 0%, #F2EFE8 100%)', accent: '#5A3D30', text: '#2B201A', font: unifiedFont },
                    kr: { name: 'éŸ©è¯­', scent: 'æœ¨æ§¿', plant: 'hibiscus flower', scentColor: '219, 102, 142', flag: 'ğŸ‡°ğŸ‡·', voice: 'ko-KR', bg: 'linear-gradient(to top, #F7EFF2 0%, #F9EDF1 100%)', accent: '#B25D7E', text: '#402E34', font: unifiedFont },
                    de: { name: 'å¾·è¯­', scent: 'é»‘æ£®æ—', plant: 'oak tree', scentColor: '81, 106, 120', flag: 'ğŸ‡©ğŸ‡ª', voice: 'de-DE', bg: 'linear-gradient(to top, #E8ECEB 0%, #EFF2F1 100%)', accent: '#374E59', text: '#1A2326', font: "'Playfair Display', serif" },
                    it: { name: 'æ„è¯­', scent: 'æ‰˜æ–¯å¡çº³', plant: 'lemon tree', scentColor: '201, 127, 85', flag: 'ğŸ‡®ğŸ‡¹', voice: 'it-IT', bg: 'linear-gradient(120deg, #F8F4E8 0%, #FAF6EE 100%)', accent: '#8E4932', text: '#36221B', font: "'Playfair Display', serif" },
                    lat: { name: 'æ‹‰ä¸', scent: 'ä¹³é¦™', plant: 'olive tree', scentColor: '143, 137, 133', flag: 'ğŸ›ï¸', voice: 'it-IT', bg: 'linear-gradient(to top, #EAE8E6 0%, #F0EEEC 100%)', accent: '#605A54', text: '#262422', font: "'Cinzel', serif" }
                };

                const card = ref({ id: Date.now(), word: 'Memori', reading: 'me-mo-ri', meaning: 'æ¬¢è¿æ¥åˆ°è¯­è¨€è€ƒå¤å‘æ˜ç°åœº', imageUrl: 'https://picsum.photos/seed/memori/800/1000', isImageLocked: false, examples: [], lang: 'jp', nextReview: 0, interval: 0, isCollected: false });

                const filteredHistory = computed(() => history.value.filter(item => (item.lang || 'jp') === currentLang.value));
                const currentReviewCount = computed(() => reviewCounts.value[currentLang.value] || 0);

                const flowerField = computed(() => {
                    const count = filteredHistory.value.length;
                    const flowerCount = Math.floor(count / 50);
                    const flowers = [];
                    const plantName = langConfig[currentLang.value].plant;
                    for(let i=0; i<flowerCount; i++) {
                        const seed = `flower_${currentLang.value}_${i}`;
                        const url = `https://pollinations.ai/p/vintage%20botanical%20illustration%20of%20${encodeURIComponent(plantName)}%20flower%20on%20old%20paper?width=200&height=200&nologo=true&seed=${seed}`;
                        flowers.push({ id: i, img: url });
                    }
                    return flowers;
                });

                const treeStage = computed(() => {
                    const c = currentReviewCount.value;
                    const plantName = langConfig[currentLang.value].plant;
                    let prompt = '';
                    let status = '';
                    let seedSuffix = 100; 
                    
                    if (c < 50) { prompt = `tiny_green_sprout_in_dark_soil_macro`; status = 'seedling'; seedSuffix = 101; } 
                    else if (c < 100) { prompt = `young_${plantName.replace(/\s/g, '_')}_tree_sapling_vintage`; status = 'sapling'; seedSuffix = 102; } 
                    else if (c < 150) { prompt = `big_mature_${plantName.replace(/\s/g, '_')}_tree_on_white`; status = 'tree'; seedSuffix = 103; } 
                    else { prompt = `mystical_${plantName.replace(/\s/g, '_')}_tree_with_golden_fruits_art`; status = 'fruit'; seedSuffix = 104; }
                    
                    return { stage: status, img: `https://pollinations.ai/p/${prompt}?width=400&height=600&nologo=true&model=flux&seed=${seedSuffix}` };
                });

                function parseYear(yearStr) { if (!yearStr) return 0; const isBC = yearStr.includes('å‰') || yearStr.includes('BC') || yearStr.includes('-'); const numMatch = yearStr.match(/\d+/); const num = numMatch ? parseInt(numMatch[0]) : 0; return isBC ? -num : num; }
                const groupedTimelines = computed(() => { const rawList = timelines.value[historyTab.value]; const groups = {}; rawList.forEach(item => { if (!groups[item.year]) { groups[item.year] = { year: item.year, rawYear: parseYear(item.year), events: [] }; } groups[item.year].events.push(item); }); return Object.values(groups).sort((a, b) => a.rawYear - b.rawYear); });

                onMounted(() => {
                    const savedBook = localStorage.getItem('memori-book'); if (savedBook) { history.value = JSON.parse(savedBook); if(history.value.length > 0) mode.value = 'gallery'; }
                    const savedTimeline = localStorage.getItem('memori-timelines-v19'); if (savedTimeline) timelines.value = JSON.parse(savedTimeline);
                    window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
                    switchLang('jp');
                });
                watch(timelines, (newVal) => { localStorage.setItem('memori-timelines-v19', JSON.stringify(newVal)); }, { deep: true });
                watch(reviewCounts, (newVal) => { localStorage.setItem('memori-review-counts', JSON.stringify(newVal)); }, { deep: true });

                function handleImageError(e) { const currentSrc = e.target.src; if (currentSrc.includes('pollinations.ai')) { e.target.src = `https://picsum.photos/seed/${encodeURIComponent(card.value.word)}/800/1000`; } else { e.target.src = 'https://via.placeholder.com/400x600?text=No+Image'; } }
                function handleTreeError(e) { e.target.src = 'https://via.placeholder.com/400x600?text=Tree+Growing'; }
                function speak(text, langCode = null) { if (!text) return; const langKey = langCode || currentLang.value; if (langKey === 'zh' || langKey === 'lzh') return; window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); const config = langConfig[langKey]; const targetBCP47 = config ? config.voice : 'en-US'; utterance.lang = targetBCP47; const voices = window.speechSynthesis.getVoices(); const exactVoice = voices.find(v => v.lang === targetBCP47) || voices.find(v => v.lang === targetBCP47.replace('-', '_')) || voices.find(v => v.lang.startsWith(targetBCP47.split('-')[0])); if (exactVoice) { utterance.voice = exactVoice; utterance.lang = exactVoice.lang; } else { utterance.lang = targetBCP47; } utterance.rate = 0.9; window.speechSynthesis.speak(utterance); }

                function toggleCollect() {
                    if (card.value.isCollected) {
                        if(!confirm('ğŸ’” ç¡®å®šè¦å°†æ­¤è¯ç§»å‡ºå•è¯æœ¬å—ï¼Ÿ')) return;
                        history.value = history.value.filter(h => !(h.word === card.value.word && h.lang === card.value.lang));
                        card.value.isCollected = false;
                    } else {
                        const exists = history.value.some(h => h.word === card.value.word && h.lang === card.value.lang);
                        if (!exists) {
                            const cardToSave = { ...card.value, isCollected: true, nextReview: Date.now(), interval: 0 };
                            history.value.unshift(cardToSave);
                            card.value.isCollected = true;
                            if (filteredHistory.value.length % 50 === 0) { alert(`ğŸŒ¸ æ­å–œï¼ä½ åœ¨ã€${langConfig[currentLang.value].name}ã€‘çš„èŠ±ç”°é‡Œç§ä¸‹äº†ä¸€æ ªæ–°æ¤ç‰©ï¼`); }
                        }
                    }
                    localStorage.setItem('memori-book', JSON.stringify(history.value));
                }

                // --- å‘æ˜æ ¸å¿ƒï¼šå¯¹æ¥äº‘ç«¯ API ---
                async function generateCard() {
                    if (!wordInput.value) return;
                    loading.value = true; imageLoading.value = true; neroState.value = 'thinking'; isFlipped.value = false; showConjugation.value = false; mode.value = 'card';
                    try {
                        const existing = history.value.find(h => h.word === wordInput.value && h.lang === currentLang.value);
                        if (existing) {
                            card.value = { ...existing };
                            setTimeout(() => speak(existing.word, existing.lang), 500);
                        } else {
                            // è°ƒç”¨æ–°éƒ¨ç½²çš„æ¥å£
                            const res = await fetch('/api/openai', { 
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ word: wordInput.value, lang: currentLang.value }) 
                            });
                            if (!res.ok) throw new Error('API Error');
                            const data = await res.json();
                            const prompt = `ancient museum artifact ${data.simple_english || data.word}, cinematic lighting, highly detailed, textured background, historical`; 
                            const finalImageUrl = `https://pollinations.ai/p/${encodeURIComponent(prompt)}?width=800&height=1000&nologo=true&model=flux`; 
                            card.value = { id: Date.now(), ...data, lang: currentLang.value, imageUrl: finalImageUrl, isImageLocked: false, nextReview: 0, interval: 0, isCollected: false };
                            setTimeout(() => speak(card.value.word, card.value.lang), 500);
                        }
                        neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 3000); wordInput.value = ''; 
                    } catch (e) { alert('æŒ–æ˜å¤±è´¥: ' + e.message); neroState.value = 'idle'; } finally { loading.value = false; }
                }

                function saveToBook(newCard) { 
                    const idx = history.value.findIndex(h => h.word === newCard.word && h.lang === newCard.lang);
                    if (idx !== -1) { history.value[idx] = newCard; localStorage.setItem('memori-book', JSON.stringify(history.value)); }
                }

                function startReview() { 
                    const now = Date.now(); 
                    const dueWords = filteredHistory.value.filter(w => w.nextReview <= now); 
                    if (dueWords.length === 0) { alert(`ğŸ‰ å¤ªæ£’äº†ï¼ã€${langConfig[currentLang.value].name}ã€‘æš‚æ— å¤ä¹ ä»»åŠ¡ã€‚`); return; } 
                    reviewQueue.value = dueWords.sort((a, b) => a.nextReview - b.nextReview); mode.value = 'review'; nextReviewCard(); 
                }
                function nextReviewCard() { if (reviewQueue.value.length === 0) { alert("ğŸ‰ æœ¬è½®å¤ä¹ å®Œæˆï¼"); mode.value = 'card'; neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 3000); return; } reviewCard.value = reviewQueue.value.shift(); showReviewAnswer.value = false; }
                function handleSRS(rating) { 
                    const c = reviewCard.value; 
                    let interval = c.interval || 0; 
                    if (rating === 1) interval = 1; else { if (interval === 0) interval = 1; else if (interval === 1) interval = 3; else interval = Math.ceil(interval * (rating === 2 ? 1.2 : (rating === 3 ? 2.5 : 4.0))); } 
                    c.interval = interval; c.nextReview = Date.now() + (interval * 24 * 60 * 60 * 1000); 
                    saveToBook(c); 
                    if (!reviewCounts.value[currentLang.value]) reviewCounts.value[currentLang.value] = 0; reviewCounts.value[currentLang.value]++; 
                    nextReviewCard(); 
                }
                const loadWord = (item) => { card.value = item; if (item.lang && item.lang !== currentLang.value) switchLang(item.lang); isFlipped.value = false; if (mode.value !== 'card') mode.value = 'card'; };
                function deleteGalleryItem(id) { if(!confirm('ç¡®å®šè¦ä»è—å“é¦†ç§»é™¤è¿™ä¸ªè¯å—ï¼Ÿ')) return; history.value = history.value.filter(item => item.id !== id); localStorage.setItem('memori-book', JSON.stringify(history.value)); }
                const deleteWord = (id) => deleteGalleryItem(id);
                const toggleImageLock = () => { card.value.isImageLocked = !card.value.isImageLocked; const found = history.value.find(h => h.id === card.value.id); if (found) { found.isImageLocked = card.value.isImageLocked; found.imageUrl = card.value.imageUrl; localStorage.setItem('memori-book', JSON.stringify(history.value)); } };
                function pokeMascot() { if (neroState.value === 'idle') { neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 1500); } }
                function triggerMascotInput() { mascotInput.value.click(); }
                function handleMascotUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { userCat.value = e.target.result; localStorage.setItem('memori-user-cat', e.target.result); alert('ğŸ± æ–°çŒ«å’ªå·²ä¸Šä»»ï¼'); }; reader.readAsDataURL(file); }

                function editTimelineEvent(item) { newEvent.value = { ...item, tagsInput: item.tags ? item.tags.join(' ') : '' }; isEditingTimeline.value = true; editingEventId.value = item.id; document.querySelector('.history-stage')?.scrollTo({ top: 0, behavior: 'smooth' }); }
                function cancelEdit() { isEditingTimeline.value = false; editingEventId.value = null; newEvent.value = { year: '', event: '', tag: 'ğŸº', tagsInput: '' }; }
                function addTimelineEvent() { if (!newEvent.value.year || !newEvent.value.event) return; const tagList = newEvent.value.tagsInput ? newEvent.value.tagsInput.split(/[ ,ï¼Œã€]+/).filter(t => t.trim() !== '') : []; const finalEvent = { year: newEvent.value.year, event: newEvent.value.event, tag: newEvent.value.tag, tags: tagList, isStarred: newEvent.value.isStarred || false }; if (isEditingTimeline.value) { const list = timelines.value[historyTab.value]; const index = list.findIndex(e => e.id === editingEventId.value); if (index !== -1) list[index] = { ...finalEvent, id: editingEventId.value }; isEditingTimeline.value = false; editingEventId.value = null; } else { timelines.value[historyTab.value].push({ id: Date.now(), ...finalEvent }); } newEvent.value = { year: '', event: '', tag: 'ğŸº', tagsInput: '' }; neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 1500); }
                function deleteTimelineEvent(id) { if (!confirm('åˆ é™¤æ­¤æ¡ç›®ï¼Ÿ')) return; timelines.value[historyTab.value] = timelines.value[historyTab.value].filter(e => e.id !== id); }
                function toggleStar(item) { item.isStarred = !item.isStarred; }
                const switchLang = (lang) => { currentLang.value = lang; mode.value = 'card'; };
                function onDragStart(event, item) { event.dataTransfer.effectAllowed = 'move'; event.dataTransfer.setData('text/plain', item.id); }
                function onDrop(event, targetItem) { const draggedId = event.dataTransfer.getData('text/plain'); if (!draggedId || parseInt(draggedId) === targetItem.id) return; const list = timelines.value[historyTab.value]; const fromIndex = list.findIndex(e => e.id == draggedId); const toIndex = list.findIndex(e => e.id === targetItem.id); if (fromIndex !== -1 && toIndex !== -1) { const itemToMove = list.splice(fromIndex, 1)[0]; list.splice(toIndex, 0, itemToMove); } }
                function clearCurrentHistory() { if (!confirm(`âš ï¸ ç¡®å®šè¦æ¸…ç©ºã€${langConfig[currentLang.value].name}ã€‘çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) return; history.value = history.value.filter(item => (item.lang || 'jp') !== currentLang.value); reviewCounts.value[currentLang.value] = 0; localStorage.setItem('memori-book', JSON.stringify(history.value)); }

                return {
                    showCover, enterApp, currentLang, wordInput, loading, imageLoading, neroState, isFlipped, history, showConjugation, mascotInput, reviewCounts, shibaImages, defaultCat, userCat, coverImages, mode, reviewQueue, reviewCard, showReviewAnswer, historyTab, isEditingTimeline, editingEventId, newEvent, iconMap, autoMapIcon, getTagStyle, timelines, unifiedFont, langConfig, card, filteredHistory, currentReviewCount, flowerField, treeStage, parseYear, groupedTimelines, handleImageError, handleTreeError, speak, toggleCollect, generateCard, saveToBook, startReview, nextReviewCard, handleSRS, loadWord, deleteGalleryItem, deleteWord, toggleImageLock, pokeMascot, triggerMascotInput, handleMascotUpload, editTimelineEvent, cancelEdit, addTimelineEvent, deleteTimelineEvent, toggleStar, switchLang, onDragStart, onDrop, clearCurrentHistory
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
