<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memori - Ë®ÄÂè∂„ÅÆËÄÉÂè§Â≠¶</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- üèÆ ‰∏≠ÂõΩËâ≤‰∏ªÈ¢òÂèòÈáè (Zhongguose Palette) --- */
:root {
  --color-bg-main: #E2E1E4;
  --color-text-main: #2D241E;
  --color-accent: #CB3A56;
  --color-accent-hover: #EF7A82;
  --glass-bg: rgba(255, 253, 248, 0.75);
  --glass-border: rgba(203, 58, 86, 0.15);
}

/* üé® Memori Design System v44.0 (Â§çÂàª‰øùÁïôÁâà) */
* { box-sizing: border-box; }
.app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.5s ease, font-family 0.3s; position: relative; color: var(--color-text-main); }
.app-container.with-texture::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }
.glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(110%); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px -1px rgba(45, 36, 30, 0.08), 0 2px 4px -1px rgba(45, 36, 30, 0.04), inset 0 0 20px rgba(255, 253, 248, 0.3); border-radius: 24px; }
.artistic-border { border-radius: 24px; }

/* üö™ Â∞ÅÈù¢È°µ (‰øùÁïô) */
.cover-stage.classic-theme { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; overflow: hidden; }
.cover-overlay-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(45, 36, 30, 0.6) 0%, rgba(45, 36, 30, 0.2) 60%, transparent 100%); }
.cover-content-layout { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
.cover-text-group.jp-style { flex: 1; color: #f8f4e6; text-shadow: 0 2px 10px rgba(0,0,0,0.6); padding-left: 50px; text-align: right; z-index: 50; }
.cover-title-main { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; margin: 0; letter-spacing: 0.05em; color: #fff; }
.subtitle-main { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; letter-spacing: 0.3em; margin-top: 15px; opacity: 0.95; color: var(--color-bg-main); }
.start-btn-main.jp-btn { margin-top: 60px; font-family: 'Noto Serif JP', serif; padding: 16px 48px; font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent) 0%, #A62C45 100%); color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: all 0.4s; letter-spacing: 0.1em; box-shadow: 0 4px 20px rgba(203, 58, 86, 0.4); pointer-events: auto; position: relative; z-index: 100; }
.start-btn-main.jp-btn:hover { transform: translateY(-3px) scale(1.02); background: linear-gradient(135deg, var(--color-accent-hover) 0%, var(--color-accent) 100%); box-shadow: 0 8px 30px rgba(203, 58, 86, 0.5); }
.cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; justify-content: flex-start; align-items: flex-end; z-index: 1; pointer-events: none; }
.cover-cat-large { max-width: 100%; max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(60, 40, 30, 0.6)); transform: translateX(-10%) scaleX(-1); }
.fade-enter-active, .fade-leave-active { transition: opacity 1s ease; }
.fade-enter-from, .fade-leave-to { opacity: 0; }

/* Sidebar */
.sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
.sidebar-header { padding: 0 10px 16px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
.sidebar-header h3 { font-size: 1.2rem; font-weight: bold; margin: 0; display: flex; justify-content: space-between; font-family: inherit; width: 100%; }
.import-trigger { font-size: 0.8rem; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
.import-trigger:hover { opacity: 1; color: var(--color-accent); }
.word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
.word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 10px; border-radius: 16px; cursor: pointer; transition: all 0.2s; color: var(--color-text-main); border-left: 4px solid transparent; position: relative; background: rgba(255, 253, 248, 0.5); }
.word-item:hover { background: rgba(255, 253, 248, 0.85); transform: translateX(2px); }
.word-item.active { background: white; box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); font-weight: bold; color: var(--color-text-main); }
.item-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; position: absolute; right: 12px; z-index: 20; background: var(--glass-bg); border-radius: 8px; padding: 3px; box-shadow: 0 2px 8px rgba(45, 36, 30, 0.1); }
.word-item:hover .item-actions { opacity: 1; }
.del-icon { opacity: 0.8; border: none; background: none; color: var(--color-accent); cursor: pointer; font-weight: bold; padding: 4px 8px; font-size: 1.1rem; transition: opacity 0.2s; }
.del-icon:hover { opacity: 1; }
.sidebar-footer { padding-top: 25px; display: flex; flex-direction: column; gap: 12px; position: relative; border-top: 1px solid var(--glass-border); }
.action-btn.artistic-btn { width: 100%; padding: 14px; border: none; border-radius: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: inherit; transition: all 0.2s; letter-spacing: 0.5px; }
.action-btn.primary { color: white; box-shadow: 0 4px 12px rgba(203, 58, 86, 0.25); }
.action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(203, 58, 86, 0.35); background-color: var(--color-accent-hover) !important; }
.action-btn.outline { background: rgba(255, 253, 248, 0.6); color: var(--color-text-main); border: 1px solid var(--glass-border); }
.action-btn.outline:hover { background: white; border-color: var(--color-accent); transform: translateY(-2px); color: var(--color-accent); }

/* Mascots (‰øùÁïô) */
.shiba-mascot { position: absolute; bottom: 100%; right: 0px; width: 135px; height: 135px; cursor: pointer; z-index: 20; transition: transform 0.2s; margin-bottom: 15px; }
.shiba-mascot:hover { transform: scale(1.05) rotate(3deg); }
.shiba-img { width: 100%; height: 100%; object-fit: contain; drop-shadow: 0 5px 15px rgba(45, 36, 30, 0.15); }
.shiba-bubble { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: white; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); animation: popIn 0.3s; color: var(--color-text-main); }
.shiba-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: white transparent transparent transparent; }
.cat-mascot-container { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 280px; cursor: pointer; z-index: 100; transition: transform 0.3s ease; }
.cat-mascot-container:hover { transform: scale(1.03); }
.cat-img-wrapper { width: 100%; height: 100%; transform: scaleX(-1); filter: drop-shadow(0 10px 25px rgba(45, 36, 30, 0.3)); }
.cat-mascot-img { width: 100%; height: 100%; object-fit: contain; }
.idle-anim { animation: float 3.5s ease-in-out infinite; }
.thinking-anim { animation: tilt 0.6s ease-in-out infinite alternate; }
.cat-mascot-container.poked .cat-mascot-img { animation: jump 0.5s cubic-bezier(0.28, 0.84, 0.42, 1); }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
@keyframes tilt { 0% { transform: rotate(-6deg); } 100% { transform: rotate(6deg); } }
@keyframes jump { 0% { transform: scale(1,1) translateY(0); } 30% { transform: scale(0.92,1.08) translateY(-50px); } 100% { transform: scale(1,1) translateY(0); } }
.cat-bubble { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 20px; font-size: 1.1rem; font-weight: bold; white-space: nowrap; box-shadow: 0 5px 15px rgba(45, 36, 30, 0.15); animation: popIn 0.3s; color: var(--color-text-main); }
.cat-bubble::after { content: ''; position: absolute; bottom: -8px; left: 50%; margin-left: -8px; border-width: 8px; border-style: solid; border-color: white transparent transparent transparent; }
@keyframes popIn { from { opacity: 0; transform: translateX(-50%) scale(0.5) translateY(20px); } to { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); } }

/* Main Stage */
.main-stage { flex: 1; position: relative; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
.search-bar { margin: 0 20px 25px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
.lang-pills { display: flex; gap: 10px; }
.lang-pill { width: 36px; height: 36px; border-radius: 12px; border: 1px solid transparent; background: rgba(255, 253, 248, 0.5); cursor: pointer; font-size: 18px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; color: var(--color-text-main); }
.lang-pill.active { background: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); border-color: var(--glass-border); }
.search-input { border: none; background: transparent; padding: 10px; flex: 1; margin: 0 25px; outline: none; font-size: 1.2rem; font-family: inherit; color: var(--color-text-main); }
.search-btn { border: none; background: transparent; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s; }
.search-btn:hover { transform: scale(1.1); color: var(--color-accent-hover) !important; }
.fade-mode-enter-active, .fade-mode-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
.fade-mode-enter-from { opacity: 0; transform: translateY(10px); }
.fade-mode-leave-to { opacity: 0; transform: translateY(-10px); }

/* Gallery Mode (‰øùÁïô) */
.gallery-mode { display: flex; flex-direction: column; overflow-y: auto; padding: 25px 50px; }
.gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
.gallery-title { font-size: 1.8rem; font-weight: bold; margin: 0; }
.clear-history-icon { border: none; background: none; color: #aaa; cursor: pointer; font-size: 1.2rem; transition: color 0.3s; padding: 5px; }
.clear-history-icon:hover { color: var(--color-accent); }
.gallery-list { display: flex; flex-direction: column; gap: 16px; padding-bottom: 50px; }
.gallery-row-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; border-radius: 16px; cursor: pointer; transition: all 0.3s; background: rgba(255, 253, 248, 0.6); border: 1px solid var(--glass-border); position: relative; overflow: hidden; }
.gallery-row-item:hover { transform: translateX(5px); background: rgba(255, 253, 248, 0.9); box-shadow: 0 5px 15px rgba(45, 36, 30, 0.06); }
.row-left { display: flex; flex-direction: column; }
.row-word { font-size: 1.4rem; font-weight: bold; color: var(--color-text-main); font-family: 'Zen Old Mincho', serif; }
.row-reading { font-size: 0.9rem; color: rgba(45, 36, 30, 0.7); margin-top: 4px; font-family: sans-serif; }
.row-right { font-size: 1.2rem; color: #ccc; transition: transform 0.3s; display: flex; align-items: center; gap: 15px; }
.gallery-row-item:hover .row-right { transform: translateX(5px); color: var(--color-text-main); }
.row-del-btn { opacity: 0; border: none; background: none; color: var(--color-accent); cursor: pointer; transition: opacity 0.3s; font-size: 1rem; }
.gallery-row-item:hover .row-del-btn { opacity: 1; }
.empty-state { text-align: center; color: rgba(45, 36, 30, 0.5); font-size: 1.2rem; margin-top: 50px; }

/* Card 3D (Â¢ûÂº∫ÁâàÔºöÊîØÊåÅËØçÊ∫êÂíå‰æãÂè•) */
.card-3d-wrapper { width: 400px; height: 600px; perspective: 1500px; cursor: pointer; z-index: 2; margin: 0 auto; }
.card-body { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
.card-body.is-flipped { transform: rotateY(180deg); }
.card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; overflow: hidden; display: flex; flex-direction: column; background: #F3F2F0; border-radius: 24px; }
.img-header { height: 55%; width: 100%; position: relative; background: #E2E1E4; border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
.img-header.loading { animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { background-color: #E2E1E4; } 50% { background-color: #D6D5D8; } 100% { background-color: #E2E1E4; } }
.cover-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; mix-blend-mode: multiply; }
.img-loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(45, 36, 30, 0.4); font-size: 2.5rem; }
.overlay-actions { position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; gap: 10px; }
.icon-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 253, 248, 0.85); border: 1px solid var(--glass-border); cursor: pointer; backdrop-filter: blur(6px); transition: transform 0.2s, background 0.2s; color: var(--color-text-main); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(45, 36, 30, 0.1); }
.icon-btn:hover { transform: scale(1.08); background: white; color: var(--color-accent); }
.star-btn i.starred { color: var(--color-accent); text-shadow: 0 0 5px rgba(203, 58, 86, 0.3); }
.text-content { flex: 1; padding: 20px 30px; display: flex; flex-direction: column; align-items: center; justify-content: space-around; background: rgba(255, 253, 248, 0.5); overflow-y: auto; }
.main-word { font-size: 3.2rem; margin: 10px 0; line-height: 1.2; text-align: center; position: relative; z-index: 2; letter-spacing: -0.03em; color: var(--color-text-main); font-family: 'Zen Old Mincho', serif; }
.pronunciation { display: flex; align-items: center; gap: 12px; color: rgba(45, 36, 30, 0.7); font-size: 1.15rem; margin-bottom: 15px; }
.speaker-btn { width: 34px; height: 34px; border-radius: 50%; background: rgba(45, 36, 30, 0.08); border: none; cursor: pointer; color: var(--color-text-main); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.speaker-btn:hover { background: var(--color-accent); color: white; }
.meta-info { margin-top: 18px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
.meta-tag { font-size: 0.85rem; background: rgba(45, 36, 30, 0.06); padding: 5px 12px; border-radius: 10px; color: rgba(45, 36, 30, 0.8); font-weight: 500; }
.card-face.back { transform: rotateY(180deg); background: rgba(255, 253, 248, 0.9); }
.back-header { padding: 22px 30px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 253, 248, 0.6); }
.back-header h3 { margin: 0; font-size: 1.6rem; color: var(--color-text-main); font-family: 'Zen Old Mincho', serif; }
.back-actions { display: flex; gap: 12px; }
.back-scroll { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 25px; }
.info-block .label { display: block; font-size: 0.8rem; text-transform: uppercase; color: rgba(45, 36, 30, 0.6); letter-spacing: 1.2px; margin-bottom: 8px; font-weight: 600; }
.info-block p { font-size: 1.1rem; line-height: 1.7; color: var(--color-text-main); margin: 0; text-align: justify; font-family: sans-serif; }
.example-row { margin-bottom: 15px; border-left: 3px solid rgba(203, 58, 86, 0.3); padding-left: 12px; }
.ex-text { font-size: 1.05rem; color: var(--color-text-main); font-style: italic; margin-bottom: 5px; cursor: pointer; transition: color 0.2s; font-family: serif; }
.ex-text:hover { color: var(--color-accent); }
.ex-cn { font-size: 0.9rem; color: rgba(45, 36, 30, 0.7); }
.html-content { font-size: 1.05rem; line-height: 1.7; color: var(--color-text-main); text-align: left; }
.local-indicator { font-size: 0.8rem; color: #8d6e63; margin-top: 5px; opacity: 0.7; }

/* Timeline (‰øùÁïô) */
.history-stage { flex: 1; margin: 0 20px 20px; padding: 35px; display: flex; flex-direction: column; overflow: hidden; }
.history-top { flex-shrink: 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 25px; margin-bottom: 25px; }
.history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.history-header h1 { font-size: 2rem; margin: 0; font-family: 'Zen Old Mincho', serif; }
.history-tabs { display: flex; gap: 25px; margin-bottom: 25px; align-items: center; }
.history-tabs button { background: none; border: none; font-size: 1.15rem; cursor: pointer; opacity: 0.6; padding-bottom: 6px; border-bottom: 3px solid transparent; font-family: inherit; transition: all 0.3s; font-weight: 500; color: var(--color-text-main); }
.history-tabs button.active { opacity: 1; border-bottom-color: currentColor; font-weight: bold; }
.timeline-wrapper { flex: 1; overflow-y: auto; padding-right: 20px; scroll-padding-top: 20px; }
.timeline-list { position: relative; padding-left: 15px; padding-top: 10px; }
.timeline-spine { position: absolute; left: 95px; top: 0; bottom: 0; width: 3px; background: currentColor; z-index: 0; border-radius: 1.5px; opacity: 0.4; }
.year-group { display: flex; align-items: flex-start; margin-bottom: 40px; position: relative; }
.t-year-label { width: 95px; text-align: right; padding-right: 30px; flex-shrink: 0; position: sticky; top: 0; align-self: flex-start; padding-top: 8px; }
.year-number { font-weight: 800; font-size: 1.2rem; color: var(--color-text-main); background: rgba(255, 253, 248, 0.95); padding: 4px 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(45, 36, 30, 0.06); font-family: sans-serif; border: 1px solid var(--glass-border); }
.events-container { flex: 1; display: flex; flex-direction: column; gap: 18px; }
.t-item-box { display: flex; align-items: center; position: relative; transition: all 0.3s; cursor: grab; }
.t-dot { width: 16px; height: 16px; border-radius: 50%; position: absolute; left: -26px; top: 22px; border: 4px solid #F3F2F0; box-shadow: 0 2px 6px rgba(45, 36, 30, 0.15); z-index: 2; }
.t-content { flex: 1; background: rgba(255, 253, 248, 0.9); padding: 15px 22px; transition: transform 0.2s, box-shadow 0.2s; position: relative; border: 1px solid var(--glass-border); }
.t-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.t-icon { font-size: 1.4rem; }
.t-text { flex: 1; font-size: 1.1rem; color: var(--color-text-main); line-height: 1.6; font-weight: 500; font-family: 'Noto Serif SC', sans-serif; }

/* Ê®°ÊÄÅÊ°Ü (Êñ∞Â¢û) */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.modal-box { background: white; width: 450px; padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
.modal-header { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; color: var(--color-text-main); border-bottom: 1px solid #eee; padding-bottom: 10px; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
.file-drop { border: 2px dashed #ddd; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; transition: all 0.3s; color: #888; background: #fafafa; }
.file-drop:hover { border-color: var(--color-accent); color: var(--color-accent); background: rgba(203,58,86,0.02); }
.import-confirm-btn { width: 100%; background: var(--color-accent); color: white; py-3; padding: 12px; border-radius: 12px; font-weight: bold; margin-top: 10px; transition: background 0.3s; }
.import-confirm-btn:hover { background: var(--color-accent-hover); }

/* CJK ‰∫§‰∫íÊ†áËÆ∞ */
.interactive-word { border-bottom: 1px dashed var(--color-accent); cursor: pointer; transition: all 0.2s; }
.interactive-word:hover { background: rgba(203, 58, 86, 0.1); color: var(--color-accent); }

.fade-enter-active, .fade-leave-active { transition: opacity 1s ease; }
.fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay-gradient"></div>
                <div class="cover-content-layout">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat-large" alt="Cover Cat"></div>
                    <div class="cover-text-group jp-style">
                        <h1 class="cover-title-main">Memori</h1>
                        <p class="subtitle-main">Ë®ÄËëâ„ÅÆËÄÉÂè§Â≠¶</p>
                        <div class="poem-main"><p>ÊôÇ„ÅÆÁ†Ç„Å´Âüã„ÇÇ„Çå„Åü„ÄÅ</p><p>Ë®ÄËëâ„ÅÆÊ¨†Áâá„ÇíÊé¢„Åó„Å¶„ÄÇ</p></div>
                        <button class="start-btn-main jp-btn" @click="enterApp">Êé¢Á¥¢„ÇíÂßã„ÇÅ„Çã</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container with-texture" :style="{ background: langConfig[currentLang].bg, fontFamily: langConfig[currentLang].font }">
            
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header">
                    <h3 :style="{ color: langConfig[currentLang].accent }">
                        {{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }} 
                        <span class="count">{{ filteredHistory.length }} ËØç</span>
                    </h3>
                    <span class="import-trigger" @click="showImportModal = true" title="ÊåÇËΩΩÁ¶ªÁ∫øËæûÂÖ∏"><i class="fa-solid fa-file-arrow-up"></i></span>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" 
                         class="word-item" 
                         :class="{ 'active': mode === 'card' && item.id === card.id }"
                         :style="(mode === 'card' && item.id === card.id) ? { borderLeftColor: langConfig[currentLang].accent } : {}"
                         @click="loadWord(item)">
                        <span class="word-text">{{ item.word }}</span>
                        <i v-if="item.isLocal" class="fa-solid fa-scroll" style="font-size:0.7em; color:#8d6e63"></i>
                        <div class="item-actions"><button class="del-icon" @click.stop="deleteWord(item.id)">√ó</button></div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="shiba-img" alt="Shiba">
                        <div v-if="neroState === 'thinking'" class="shiba-bubble">ÂóÖÂóÖ...</div>
                        <div v-if="neroState === 'happy'" class="shiba-bubble">È¶ôÔºÅ</div>
                    </div>
                    <button class="action-btn outline artistic-btn" @click="mode = 'gallery'"><i class="fa-solid fa-images"></i> ËóèÂìÅÈ¶Ü</button>
                    <button class="action-btn outline artistic-btn" @click="mode = 'history'"><i class="fa-solid fa-scroll"></i> ÂéÜÂè≤Âπ¥Ë°®</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism artistic-border">
                    <div class="lang-pills">
                        <button v-for="(cfg, key) in langConfig" :key="key" @click="switchLang(key)" class="lang-pill" :class="{ 'active': currentLang === key }" :title="cfg.scent">{{ cfg.flag }}</button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="handleSearch" :placeholder="`ÂØªÊâæ${langConfig[currentLang].name}ÁöÑÂë≥ÈÅì...`" class="search-input">
                    <button @click="handleSearch" class="search-btn" :disabled="loading" :style="{ color: langConfig[currentLang].accent }"><i v-if="loading" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <Transition name="fade-mode" mode="out-in">
                    <div v-if="mode === 'gallery'" class="content-area gallery-mode custom-scroll" key="gallery">
                        <div class="gallery-header">
                            <h2 class="gallery-title" :style="{ color: langConfig[currentLang].accent }"><i class="fa-solid fa-bottle-droplet"></i> È¶ôÊ∞õËóèÂìÅÈ¶Ü</h2>
                            <button v-if="filteredHistory.length > 0" @click="clearCurrentHistory" class="clear-history-icon" title="Êï£ÂéªÊóßÈ¶ô"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div v-if="filteredHistory.length === 0" class="empty-state"><p>Á©∫Ê∞î‰∏≠ËøòÊú™Áïô‰∏ãËØçËØ≠ÁöÑÈ¶ôÊ∞î...</p></div>
                        <div class="gallery-list">
                            <div v-for="item in filteredHistory" :key="item.id" class="gallery-row-item glass-morphism" @click="loadWord(item)">
                                <div class="row-left"><span class="row-word">{{ item.word }}</span><span class="row-reading">{{ item.reading }}</span></div>
                                <div class="row-right">
                                    <button class="row-del-btn" @click.stop="deleteGalleryItem(item.id)" title="ÁßªÈô§Ê≠§ËØç"><i class="fa-solid fa-trash"></i></button>
                                    <span class="row-arrow" :style="{color: langConfig[currentLang].accent}"><i class="fa-solid fa-feather"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'card'" class="content-area" key="card">
                        <div class="card-3d-wrapper" @click="isFlipped = !isFlipped">
                            <div class="card-body" :class="{ 'is-flipped': isFlipped }">
                                <div class="card-face front glass-morphism artistic-border">
                                    <div class="img-header" :class="{ 'loading': imageLoading }">
                                        <img :src="card.imageUrl" class="cover-img" @error="handleImageError" @load="imageLoading = false">
                                        <div v-if="imageLoading" class="img-loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                                        <div class="overlay-actions">
                                            <button class="icon-btn star-btn" @click.stop="toggleCollect" :title="card.isCollected ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Âä†ÂÖ•ÂçïËØçÊú¨'"><i class="fa-solid fa-star" :class="{ 'starred': card.isCollected }"></i></button>
                                            <button class="icon-btn" @click.stop="toggleImageLock"><i class="fa-solid" :class="card.isImageLocked ? 'fa-lock' : 'fa-lock-open'"></i></button>
                                        </div>
                                    </div>
                                    <div class="text-content custom-scroll">
                                        <div class="word-display"><p v-if="card.lang === 'zh' && card.pinyin" class="pinyin">{{ card.pinyin }}</p><div class="word-group"><h2 class="main-word">{{ card.word }}</h2></div><div class="pronunciation"><span>{{ card.reading }}</span><button class="speaker-btn" @click.stop="speak(card.word, card.lang)"><i class="fa-solid fa-volume-high"></i></button></div></div>
                                        <div class="meta-info"><span v-if="card.word_details" class="meta-tag">{{ card.word_details }}</span></div><p v-if="card.simple_english" class="simple-en">{{ card.simple_english }}</p>
                                        <div v-if="card.isLocal" class="local-indicator"><i class="fa-solid fa-scroll"></i> Êú¨Âú∞ÁèçËóè</div>
                                        <div class="flip-hint">ÈóªÈ¶ôËØÜ‰πâ <i class="fa-solid fa-arrow-right-long"></i></div>
                                    </div>
                                </div>
                                <div class="card-face back glass-morphism artistic-border">
                                    <div class="back-header" @click.stop><h3>{{ card.word }}</h3><div class="back-actions"><button class="icon-btn sm" @click.stop="speak(card.word, card.lang)"><i class="fa-solid fa-volume-high"></i></button><button class="icon-btn sm" @click.stop="isFlipped = !isFlipped"><i class="fa-solid fa-rotate-left"></i></button></div></div>
                                    <div class="back-scroll custom-scroll" @click.stop>
                                        <div class="info-block meaning"><span class="label">Èáä‰πâ</span><div class="html-content" v-html="formatInteractiveText(card.meaning)"></div></div>
                                        <div v-if="card.etymology" class="info-block etymology"><span class="label">ËØçÊ∫êËÄÉÊçÆ (Etymology)</span><p v-html="formatInteractiveText(card.etymology)"></p></div>
                                        <div v-if="card.examples && card.examples.length" class="info-block examples"><span class="label">ÂÖ∏Á±ç‰æãÂè•</span><div v-for="(ex, i) in card.examples" :key="i" class="example-row"><p class="ex-text" @click="speak(ex.text, card.lang)" v-html="formatInteractiveText(ex.text)"></p><p class="ex-cn">{{ ex.cn }}</p></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'history'" class="history-stage glass-morphism artistic-border" key="history">
                        <div class="history-top"><div class="history-header"><h1 :style="{ color: langConfig[currentLang].accent }">ÂéÜÂè≤Â§ß‰∫ãÂπ¥Ë°®</h1><button class="close-mode-btn" @click="mode = 'card'"><i class="fa-solid fa-xmark"></i></button></div><div class="history-tabs"><button :class="{ active: historyTab === 'asia' }" @click="historyTab = 'asia'">üåè ‰∫öÊ¥≤Âè≤</button><button :class="{ active: historyTab === 'europe' }" @click="historyTab = 'europe'">üèõÔ∏è Ê¨ßÊ¥≤Âè≤</button></div></div>
                        <div class="timeline-wrapper custom-scroll"><div class="timeline-list"><div class="timeline-spine" :style="{ background: langConfig[currentLang].accent, opacity: 0.4 }"></div><div v-for="group in groupedTimelines" :key="group.year" class="year-group"><div class="t-year-label"><span class="year-number" :style="{ color: langConfig[currentLang].accent }">{{ group.year }}</span></div><div class="events-container"><div v-for="item in group.events" :key="item.id" class="t-item-box"><div class="t-dot" :style="{background: langConfig[currentLang].accent}"></div><div class="t-content artistic-border"><div class="t-header"><span class="t-icon">{{ item.tag }}</span><div v-if="item.tags" class="t-tags"><span v-for="t in item.tags" :key="t" class="custom-tag" :style="getTagStyle(t)">{{ t }}</span></div></div><span class="t-text">{{ item.event }}</span></div></div></div></div></div></div>
                    </div>
                </Transition>
            </main>

            <div v-if="mode !== 'history'" class="cat-mascot-container" @click="pokeMascot" :class="{ 'poked': neroState === 'happy' }" title="ÂèåÂáª‰∏ä‰º†Áå´Âí™" @dblclick="triggerMascotInput">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" accept="image/*" style="display:none">
                <div class="cat-img-wrapper"><img :src="userCat" class="cat-mascot-img" :class="neroState === 'thinking' ? 'thinking-anim' : 'idle-anim'" alt="Cat Mascot"></div>
                <div v-if="neroState === 'thinking'" class="cat-bubble">ÊåñÊéò‰∏≠...</div>
                <div v-if="neroState === 'happy'" class="cat-bubble">Âñµ~‚ú®</div>
            </div>
        </div>

        <div v-if="showImportModal" class="modal-overlay" @click.self="showImportModal = false">
            <div class="modal-box">
                <div class="modal-header">üì• ÊåÇËΩΩÁ¶ªÁ∫øËæûÂÖ∏</div>
                <div class="form-group">
                    <label class="form-label">ÁõÆÊ†áËØ≠Áßç</label>
                    <select v-model="importLang" class="w-full p-2 border rounded">
                        <option v-for="(cfg, key) in langConfig" :key="key" :value="key">{{ cfg.flag }} {{ cfg.name }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">‰∏ä‰º† JSON</label>
                    <div class="file-drop" @click="$refs.fileInput.click()">
                        <p v-if="!importFile">ÁÇπÂáªÈÄâÊã©Êñá‰ª∂</p>
                        <p v-else>{{ importFile.name }}</p>
                        <input type="file" ref="fileInput" accept=".json" style="display:none" @change="handleFileSelect">
                    </div>
                </div>
                <button class="import-confirm-btn" @click="executeImport">Á°ÆËÆ§ÊåÇËΩΩ</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        // IndexedDB Ê†∏ÂøÉ
        class DictionaryDB {
            constructor() { this.dbName = 'MemoriDB_V3'; this.db = null; }
            async open() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        ['jp', 'cjp', 'zh', 'lzh', 'en', 'de', 'it', 'lat', 'kr'].forEach(lang => {
                            if (!db.objectStoreNames.contains(lang)) db.createObjectStore(lang, { keyPath: 'word' });
                        });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = (e) => reject(e);
                });
            }
            async find(lang, word) {
                if (!this.db) await this.open();
                return new Promise((resolve) => {
                    if (!this.db.objectStoreNames.contains(lang)) return resolve(null);
                    const tx = this.db.transaction(lang, 'readonly');
                    const req = tx.objectStore(lang).get(word);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            }
            async bulkAdd(lang, items) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    if (!this.db.objectStoreNames.contains(lang)) return reject('Language store not found');
                    const tx = this.db.transaction(lang, 'readwrite');
                    const store = tx.objectStore(lang);
                    let count = 0;
                    items.forEach(item => {
                        store.put({
                            word: item.word || item.wordName,
                            reading: item.reading || item.pronunciation || '',
                            meaning: item.meaning || item.wordDesc,
                            isLocal: true,
                            etymology: null, examples: []
                        });
                        count++;
                    });
                    tx.oncomplete = () => resolve(count);
                    tx.onerror = (e) => reject(e);
                });
            }
        }

        createApp({
            setup() {
                const db = new DictionaryDB();
                const showCover = ref(true);
                function enterApp() { showCover.value = false; }

                const currentLang = ref('cjp');
                const wordInput = ref('');
                const loading = ref(false);
                const imageLoading = ref(false);
                const neroState = ref('idle'); 
                const isFlipped = ref(false);
                const history = ref([]); 
                const mascotInput = ref(null);
                const showImportModal = ref(false);
                const importLang = ref('cjp');
                const importFile = ref(null);

                const shibaImages = { idle: './shiba/idle.gif', thinking: './shiba/run.gif', happy: './shiba/happy.gif' };
                const defaultCat = './my-cat.png'; 
                const userCat = ref(localStorage.getItem('memori-user-cat') || defaultCat);
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };
                const mode = ref('gallery'); 
                const historyTab = ref('asia');

                const unifiedFont = "'Zen Old Mincho', 'Noto Serif SC', 'Noto Serif JP', 'Noto Serif KR', serif";
                const langConfig = {
                    cjp: { name: 'Âè§ÂÖ∏Êó•ËØ≠', scent: 'ÊûØÂ¢®', flag: 'üèØ', code: 'ja-JP', bg: 'linear-gradient(to top, #EBE6DF 0%, #F2EFE8 100%)', accent: '#5A3D30', text: '#2B201A', font: unifiedFont },
                    lzh: { name: 'Âè§‰ª£Ê±âËØ≠', scent: 'Ê™ÄÈ¶ô', flag: 'üìú', code: 'zh-CN', bg: 'linear-gradient(to top, #E9EAE4 0%, #F4F5F0 100%)', accent: '#41555D', text: '#1B2124', font: unifiedFont },
                    jp: { name: 'Êó•ËØ≠', scent: 'Ê®±‰∏éÂíåÁ∫∏', flag: 'üáØüáµ', code: 'ja-JP', bg: 'linear-gradient(to top, #F9F1F0 0%, #FCEFE8 100%)', accent: '#CB3A56', text: '#4B2F32', font: unifiedFont },
                    zh: { name: 'Áé∞‰ª£Ê±âËØ≠', scent: 'Êú±Á†Ç‰∏éËå∂', flag: 'üá®üá≥', code: 'zh-CN', bg: 'linear-gradient(120deg, #FBF8F1 0%, #F6F4EF 100%)', accent: '#9D2933', text: '#2E211B', font: unifiedFont },
                    en: { name: 'Ëã±ËØ≠', scent: 'ÁæäÁöÆÂç∑', flag: 'üá¨üáß', code: 'en-US', bg: 'linear-gradient(-20deg, #E6E8EB 0%, #EDF1F4 100%)', accent: '#1772B4', text: '#151D29', font: "'Playfair Display', serif" },
                    kr: { name: 'Èü©ËØ≠', scent: 'Êú®Êßø', flag: 'üá∞üá∑', code: 'ko-KR', bg: 'linear-gradient(to top, #F7EFF2 0%, #F9EDF1 100%)', accent: '#B25D7E', text: '#402E34', font: unifiedFont },
                    de: { name: 'Âæ∑ËØ≠', scent: 'ÈªëÊ£ÆÊûó', flag: 'üá©üá™', code: 'de-DE', bg: 'linear-gradient(to top, #E8ECEB 0%, #EFF2F1 100%)', accent: '#374E59', text: '#1A2326', font: "'Playfair Display', serif" },
                    it: { name: 'ÊÑèËØ≠', scent: 'ÊâòÊñØÂç°Á∫≥', flag: 'üáÆüáπ', code: 'it-IT', bg: 'linear-gradient(120deg, #F8F4E8 0%, #FAF6EE 100%)', accent: '#8E4932', text: '#36221B', font: "'Playfair Display', serif" },
                    lat: { name: 'Êãâ‰∏Å', scent: '‰π≥È¶ô', flag: 'üèõÔ∏è', code: 'it-IT', bg: 'linear-gradient(to top, #EAE8E6 0%, #F0EEEC 100%)', accent: '#605A54', text: '#262422', font: "'Cinzel', serif" }
                };

                const card = ref({ id: Date.now(), word: 'Memori', reading: 'me-mo-ri', meaning: 'Ê¨¢ËøéÊù•Âà∞ËØ≠Ë®ÄËÄÉÂè§ÂèëÊéòÁé∞Âú∫', imageUrl: 'https://picsum.photos/seed/memori/800/1000', isImageLocked: false, examples: [], lang: 'jp', nextReview: 0, interval: 0, isCollected: false });
                const filteredHistory = computed(() => history.value.filter(item => (item.lang || 'jp') === currentLang.value));

                // ÂéÜÂè≤Âπ¥Ë°® (ÂÆåÊï¥ÊÅ¢Â§ç)
                const timelines = ref({
                    asia: [
                        { id: 1, year: 'Ââç7000', event: 'Ê≤≥ÂßÜÊ∏°ÊñáÂåñ (Á®ª‰ΩúÊñáÊòéËµ∑Ê∫ê)', tag: 'üá®üá≥', tags: ['ËÄÉÂè§', 'ÊñáÊòé'] },
                        { id: 1001, year: 'Ââç1600', event: 'ÂïÜÊúùÂª∫Á´ã (ÈùíÈìúÊó∂‰ª£ÈºéÁõõ)', tag: 'üè∫', tags: ['ÁéãÊúù'] },
                        { id: 1002, year: 'Ââç1046', event: 'ÁâßÈáé‰πãÊàò (Âë®ÊúùÂª∫Á´ã)', tag: '‚öîÔ∏è', tags: ['Êàò‰∫â'] },
                        { id: 100, year: 'Ââç221', event: 'Áß¶ÂßãÁöáÁªü‰∏ÄÂÖ≠ÂõΩ', tag: 'üß±', tags: ['Áªü‰∏Ä', 'Â∏ùÂà∂'] },
                        { id: 1003, year: 'Ââç138', event: 'Âº†È™ûÂá∫‰ΩøË•øÂüü (‰∏ùÁª∏‰πãË∑Ø)', tag: 'üê´', tags: ['Â§ñ‰∫§'] },
                        { id: 1004, year: '57', event: 'Ê±âÂßîÂ•¥ÂõΩÁéãÂç∞ (‰∏≠Êó•‰∫§ÊµÅ)', tag: 'üáØüáµ', tags: ['Êó•Êú¨', 'Â§ñ‰∫§'] },
                        { id: 1005, year: '645', event: 'Â§ßÂåñÊîπÊñ∞ (Êó•Êú¨Âæã‰ª§Âà∂)', tag: 'üìú', tags: ['Êó•Êú¨', 'ÊîπÈù©'] },
                        { id: 1006, year: '1405', event: 'ÈÉëÂíå‰∏ãË•øÊ¥ã', tag: '‚õµ', tags: ['Ëà™Êµ∑'] },
                        { id: 1007, year: '1443', event: 'ÊúùÈ≤ú‰∏ñÂÆóÂàõÂà∂Ë∞öÊñá', tag: 'üá∞üá∑', tags: ['Èü©ÂõΩ', 'ÊñáÂ≠ó'] },
                        { id: 1008, year: '1600', event: 'ÂÖ≥Âéü‰πãÊàò (Âæ∑Â∑ùÂπïÂ∫ú)', tag: 'üèØ', tags: ['Êó•Êú¨', 'Êàò‰∫â'] },
                        { id: 1009, year: '1868', event: 'ÊòéÊ≤ªÁª¥Êñ∞', tag: '‚öôÔ∏è', tags: ['Êó•Êú¨', 'Ëøë‰ª£Âåñ'] },
                        { id: 1010, year: '1911', event: 'Ëæõ‰∫•Èù©ÂëΩ (Ê∏ÖÊúùÁÅ≠‰∫°)', tag: 'üö©', tags: ['Èù©ÂëΩ'] }
                    ],
                    europe: [
                        { id: 2001, year: 'Ââç3000', event: 'Â∑®Áü≥Èòµ (Stonehenge) Âª∫ÈÄ†', tag: 'ü™®', tags: ['ËÄÉÂè§'] },
                        { id: 201, year: 'Ââç753', event: 'ÁΩóÈ©¨Âª∫Âüé', tag: 'üèõÔ∏è', tags: ['‰º†ËØ¥', 'ÁΩóÈ©¨'] },
                        { id: 2002, year: 'Ââç490', event: 'È©¨ÊãâÊùæÊàòÂΩπ (Â∏åÊ≥¢Êàò‰∫â)', tag: 'üèÉ', tags: ['Â∏åËÖä', 'Êàò‰∫â'] },
                        { id: 2003, year: 'Ââç27', event: 'Â••Âè§ÊñØÈÉΩÂª∫Á´ãÁΩóÈ©¨Â∏ùÂõΩ', tag: 'üëë', tags: ['ÁΩóÈ©¨', 'Â∏ùÂà∂'] },
                        { id: 2004, year: '476', event: 'Ë•øÁΩóÈ©¨Â∏ùÂõΩÁÅ≠‰∫°', tag: 'üìâ', tags: ['‰∏≠‰∏ñÁ∫™'] },
                        { id: 2005, year: '1066', event: 'ËØ∫ÊõºÂæÅÊúç (ÈªëÊñØÂª∑ÊñØÊàòÂΩπ)', tag: 'üõ°Ô∏è', tags: ['Ëã±ÂõΩ'] },
                        { id: 2006, year: '1215', event: 'Â§ßÂÆ™Á´† (Magna Carta) Á≠æÁΩ≤', tag: 'üìú', tags: ['Ê≥ïÂæã'] },
                        { id: 2007, year: '1453', event: 'ÂêõÂ£´Âù¶‰∏ÅÂ†°Èô∑ËêΩ', tag: '‚ò™Ô∏è', tags: ['ÊãúÂç†Â∫≠'] },
                        { id: 2008, year: '1517', event: 'È©¨‰∏Å¬∑Ë∑ØÂæ∑ÂÆóÊïôÊîπÈù©', tag: 'üî®', tags: ['ÂÆóÊïô'] },
                        { id: 202, year: '1789', event: 'Ê≥ïÂõΩÂ§ßÈù©ÂëΩ', tag: 'üá´üá∑', tags: ['Èù©ÂëΩ'] },
                        { id: 2009, year: '1914', event: 'Á¨¨‰∏ÄÊ¨°‰∏ñÁïåÂ§ßÊàòÁàÜÂèë', tag: 'üí£', tags: ['Êàò‰∫â'] }
                    ]
                });

                function parseYear(yearStr) { if (!yearStr) return 0; const isBC = yearStr.includes('Ââç') || yearStr.includes('BC') || yearStr.includes('-'); const numMatch = yearStr.match(/\d+/); const num = numMatch ? parseInt(numMatch[0]) : 0; return isBC ? -num : num; }
                const groupedTimelines = computed(() => { const rawList = timelines.value[historyTab.value]; const groups = {}; rawList.forEach(item => { if (!groups[item.year]) { groups[item.year] = { year: item.year, rawYear: parseYear(item.year), events: [] }; } groups[item.year].events.push(item); }); return Object.values(groups).sort((a, b) => a.rawYear - b.rawYear); });
                
                function getTagStyle(str) { let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); const hue = Math.abs(hash % 360); return { backgroundColor: `hsl(${hue}, 15%, 90%)`, color: `hsl(${hue}, 40%, 35%)`, border: `1px solid hsl(${hue}, 20%, 80%)` }; }

                onMounted(async () => {
                    await db.open();
                    const savedBook = localStorage.getItem('memori-book'); if (savedBook) { history.value = JSON.parse(savedBook); }
                    window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
                    // ÁªëÂÆöCJKÁÇπÂáª
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('interactive-word')) {
                            wordInput.value = e.target.innerText;
                            handleSearch();
                        }
                    });
                });

                function handleImageError(e) { const currentSrc = e.target.src; if (currentSrc.includes('pollinations.ai')) { e.target.src = `https://picsum.photos/seed/${encodeURIComponent(card.value.word)}/800/1000`; } else { e.target.src = 'https://via.placeholder.com/400x600?text=No+Image'; } }
                function speak(text, langCode = null) { if (!text) return; const langKey = langCode || currentLang.value; if (langKey === 'zh' || langKey === 'lzh') return; window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); const config = langConfig[langKey]; const targetBCP47 = config ? config.voice : 'en-US'; utterance.lang = targetBCP47; window.speechSynthesis.speak(utterance); }

                function toggleCollect() {
                    if (card.value.isCollected) {
                        if(!confirm('üíî Á°ÆÂÆöË¶ÅÂ∞ÜÊ≠§ËØçÁßªÂá∫ÂçïËØçÊú¨ÂêóÔºü')) return;
                        history.value = history.value.filter(h => !(h.word === card.value.word && h.lang === card.value.lang));
                        card.value.isCollected = false;
                    } else {
                        const exists = history.value.some(h => h.word === card.value.word && h.lang === card.value.lang);
                        if (!exists) {
                            const cardToSave = { ...card.value, isCollected: true };
                            history.value.unshift(cardToSave);
                            card.value.isCollected = true;
                        }
                    }
                    localStorage.setItem('memori-book', JSON.stringify(history.value));
                }

                // --- Ê†∏ÂøÉÔºöÂèåËΩ®Ê£ÄÁ¥¢ ---
                async function handleSearch() {
                    if (!wordInput.value) return;
                    loading.value = true; imageLoading.value = true; neroState.value = 'thinking'; isFlipped.value = false; mode.value = 'card';
                    
                    const query = wordInput.value.trim();
                    const lang = currentLang.value;

                    try {
                        // 1. Êú¨Âú∞Êã¶Êà™
                        const localHit = await db.find(lang, query);
                        if (localHit) {
                            console.log('üìö Êú¨Âú∞ÂëΩ‰∏≠');
                            card.value = { 
                                ...localHit, 
                                id: Date.now(), 
                                lang, 
                                isLocal: true,
                                imageUrl: `https://pollinations.ai/p/${encodeURIComponent(query)}?width=800&height=1000&nologo=true&model=flux` 
                            };
                            // ÈùôÈªòË°•ÂÖ®
                            fetchEnrichment(query, lang);
                        } else {
                            // 2. ÂÖ®ÈáèÂèëÊéò
                            const res = await fetch('/api/openai', { 
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ word: query, lang: lang, type: 'full' }) 
                            });
                            if (!res.ok) throw new Error('API Error');
                            const data = await res.json();
                            const prompt = `ancient museum artifact ${data.simple_english || data.word}, cinematic lighting`; 
                            const finalImageUrl = `https://pollinations.ai/p/${encodeURIComponent(prompt)}?width=800&height=1000&nologo=true&model=flux`;
                            card.value = { id: Date.now(), ...data, lang: lang, imageUrl: finalImageUrl, isLocal: false, isCollected: false };
                        }
                        
                        // Ëá™Âä®Âä†ÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï (ÂéªÈáç)
                        const existsIdx = history.value.findIndex(h => h.word === card.value.word && h.lang === card.value.lang);
                        if (existsIdx === -1) {
                            history.value.unshift({ ...card.value });
                            localStorage.setItem('memori-book', JSON.stringify(history.value));
                        }

                        neroState.value = 'happy';
                        setTimeout(() => neroState.value = 'idle', 3000); 
                    } catch (e) { alert('ÊåñÊéòÂ§±Ë¥•: ' + e.message); neroState.value = 'idle'; } finally { loading.value = false; }
                }

                async function fetchEnrichment(word, lang) {
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word, lang, type: 'enrich' })
                        });
                        const data = await res.json();
                        if (card.value.word === word) {
                            card.value.etymology = data.etymology;
                            card.value.examples = data.examples;
                        }
                    } catch (e) { console.error('Ë°•ÂÖ®Â§±Ë¥•', e); }
                }

                // CJK ‰∫§‰∫íÂ§ÑÁêÜ
                function formatInteractiveText(text) {
                    if (!text) return '';
                    if (['zh', 'lzh', 'jp', 'cjp', 'kr'].includes(currentLang.value)) {
                        return text.replace(/([\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]{2,})/g, '<span class="interactive-word">$1</span>');
                    }
                    return text;
                }

                // ËæûÂÖ∏ÂØºÂÖ•
                function handleFileSelect(e) { importFile.value = e.target.files[0]; }
                async function executeImport() {
                    if (!importFile.value) return alert('ËØ∑ÈÄâÊã©Êñá‰ª∂');
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const items = Array.isArray(json) ? json : [];
                            const count = await db.bulkAdd(importLang.value, items);
                            alert(`ÊàêÂäüÊåÇËΩΩ ${count} Êù°ËØçÁõÆÔºÅ`);
                            showImportModal.value = false;
                        } catch (err) { alert('ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• JSON Ê†ºÂºè'); }
                    };
                    reader.readAsText(importFile.value);
                }

                const loadWord = (item) => { card.value = item; if (item.lang && item.lang !== currentLang.value) switchLang(item.lang); isFlipped.value = false; mode.value = 'card'; };
                function deleteGalleryItem(id) { if(!confirm('Á°ÆÂÆöË¶Å‰ªéËóèÂìÅÈ¶ÜÁßªÈô§Ëøô‰∏™ËØçÂêóÔºü')) return; history.value = history.value.filter(item => item.id !== id); localStorage.setItem('memori-book', JSON.stringify(history.value)); }
                const deleteWord = (id) => deleteGalleryItem(id);
                const toggleImageLock = () => { card.value.isImageLocked = !card.value.isImageLocked; };
                function pokeMascot() { if (neroState.value === 'idle') { neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 1500); } }
                function triggerMascotInput() { mascotInput.value.click(); }
                function handleMascotUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { userCat.value = e.target.result; localStorage.setItem('memori-user-cat', e.target.result); alert('üê± Êñ∞Áå´Âí™Â∑≤‰∏ä‰ªªÔºÅ'); }; reader.readAsDataURL(file); }
                function switchLang(lang) { currentLang.value = lang; mode.value = 'card'; }
                function clearCurrentHistory() { if (!confirm(`‚ö†Ô∏è Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫„Äê${langConfig[currentLang.value].name}„ÄëÁöÑÊâÄÊúâËÆ∞ÂΩïÂêóÔºü`)) return; history.value = history.value.filter(item => (item.lang || 'jp') !== currentLang.value); localStorage.setItem('memori-book', JSON.stringify(history.value)); }

                return {
                    showCover, enterApp, currentLang, wordInput, loading, imageLoading, neroState, isFlipped, history, mascotInput, shibaImages, defaultCat, userCat, coverImages, mode, historyTab, timelines, groupedTimelines, getTagStyle, langConfig, card, filteredHistory, handleImageError, speak, toggleCollect, generateCard, loadWord, deleteGalleryItem, deleteWord, toggleImageLock, pokeMascot, triggerMascotInput, handleMascotUpload, switchLang, clearCurrentHistory,
                    // Êñ∞Â¢û
                    showImportModal, importLang, importFile, handleFileSelect, executeImport, formatInteractiveText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
