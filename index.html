<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¿†æ – Â· Memori - å­¦æœ¯è¾å…¸ä¸å¹´è¡¨</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- ğŸ® æ ¸å¿ƒä¸­å›½è‰²ä¸»é¢˜ (Zhongguose) --- */
:root {
  --color-bg-main: #E2E1E4;  --color-text-main: #2D241E; 
  --color-accent: #CB3A56;   --color-accent-hover: #EF7A82; 
  --glass-bg: rgba(255, 253, 248, 0.85);
  --glass-border: rgba(203, 58, 86, 0.15); 
}

* { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--color-accent) transparent; }
body { margin: 0; font-family: 'Noto Serif SC', serif; background-color: var(--color-bg-main); color: var(--color-text-main); overflow: hidden; }

/* ğŸ® å°é¢ä¸è¿‡æ¸¡ */
.cover-stage { position: fixed; inset: 0; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: all 1s ease-in-out; }
.cover-overlay { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(45,36,30,0.7) 0%, rgba(45,36,30,0.3) 100%); }
.cover-content { position: relative; z-index: 2; color: #f8f4e6; text-align: center; }
.start-btn { margin-top: 40px; padding: 15px 50px; border: 1px solid #fff; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); cursor: pointer; transition: 0.3s; }
.start-btn:hover { background: #fff; color: var(--color-accent); }

/* ğŸ® ä¸»å¸ƒå±€ */
.app-container { display: flex; width: 100vw; height: 100vh; position: relative; }
.sidebar { width: 320px; padding: 30px; display: flex; flex-direction: column; z-index: 20; background: var(--glass-bg); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); }
.main-stage { flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; position: relative; overflow-y: auto; }

/* ğŸ® å¡ç‰‡ 3D ç¿»è½¬ */
.card-3d-wrapper { width: 420px; height: 620px; perspective: 1500px; cursor: pointer; }
.card-body { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
.card-body.is-flipped { transform: rotateY(180deg); }
.card-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 30px; background: #fff; padding: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid var(--glass-border); display: flex; flex-direction: column; }
.card-face.back { transform: rotateY(180deg); background: #fdfdfd; }

/* ğŸ® åä¸½èŠ±ç”°ä¸æ ‘ */
.flower-field { display: flex; gap: 10px; margin-top: 20px; }
.flower-icon { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; }
.memory-tree-container { position: absolute; bottom: 40px; right: 40px; text-align: center; }
.tree-img { width: 180px; filter: drop-shadow(0 0 15px rgba(203, 58, 86, 0.2)); transition: 0.5s; }

/* ğŸ® äº¤äº’å¼ä¾‹å¥ */
.clickable-span { color: var(--color-accent); cursor: help; border-bottom: 1px dashed var(--color-accent); transition: 0.2s; padding: 0 2px; }
.clickable-span:hover { background: rgba(203, 58, 86, 0.1); }

/* ğŸ® å¹´è¡¨æ ·å¼ */
.timeline-item { position: relative; padding-left: 30px; margin-bottom: 25px; border-left: 2px solid var(--color-accent); }
.year-tag { font-family: 'Cinzel', serif; font-weight: bold; color: var(--color-accent); margin-bottom: 5px; }

.fade-enter-active, .fade-leave-active { transition: opacity 0.8s; }
.fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage" style="background-image: url('./cover-bg.jpg')">
                <div class="cover-overlay"></div>
                <div class="cover-content">
                    <h1 class="text-6xl font-serif mb-4">å¿†æ – Â· Memori</h1>
                    <p class="text-xl tracking-widest opacity-80">æ²‰æ·€è¯­è¨€ä¹‹ç¾ï¼Œé“­åˆ»æ–‡æ˜è½¨è¿¹</p>
                    <button class="start-btn" @click="showCover = false">è¿›å…¥è¾å…¸</button>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container" :style="{ background: langConfig[currentLang].bg }">
            <aside class="sidebar">
                <h2 class="text-2xl font-bold mb-6 flex justify-between items-center" :style="{ color: langConfig[currentLang].accent }">
                    {{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }}
                    <span class="text-sm opacity-40">{{ filteredHistory.length }} è¯</span>
                </h2>
                <div class="flex-1 overflow-y-auto custom-scroll">
                    <div v-for="h in filteredHistory" :key="h.id" class="p-3 mb-2 rounded-xl bg-white/50 hover:bg-white cursor-pointer transition-all shadow-sm" @click="loadWord(h)">
                        {{ h.word }}
                    </div>
                </div>
                <div class="mt-6 space-y-3">
                    <button class="w-full py-3 bg-[#CB3A56] text-white rounded-xl font-bold" @click="startReview">å¤ä¹ è®¡åˆ’</button>
                    <button class="w-full py-3 border border-pink-200 rounded-xl" @click="mode = 'history'">å†å²å¹´è¡¨</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar w-full max-w-xl flex gap-3 p-4 bg-white/80 backdrop-blur rounded-2xl shadow-lg mb-10">
                    <select v-model="currentLang" class="bg-transparent font-bold">
                        <option v-for="(v, k) in langConfig" :key="k" :value="k">{{ v.flag }}</option>
                    </select>
                    <input v-model="wordInput" @keyup.enter="generateCard" placeholder="è¾“å…¥è¯æ±‡å¼€å¯è€ƒè¯..." class="flex-1 bg-transparent outline-none">
                    <button @click="generateCard" class="text-[#CB3A56] text-xl"><i v-if="loading" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-feather-pointed"></i></button>
                </div>

                <Transition name="fade" mode="out-in">
                    <div v-if="mode === 'card'" class="card-3d-wrapper" @click="isFlipped = !isFlipped">
                        <div class="card-body" :class="{ 'is-flipped': isFlipped }">
                            <div class="card-face front flex flex-col items-center justify-center">
                                <span class="text-sm tracking-[0.3em] text-[#CB3A56] mb-2">{{ card.reading }}</span>
                                <h1 class="text-5xl font-serif mb-6">{{ card.word }}</h1>
                                <div class="w-12 h-px bg-gray-300 mb-6"></div>
                                <div class="text-xl text-center leading-relaxed px-6" v-html="card.meaning"></div>
                            </div>
                            <div class="card-face back overflow-y-auto custom-scroll" @click.stop>
                                <section class="mb-8">
                                    <label class="text-[10px] uppercase tracking-widest text-[#CB3A56] font-bold block mb-3">è¯­æºä¸è€ƒè¯</label>
                                    <p class="text-sm leading-relaxed text-gray-700 text-justify" v-html="card.etymology"></p>
                                </section>
                                <section v-if="card.examples && card.examples.length">
                                    <label class="text-[10px] uppercase tracking-widest text-[#CB3A56] font-bold block mb-3">å­¦æœ¯ä¾‹è¯</label>
                                    <div v-for="(ex, i) in card.examples" :key="i" class="mb-5 pl-4 border-l-2 border-pink-100">
                                        <p class="text-sm italic mb-2 text-gray-800" v-html="renderExample(ex.text)"></p>
                                        <p class="text-xs text-gray-400">{{ ex.cn }}</p>
                                    </div>
                                </section>
                                <button @click="toggleCollect" class="mt-auto w-full py-3 bg-[#CB3A56] text-white rounded-lg">{{ card.isCollected ? 'å·²å­˜æ¡£' : 'å­˜å…¥è¾å…¸' }}</button>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'history'" class="w-full max-w-4xl p-10 bg-white/90 rounded-3xl shadow-2xl overflow-y-auto h-[80vh]">
                        <h2 class="text-3xl font-serif mb-8 border-b pb-4 flex justify-between">
                            å†å²å¹´è¡¨ <button @click="mode = 'card'" class="text-gray-300">Ã—</button>
                        </h2>
                        <div v-for="group in groupedTimelines" :key="group.year" class="mb-10">
                            <div class="year-tag text-2xl mb-4">{{ group.year }}</div>
                            <div v-for="e in group.events" class="timeline-item">
                                <span class="text-xl mr-3">{{ e.tag }}</span>
                                <span class="text-gray-700">{{ e.event }}</span>
                            </div>
                        </div>
                    </div>
                </Transition>

                <div class="fixed bottom-10 left-10">
                    <div class="flower-field">
                        <img v-for="(f, i) in flowerField" :key="i" :src="f.img" class="flower-icon animate-pulse" :title="f.name">
                    </div>
                </div>
                
                <div class="memory-tree-container">
                    <img :src="treeStage.img" class="tree-img" @click="pokeTree">
                    <div class="text-[10px] mt-2 opacity-30 font-serif">å¿ƒä¹‹æ ‘ï¼š{{ treeStage.status }}</div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        createApp({
            setup() {
                const showCover = ref(true); const currentLang = ref('jp'); const mode = ref('card');
                const wordInput = ref(''); const loading = ref(false); const isFlipped = ref(false);
                const history = ref([]); const reviewCounts = ref({});
                const card = ref({ word: 'å¿†æ –', reading: 'MEMORI', meaning: 'è·¨å­¦ç§‘æ·±åº¦è¾å…¸åŠæ–‡æ˜å¹´è¡¨ç³»ç»Ÿå·²å¯åŠ¨ã€‚', etymology: 'â€œå¿†â€å³è®°å¿†ï¼Œâ€œæ –â€å³å±…æ‰€ï¼Œæ—¨åœ¨ä¸ºæ¼‚æ³Šçš„æ–‡æ˜è¯æ±‡å¯»æ‰¾ä¸€å¤„çµé­‚æ –æ¯åœ°ã€‚', examples: [] });

                const langConfig = {
                    jp: { name: 'æ—¥è¯­', flag: 'ğŸ‡¯ğŸ‡µ', bg: '#F9F1F0', accent: '#CB3A56', plant: 'ethereal_cherry_blossom' },
                    zh: { name: 'æ±‰è¯­', flag: 'ğŸ‡¨ğŸ‡³', bg: '#FBF8F1', accent: '#9D2933', plant: 'celestial_peony' },
                    en: { name: 'è‹±è¯­', flag: 'ğŸ‡¬ğŸ‡§', bg: '#EDF1F4', accent: '#1772B4', plant: 'luminous_rose' },
                    kr: { name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·', bg: '#F9EDF1', accent: '#B25D7E', plant: 'dreamy_hibiscus' },
                    lat: { name: 'æ‹‰ä¸è¯­', flag: 'ğŸ›ï¸', bg: '#EAE8E6', accent: '#605A54', plant: 'ancient_olive' }
                };

                const timelines = ref({
                    asia: [
                        { id: 1, year: '645', tag: 'ğŸ“œ', event: 'å¤§åŒ–æ”¹æ–°ï¼šæ—¥æœ¬æ•ˆä»¿å”åˆ¶ï¼Œç¡®ç«‹å¾‹ä»¤åˆ¶å›½å®¶æ ¹åŸºã€‚' },
                        { id: 2, year: '1008', tag: 'ğŸ–‹ï¸', event: 'ã€Šæºæ°ç‰©è¯­ã€‹æˆä¹¦ï¼Œå¼€åˆ›å¹³å®‰æ—¶ä»£å¥³æ€§æ–‡å­¦å·…å³°ã€‚' },
                        { id: 3, year: '1443', tag: 'ğŸ”¤', event: 'è®­æ°‘æ­£éŸ³ï¼šä¸–å®—å¤§ç‹åˆ›ç«‹è°šæ–‡ï¼Œä½¿éŸ©è¯­æ‹¥æœ‰ç‹¬ç«‹æ–‡å­—ç³»ç»Ÿã€‚' },
                        { id: 4, year: '1151', tag: 'ğŸº', event: 'æ±çª‘åˆ›çƒ§ï¼šåŒ—å®‹å®˜çª‘é’ç“·å®¡ç¾è¾¾åˆ°â€œé›¨è¿‡å¤©æ™´â€çš„æè‡´ã€‚' },
                        { id: 5, year: '1603', tag: 'ğŸ­', event: 'å¾·å·å¹•åºœå»ºç«‹ï¼Œæ±Ÿæˆ·æ—¶ä»£åº¶æ°‘æ–‡åŒ–ï¼ˆå¦‚æµ®ä¸–ç»˜ã€æ­Œèˆä¼ï¼‰èŒå‘ã€‚' },
                        { id: 6, year: '1868', tag: 'ğŸš¢', event: 'æ˜æ²»ç»´æ–°ï¼šæ—¥æœ¬å¼€å¯è„±äºšå…¥æ¬§è¿›ç¨‹ï¼Œæ–‡æ˜å¼€åŒ–ã€‚' },
                        { id: 7, year: '1905', tag: 'ğŸ“', event: 'ä¸­å›½åºŸé™¤ç§‘ä¸¾ï¼šå»¶ç»­ä¸€åƒä¸‰ç™¾å¹´çš„é€‰å®˜åˆ¶åº¦èµ°å‘ç»ˆç»“ã€‚' },
                        { id: 8, year: '1592', tag: 'ğŸ¢', event: 'é—²å±±å²›å¤§æ·ï¼šæèˆœè‡£ç‡é¾Ÿèˆ¹æŠµå¾¡å…¥ä¾µï¼Œæ”¹å†™ä¸œäºšæµ·æˆ˜å²ã€‚' },
                        { id: 9, year: '804', tag: 'ğŸµ', event: 'ç©ºæµ·èµ´å”ï¼šæœ€æ¾„ã€ç©ºæµ·å°†å¯†æ•™ä¸èŒ¶æ–‡åŒ–å¸¦å›æ—¥æœ¬ï¼Œå¼€å¯æ–‡åŒ–é©æ–°ã€‚' },
                        { id: 10, year: '1928', tag: 'â›ï¸', event: 'æ®·å¢Ÿå‘æ˜ï¼šç°ä»£è€ƒå¤å­¦æ­£å¼æ‹‰å¼€ä¸­å›½æ–‡æ˜èµ·æºæ¢ç©¶åºå¹•ã€‚' }
                    ],
                    europe: [
                        { id: 11, year: '1453', tag: 'âš”ï¸', event: 'å›å£«å¦ä¸å ¡é™·è½ï¼šä¸œç½—é©¬å¸å›½ç­äº¡ï¼Œå­¦è€…è¥¿è¿å¼•å‘æ–‡è‰ºå¤å…´ã€‚' },
                        { id: 12, year: '1517', tag: 'â›ª', event: 'é©¬ä¸Â·è·¯å¾·å‘è¡¨ã€Šä¹åäº”æ¡è®ºçº²ã€‹ï¼Œæ‹‰å¼€å®—æ•™æ”¹é©åºå¹•ã€‚' },
                        { id: 13, year: '1687', tag: 'ğŸ', event: 'ç‰›é¡¿å‡ºç‰ˆã€Šè‡ªç„¶å“²å­¦çš„æ•°å­¦åŸç†ã€‹ï¼Œç¡®ç«‹ç»å…¸åŠ›å­¦ä½“ç³»ã€‚' },
                        { id: 14, year: '1789', tag: 'ğŸ•Šï¸', event: 'æ³•å›½å¤§é©å‘½ï¼šäººæƒå®£è¨€å‘å¸ƒï¼Œæ¬§æ´²å›ä¸»åˆ¶åŠ¨æ‘‡ã€‚' },
                        { id: 15, year: '1347', tag: 'ğŸŒ‘', event: 'é»‘æ­»ç—…å¤§æµè¡Œï¼šæ¬§æ´²äººå£é”å‡ï¼Œå®¢è§‚ä¿ƒä½¿ä¸­ä¸–çºªå°å»ºåˆ¶ç“¦è§£ã€‚' },
                        { id: 16, year: '1859', tag: 'ğŸ§¬', event: 'è¾¾å°”æ–‡å‡ºç‰ˆã€Šç‰©ç§èµ·æºã€‹ï¼Œç”Ÿç‰©å­¦è¿›å…¥è¿›åŒ–è®ºæ—¶ä»£ã€‚' },
                        { id: 17, year: '1919', tag: 'ğŸ¨', event: 'åŒ…è±ªæ–¯å­¦é™¢åˆ›ç«‹ï¼šç°ä»£ä¸»ä¹‰è®¾è®¡ç†å¿µå½±å“å…¨çƒå»ºç­‘ä¸ç¾å­¦ã€‚' },
                        { id: 18, year: '1492', tag: 'â›µ', event: 'åœ°ç†å¤§å‘ç°ï¼šå“¥ä¼¦å¸ƒåˆ°è¾¾ç¾æ´²ï¼Œå…¨çƒè´¸æ˜“ç½‘ç»œåˆæ­¥æˆå‹ã€‚' },
                        { id: 19, year: '1755', tag: 'ğŸ›ï¸', event: 'é‡Œæ–¯æœ¬å¤§åœ°éœ‡ï¼šå¼•å‘å¯è’™è¿åŠ¨å¯¹ä¹è§‚ä¸»ä¹‰çš„æ·±åˆ»åæ€ã€‚' },
                        { id: 20, year: '1215', tag: 'ğŸ“œ', event: 'ã€Šå¤§å®ªç« ã€‹ç­¾ç½²ï¼šè‹±å›½ç¡®ç«‹â€œç‹åœ¨æ³•ä¸‹â€çš„å®ªæ”¿ä¼ ç»Ÿã€‚' }
                    ]
                });

                async function generateCard() {
                    if(!wordInput.value) return; loading.value = true; isFlipped.value = false;
                    try {
                        const res = await fetch('/api/openai', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ word: wordInput.value, lang: currentLang.value }) });
                        const data = await res.json(); card.value = { ...data, lang: currentLang.value, isCollected: false };
                        mode.value = 'card'; wordInput.value = '';
                    } catch(e) { alert("è·å–è¯æ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯ã€‚"); } finally { loading.value = false; }
                }

                function renderExample(text) {
                    if(!text) return '';
                    // åªæœ‰ä¸­æ—¥éŸ©è¯­ç§éœ€è¦ span ç‚¹å‡»å¤„ç†
                    if(['jp','zh','kr'].includes(currentLang.value)) {
                        return text.replace(/<span>(.*?)<\/span>/g, '<span class="clickable-span" onclick="window.searchWithin(\'$1\')">$1</span>');
                    }
                    return text;
                }

                // æ³¨å…¥å…¨å±€æœç´¢å‡½æ•°
                window.searchWithin = (w) => { wordInput.value = w; generateCard(); };

                onMounted(() => {
                    const saved = localStorage.getItem('memori-book'); if(saved) history.value = JSON.parse(saved);
                    const counts = localStorage.getItem('memori-counts'); if(counts) reviewCounts.value = JSON.parse(counts);
                });

                return {
                    showCover, currentLang, mode, wordInput, loading, isFlipped, card, langConfig, timelines,
                    filteredHistory: computed(() => history.value.filter(h => h.lang === currentLang.value)),
                    flowerField: computed(() => {
                        const count = history.value.filter(h => h.lang === currentLang.value).length;
                        const num = Math.min(10, Math.floor(count / 5));
                        return Array.from({length: num}, (_, i) => ({
                            img: `https://pollinations.ai/p/dreamy_ethereal_${langConfig[currentLang.value].plant}_illustration?width=200&height=200&seed=${i}`,
                            name: 'æˆé•¿ä¹‹èŠ±'
                        }));
                    }),
                    treeStage: computed(() => {
                        const count = reviewCounts.value[currentLang.value] || 0;
                        let stage = count > 100 ? 'ancient_cosmic_tree' : count > 50 ? 'magical_glowing_tree' : 'enchanted_sapling';
                        return { status: stage, img: `https://pollinations.ai/p/${stage}_on_ivory_background?width=400&height=400` };
                    }),
                    groupedTimelines: computed(() => {
                        const list = [...timelines.value.asia, ...timelines.value.europe].sort((a,b) => parseInt(a.year) - parseInt(b.year));
                        const groups = {}; list.forEach(e => { if(!groups[e.year]) groups[e.year] = {year: e.year, events: []}; groups[e.year].events.push(e); });
                        return Object.values(groups);
                    }),
                    generateCard, renderExample, 
                    loadWord: (h) => { card.value = h; mode.value = 'card'; isFlipped.value = false; },
                    toggleCollect: () => {
                        card.value.isCollected = !card.value.isCollected;
                        if(card.value.isCollected) history.value.unshift({...card.value, id: Date.now()});
                        else history.value = history.value.filter(h => h.word !== card.value.word);
                        localStorage.setItem('memori-book', JSON.stringify(history.value));
                    },
                    startReview: () => alert("å¤ä¹ è®¡åˆ’å·²ç”Ÿæˆï¼Œè¯·åœ¨å®é™æ—¶åˆ»å¼€å¯ã€‚")
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
