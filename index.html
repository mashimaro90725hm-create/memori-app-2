<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¿†æ – Â· Memori - å­¦æœ¯è¾å…¸ä¸æ–‡æ˜å¹´è¡¨</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- ğŸ® ä¸­å›½è‰²ä¸»é¢˜å˜é‡ (ä¸¥æ ¼ä¿ç•™ [cite: 20-22]) --- */
:root {
  --color-bg-main: #E2E1E4;  --color-text-main: #2D241E; 
  --color-accent: #CB3A56;   --color-accent-hover: #EF7A82; 
  --glass-bg: rgba(255, 253, 248, 0.75);
  --glass-border: rgba(203, 58, 86, 0.15); 
}

* { box-sizing: border-box; }
.app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; position: relative; color: var(--color-text-main); font-family: 'Noto Serif SC', serif; }
.app-container.with-texture::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }

.glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); }

/* ğŸšª å°é¢å±‚çº§é”å®š [cite: 29-41] */
.cover-stage.classic-theme { position: fixed; inset: 0; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; overflow: hidden; }
.cover-overlay-gradient { position: absolute; inset: 0; background: linear-gradient(to right, rgba(45, 36, 30, 0.6) 0%, rgba(45, 36, 30, 0.2) 60%, transparent 100%); }
.cover-content-layout { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
.cover-text-group { flex: 1; color: #f8f4e6; text-align: right; z-index: 101; padding-left: 50px; }
.cover-title-main { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; color: #fff; margin: 0; }
.start-btn-main { margin-top: 60px; padding: 16px 48px; font-size: 1.2rem; background: var(--color-accent); color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: all 0.4s; position: relative; z-index: 110; pointer-events: auto !important; }

/* è€ƒå¤çŒ«å®¹å™¨ */
.cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; justify-content: flex-start; align-items: flex-end; z-index: 1; pointer-events: none; }
.cover-cat-large { max-width: 100%; max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(60, 40, 30, 0.6)); transform: translateX(-10%) scaleX(-1); }

/* ğŸ® ä¾§è¾¹æ æ ·å¼ [cite: 43-58] */
.sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
.word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 10px; border-radius: 16px; cursor: pointer; background: rgba(255, 253, 248, 0.5); }
.word-item.active { background: white; border-left: 4px solid var(--color-accent); box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); font-weight: bold; }

/* ğŸ® å¡ç‰‡ 3D ç¿»è½¬ - å»å›¾ç‰‡åŒ–ç‰ˆ */
.card-3d-wrapper { width: 420px; height: 620px; perspective: 1500px; cursor: pointer; z-index: 2; }
.card-body { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
.card-body.is-flipped { transform: rotateY(180deg); }
.card-face { position: absolute; inset: 0; backface-visibility: hidden; display: flex; flex-direction: column; background: #FFFFFF; border-radius: 30px; border: 1px solid var(--glass-border); padding: 50px; text-align: center; justify-content: center; box-shadow: 0 15px 35px rgba(45, 36, 30, 0.05); }
.card-face.back { transform: rotateY(180deg); background: rgba(255, 253, 248, 0.95); text-align: left; justify-content: flex-start; overflow-y: auto; }

/* å­¦æœ¯æ–‡å­—æ’ç‰ˆ */
.main-word { font-size: 3.8rem; font-family: 'Zen Old Mincho', serif; color: var(--color-text-main); margin-bottom: 15px; }
.divider { height: 1px; background-image: linear-gradient(to right, #D5C9BB 40%, transparent 20%); background-size: 6px 1px; background-repeat: repeat-x; width: 100%; margin: 30px 0; }
.label { font-size: 0.8rem; text-transform: uppercase; color: var(--color-accent); letter-spacing: 1.5px; font-weight: bold; margin-bottom: 12px; display: block; }
.clickable-span { color: var(--color-accent); cursor: help; border-bottom: 1px dashed var(--color-accent); padding: 0 2px; transition: 0.2s; }
.clickable-span:hover { background: rgba(203, 58, 86, 0.1); }

/* æŸ´çŠ¬ä¸çŒ«åŠ©ä½ç½® [cite: 59-74, 188] */
.shiba-mascot { position: absolute; bottom: 100%; right: 0px; width: 135px; height: 135px; cursor: pointer; margin-bottom: 15px; }
.cat-mascot-container { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 280px; cursor: pointer; z-index: 100; transition: transform 0.3s ease; }
.cat-mascot-img { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }

/* å†å²å¹´è¡¨å…¨é‡æ ·å¼ [cite: 151-184] */
.history-stage { width: 95%; height: 90vh; padding: 40px; overflow: hidden; display: flex; flex-direction: column; }
.timeline-wrapper { flex: 1; overflow-y: auto; padding-right: 20px; }
.year-number { font-weight: 800; font-size: 1.3rem; color: var(--color-accent); border: 1px solid var(--glass-border); padding: 4px 10px; border-radius: 8px; background: white; }

.fade-enter-active, .fade-leave-active { transition: opacity 1s ease; }
.fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay-gradient"></div>
                <div class="cover-content-layout">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat-large"></div>
                    <div class="cover-text-group">
                        <h1 class="cover-title-main">Memori</h1>
                        <p class="text-2xl font-serif tracking-[0.3em] mt-4">å¿†æ – Â· è¨€è‘‰ã®è€ƒå¤å­¦</p>
                        <div class="mt-12 text-xl font-serif leading-loose opacity-80">
                            <p>æ™‚ã®ç ‚ã«åŸ‹ã‚‚ã‚ŒãŸã€</p>
                            <p>è¨€è‘‰ã®æ¬ ç‰‡ã‚’æ¢ã—ã¦ã€‚</p>
                        </div>
                        <button class="start-btn-main font-bold" @click="enterApp">å¼€å¯å­¦æœ¯æ¢ç´¢</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container with-texture" :style="{ background: langConfig[currentLang].bg }">
            
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header border-b border-pink-100 pb-4 mb-4">
                    <h3 class="font-bold flex justify-between" :style="{ color: langConfig[currentLang].accent }">
                        <span>{{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }}</span>
                        <span class="text-xs opacity-50">{{ filteredHistory.length }} è¯</span>
                    </h3>
                </div>
                <div class="word-list flex-1 overflow-y-auto pr-2 custom-scroll mt-4">
                    <div v-for="item in filteredHistory" :key="item.id" class="word-item group" :class="{ 'active': mode === 'card' && item.id === card.id }" @click="loadWord(item)">
                        <span class="truncate">{{ item.word }}</span>
                        <button class="opacity-0 group-hover:opacity-100 text-red-400 font-bold px-2" @click.stop="deleteWord(item.id)">Ã—</button>
                    </div>
                </div>
                <div class="sidebar-footer mt-4 pt-4 border-t border-pink-100 flex flex-col gap-3 relative">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="w-full">
                        <div v-if="neroState === 'thinking'" class="absolute -top-10 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-lg shadow text-xs font-bold">è€ƒæ®ä¸­...</div>
                    </div>
                    <button class="action-btn bg-[#CB3A56] text-white py-3 rounded-xl font-bold artistic-btn" @click="startReview">å¤ä¹ è®¡åˆ’</button>
                    <button class="action-btn border border-pink-200 py-3 rounded-xl artistic-btn" @click="mode = 'history'">æ–‡æ˜å¹´è¡¨</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism flex items-center px-6 py-3 mb-8 w-full max-w-[600px]">
                    <div class="flex gap-2 mr-4">
                        <button v-for="(cfg, key) in langConfig" :key="key" @click="switchLang(key)" class="lang-pill" :class="{ 'active': currentLang === key }">{{ cfg.flag }}</button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="generateCard" :placeholder="`åœ¨${langConfig[currentLang].name}ä¸­å¯»å›æ–‡æ˜ç¢ç‰‡...`" class="bg-transparent outline-none flex-1 text-xl">
                    <button @click="generateCard" class="text-2xl text-[#CB3A56]"><i v-if="loading" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <Transition name="fade-mode" mode="out-in">
                    <div v-if="mode === 'card'" class="card-3d-wrapper" @click="isFlipped = !isFlipped">
                        <div class="card-body" :class="{ 'is-flipped': isFlipped }">
                            <div class="card-face front glass-morphism">
                                <span class="text-sm tracking-widest text-[#CB3A56] mb-2">{{ card.reading }}</span>
                                <h2 class="main-word">{{ card.word }}</h2>
                                <div class="divider"></div>
                                <div class="text-xl leading-relaxed text-justify px-4" v-html="card.meaning"></div>
                                <div class="mt-12 text-[10px] opacity-20 italic">ç‚¹å‡»å¡ç‰‡ä»»æ„ä½ç½®æŸ¥é˜…æ·±å±‚è¯­æº</div>
                            </div>
                            <div class="card-face back glass-morphism" @click.stop>
                                <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                                    <div class="mb-8">
                                        <span class="label">è¯­æºè€ƒè¯ / ETYMOLOGY</span>
                                        <div class="text-sm leading-relaxed text-justify text-[#444]" v-html="card.etymology"></div>
                                    </div>
                                    <div v-if="card.examples && card.examples.length">
                                        <span class="label">æ–‡çŒ®ä¾‹è¯ / EXAMPLES</span>
                                        <div v-for="(ex, i) in card.examples" :key="i" class="mb-6 border-l-2 border-[#CB3A56]/20 pl-4">
                                            <p class="text-sm italic mb-2 leading-relaxed" v-html="renderExample(ex.text)"></p>
                                            <p class="text-xs text-gray-400 font-sans">{{ ex.cn }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-auto flex gap-3 p-4">
                                    <button class="flex-1 bg-[#CB3A56] text-white py-3 rounded-xl font-bold" @click="toggleCollect">{{ card.isCollected ? 'å·²å­˜å…¥æ–‡çŒ®åº“' : 'å­˜å…¥è¾å…¸' }}</button>
                                    <button class="w-14 bg-[#F0EAE1] rounded-xl text-[#CB3A56]" @click="speak(card.word)"><i class="fa-solid fa-volume-high"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'history'" class="history-stage glass-morphism" key="history">
                        <div class="flex justify-between items-center mb-8 border-b border-pink-100 pb-4">
                            <h1 class="text-3xl font-serif font-bold text-[#CB3A56]">æ–‡æ˜å¤§äº‹å¹´è¡¨</h1>
                            <div class="flex gap-4">
                                <button class="text-sm font-bold" :class="historyTab === 'asia' ? 'text-[#CB3A56]' : 'opacity-40'" @click="historyTab = 'asia'">ğŸŒ äºšæ´²</button>
                                <button class="text-sm font-bold" :class="historyTab === 'europe' ? 'text-[#CB3A56]' : 'opacity-40'" @click="historyTab = 'europe'">ğŸ›ï¸ æ¬§æ´²</button>
                                <button class="ml-4 text-2xl text-gray-300" @click="mode = 'card'"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                        <div class="timeline-wrapper custom-scroll">
                            <div v-for="group in groupedTimelines" :key="group.year" class="flex gap-8 mb-10 relative">
                                <div class="w-24 text-right pt-2 sticky top-0"><span class="year-number">{{ group.year }}</span></div>
                                <div class="flex-1 flex flex-col gap-4">
                                    <div v-for="item in group.events" :key="item.id" class="p-5 bg-white/90 rounded-2xl border border-pink-100 relative group">
                                        <div class="flex items-center gap-4">
                                            <span class="text-2xl">{{ item.tag }}</span>
                                            <span class="text-lg font-serif flex-1">{{ item.event }}</span>
                                            <button @click="deleteTimelineEvent(item.id)" class="opacity-0 group-hover:opacity-100 text-red-300 hover:text-red-500 font-bold px-2">Ã—</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </Transition>
            </main>

            <div v-if="mode !== 'history'" class="cat-mascot-container" @click="pokeMascot" @dblclick="triggerMascotInput">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" class="hidden" accept="image/*">
                <div class="cat-img-wrapper"><img :src="userCat" class="cat-mascot-img" :class="neroState === 'thinking' ? 'thinking-anim' : 'idle-anim'"></div>
                <div v-if="neroState === 'thinking'" class="absolute -top-10 left-1/2 -translate-x-1/2 bg-white px-4 py-2 rounded-full font-bold shadow-lg animate-bounce text-sm">æ–‡çŒ®æŒ–æ˜ä¸­...</div>
                <div v-if="neroState === 'happy'" class="absolute -top-10 left-1/2 -translate-x-1/2 bg-white px-4 py-2 rounded-full font-bold shadow-lg text-sm text-[#CB3A56]">å–µ~âœ¨</div>
            </div>

            <div v-if="flowerField.length > 0" class="fixed bottom-10 left-10 flex gap-2 bg-white/40 p-3 rounded-full border border-white/60">
                <img v-for="(f, i) in flowerField" :key="i" :src="f.img" class="w-10 h-10 rounded-full border-2 border-white shadow-lg animate-pulse">
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        createApp({
            setup() {
                const showCover = ref(true); const currentLang = ref('jp'); const mode = ref('card');
                const wordInput = ref(''); const loading = ref(false); const isFlipped = ref(false);
                const history = ref([]); const neroState = ref('idle'); const historyTab = ref('asia');
                const userCat = ref(localStorage.getItem('memori-user-cat') || './my-cat.png'); const mascotInput = ref(null);
                const reviewCounts = ref(JSON.parse(localStorage.getItem('memori-review-counts') || '{}'));
                const card = ref({ word: 'å¿†æ – Â· Memori', reading: 'MEMORI', meaning: 'è·¨å­¦ç§‘æ·±åº¦å­¦æœ¯è€ƒè¯ç³»ç»Ÿå·²å°±ç»ªã€‚', etymology: 'â€œå¿†â€å³è®°å¿†ï¼Œâ€œæ –â€å³å±…æ‰€ï¼Œæ—¨åœ¨ä¸ºæ¼‚æ³Šçš„æ–‡æ˜è¯æ±‡å¯»æ‰¾ä¸€å¤„çµé­‚æ –æ¯åœ°ã€‚', examples: [] });

                const shibaImages = { idle: './shiba/idle.gif', thinking: './shiba/run.gif', happy: './shiba/happy.gif' };
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };

                const langConfig = {
                    jp: { name: 'æ—¥è¯­', flag: 'ğŸ‡¯ğŸ‡µ', voice: 'ja-JP', bg: 'linear-gradient(to top, #F9F1F0, #FCEFE8)', accent: '#CB3A56', plant: 'cherry blossom' },
                    zh: { name: 'æ±‰è¯­', flag: 'ğŸ‡¨ğŸ‡³', voice: 'zh-CN', bg: 'linear-gradient(120deg, #FBF8F1, #F6F4EF)', accent: '#9D2933', plant: 'peony flower' },
                    lzh: { name: 'å¤æ±‰è¯­', flag: 'ğŸ“œ', voice: 'zh-CN', bg: '#F4F5F0', accent: '#41555D', plant: 'lotus flower' },
                    en: { name: 'è‹±è¯­', flag: 'ğŸ‡¬ğŸ‡§', voice: 'en-US', bg: '#EDF1F4', accent: '#1772B4', plant: 'english rose' },
                    cjp: { name: 'å¤å…¸æ—¥è¯­', flag: 'ğŸ¯', voice: 'ja-JP', bg: '#F2EFE8', accent: '#5A3D30', plant: 'bonsai pine' },
                    kr: { name: 'éŸ©è¯­', flag: 'ğŸ‡°ğŸ‡·', voice: 'ko-KR', bg: '#F9EDF1', accent: '#B25D7E', plant: 'hibiscus flower' },
                    de: { name: 'å¾·è¯­', flag: 'ğŸ‡©ğŸ‡ª', voice: 'de-DE', bg: '#EFF2F1', accent: '#374E59', plant: 'oak tree' },
                    it: { name: 'æ„è¯­', flag: 'ğŸ‡®ğŸ‡¹', voice: 'it-IT', bg: '#FAF6EE', accent: '#8E4932', plant: 'lemon tree' },
                    lat: { name: 'æ‹‰ä¸è¯­', flag: 'ğŸ›ï¸', voice: 'it-IT', bg: '#F0EEEC', accent: '#605A54', plant: 'olive tree' }
                };

                const timelines = ref({
                    asia: [
                        { id: 1, year: '645', tag: 'ğŸ“œ', event: 'å¤§åŒ–æ”¹æ–°ï¼šæ—¥æœ¬æ•ˆä»¿å”åˆ¶ï¼Œç¡®ç«‹å¾‹ä»¤åˆ¶å›½å®¶æ ¹åŸºã€‚' },
                        { id: 2, year: '1008', tag: 'ğŸ–‹ï¸', event: 'ã€Šæºæ°ç‰©è¯­ã€‹æˆä¹¦ï¼Œå¼€å¯å¹³å®‰æ—¶ä»£å¥³æ€§æ–‡å­¦å·…å³°ã€‚' },
                        { id: 3, year: '1443', tag: 'ğŸ”¤', event: 'è®­æ°‘æ­£éŸ³ï¼šä¸–å®—å¤§ç‹åˆ›ç«‹è°šæ–‡ï¼Œä½¿éŸ©è¯­æ‹¥æœ‰ç‹¬ç«‹æ–‡å­—ç³»ç»Ÿã€‚' },
                        { id: 4, year: '1151', tag: 'ğŸº', event: 'æ±çª‘åˆ›çƒ§ï¼šåŒ—å®‹å®˜çª‘é’ç“·å®¡ç¾è¾¾åˆ°â€œé›¨è¿‡å¤©æ™´â€çš„æè‡´ã€‚' },
                        { id: 5, year: '1603', tag: 'ğŸ­', event: 'å¾·å·å¹•åºœå»ºç«‹ï¼Œæ±Ÿæˆ·æ—¶ä»£åº¶æ°‘æ–‡åŒ–èŒå‘ã€‚' },
                        { id: 6, year: '1868', tag: 'ğŸš¢', event: 'æ˜æ²»ç»´æ–°ï¼šæ—¥æœ¬å¼€å¯è„±äºšå…¥æ¬§è¿›ç¨‹ï¼Œæ–‡æ˜å¼€åŒ–ã€‚' },
                        { id: 7, year: '1905', tag: 'ğŸ“', event: 'ä¸­å›½åºŸé™¤ç§‘ä¸¾ï¼šå»¶ç»­ä¸€åƒä¸‰ç™¾å¹´çš„é€‰å®˜åˆ¶åº¦èµ°å‘ç»ˆç»“ã€‚' },
                        { id: 8, year: '1592', tag: 'ğŸ¢', event: 'é—²å±±å²›å¤§æ·ï¼šæèˆœè‡£ç‡é¾Ÿèˆ¹æŠµå¾¡å…¥ä¾µï¼Œæ”¹å†™ä¸œäºšæµ·æˆ˜å²ã€‚' },
                        { id: 9, year: '804', tag: 'ğŸµ', event: 'ç©ºæµ·èµ´å”ï¼šæœ€æ¾„ã€ç©ºæµ·å°†å¯†æ•™ä¸èŒ¶æ–‡åŒ–å¸¦å›æ—¥æœ¬ã€‚' },
                        { id: 10, year: '1928', tag: 'â›ï¸', event: 'æ®·å¢Ÿå‘æ˜ï¼šç°ä»£è€ƒå¤å­¦æ­£å¼æ‹‰å¼€ä¸­å›½æ–‡æ˜èµ·æºæ¢ç©¶åºå¹•ã€‚' }
                    ],
                    europe: [
                        { id: 11, year: '1453', tag: 'âš”ï¸', event: 'å›å£«å¦ä¸å ¡é™·è½ï¼šä¸œç½—é©¬å¸å›½ç­äº¡ï¼Œå­¦è€…è¥¿è¿å¼•å‘æ–‡è‰ºå¤å…´ã€‚' },
                        { id: 12, year: '1517', tag: 'â›ª', event: 'é©¬ä¸Â·è·¯å¾·å‘è¡¨ã€Šä¹åäº”æ¡è®ºçº²ã€‹ï¼Œæ‹‰å¼€å®—æ•™æ”¹é©åºå¹•ã€‚' },
                        { id: 13, year: '1687', tag: 'ğŸ', event: 'ç‰›é¡¿å‡ºç‰ˆã€Šè‡ªç„¶å“²å­¦çš„æ•°å­¦åŸç†ã€‹ï¼Œç¡®ç«‹ç»å…¸åŠ›å­¦ä½“ç³»ã€‚' },
                        { id: 14, year: '1789', tag: 'ğŸ•Šï¸', event: 'æ³•å›½å¤§é©å‘½ï¼šäººæƒå®£è¨€å‘å¸ƒï¼Œæ¬§æ´²å›ä¸»åˆ¶åŠ¨æ‘‡ã€‚' },
                        { id: 15, year: '1347', tag: 'ğŸŒ‘', event: 'é»‘æ­»ç—…å¤§æµè¡Œï¼šæ¬§æ´²äººå£é”å‡ï¼Œå®¢è§‚ä¿ƒä½¿å°å»ºåˆ¶ç“¦è§£ã€‚' },
                        { id: 16, year: '1859', tag: 'ğŸ§¬', event: 'è¾¾å°”æ–‡å‡ºç‰ˆã€Šç‰©ç§èµ·æºã€‹ï¼Œç”Ÿç‰©å­¦è¿›å…¥è¿›åŒ–è®ºæ—¶ä»£ã€‚' },
                        { id: 17, year: '1919', tag: 'ğŸ¨', event: 'åŒ…è±ªæ–¯å­¦é™¢åˆ›ç«‹ï¼šç°ä»£ä¸»ä¹‰è®¾è®¡ç†å¿µå½±å“å…¨çƒã€‚' },
                        { id: 18, year: '1492', tag: 'â›µ', event: 'åœ°ç†å¤§å‘ç°ï¼šå“¥ä¼¦å¸ƒåˆ°è¾¾ç¾æ´²ï¼Œå…¨çƒè´¸æ˜“ç½‘ç»œåˆæ­¥æˆå‹ã€‚' },
                        { id: 19, year: '1755', tag: 'ğŸ›ï¸', event: 'é‡Œæ–¯æœ¬å¤§åœ°éœ‡ï¼šå¼•å‘å¯è’™è¿åŠ¨å¯¹ä¹è§‚ä¸»ä¹‰çš„æ·±åˆ»åæ€ã€‚' },
                        { id: 20, year: '1215', tag: 'ğŸ“œ', event: 'ã€Šå¤§å®ªç« ã€‹ç­¾ç½²ï¼šè‹±å›½ç¡®ç«‹â€œç‹åœ¨æ³•ä¸‹â€çš„å®ªæ”¿ä¼ ç»Ÿã€‚' }
                    ]
                });

                function renderExample(text) {
                    if(!text) return '';
                    if(['jp','zh','kr','lzh','cjp'].includes(currentLang.value)) {
                        return text.replace(/<span>(.*?)<\/span>/g, '<span class="clickable-span" onclick="window.searchWithin(\'$1\')">$1</span>');
                    }
                    return text.split(' ').map(w => `<span class="clickable-span" onclick="window.searchWithin('${w.replace(/[.,!?;:()]/g, '')}')">${w}</span>`).join(' ');
                }
                window.searchWithin = (w) => { if(w.length < 1) return; wordInput.value = w; generateCard(); };

                async function generateCard() {
                    if (!wordInput.value) return;
                    loading.value = true; neroState.value = 'thinking'; isFlipped.value = false; mode.value = 'card';
                    try {
                        const res = await fetch('/api/openai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ word: wordInput.value, lang: currentLang.value }) });
                        const data = await res.json();
                        card.value = { ...data, lang: currentLang.value, isCollected: history.value.some(h => h.word === data.word && h.lang === currentLang.value) };
                        speak(card.value.word); neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 2500); wordInput.value = '';
                    } catch (e) { alert('æ–‡çŒ®è€ƒæ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯è¿æ¥ã€‚'); } finally { loading.value = false; }
                }

                function speak(t) { window.speechSynthesis.cancel(); const ut = new SpeechSynthesisUtterance(t); ut.lang = langConfig[currentLang.value].voice; ut.rate = 0.85; window.speechSynthesis.speak(ut); }
                function pokeMascot() { neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 1500); }
                function triggerMascotInput() { mascotInput.value.click(); }
                function handleMascotUpload(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { userCat.value = ev.target.result; localStorage.setItem('memori-user-cat', ev.target.result); }; reader.readAsDataURL(file); } }

                onMounted(() => {
                    const savedBook = localStorage.getItem('memori-book'); if (savedBook) history.value = JSON.parse(savedBook);
                    const savedTimeline = localStorage.getItem('memori-timelines-v19'); if (savedTimeline) timelines.value = JSON.parse(savedTimeline);
                });

                return {
                    showCover, enterApp: () => showCover.value = false, currentLang, wordInput, loading, neroState, history, mode, isFlipped, userCat, shibaImages, coverImages, card, langConfig, timelines, historyTab, mascotInput,
                    generateCard, renderExample, speak, pokeMascot, triggerMascotInput, handleMascotUpload,
                    switchLang: (l) => { currentLang.value = l; mode.value = 'card'; },
                    loadWord: (h) => { card.value = h; mode.value = 'card'; isFlipped.value = false; },
                    deleteWord: (id) => { history.value = history.value.filter(h => h.id !== id); localStorage.setItem('memori-book', JSON.stringify(history.value)); },
                    toggleCollect: () => {
                        const idx = history.value.findIndex(h => h.word === card.value.word && h.lang === card.value.lang);
                        if (idx !== -1) { history.value.splice(idx, 1); card.value.isCollected = false; }
                        else { card.value.isCollected = true; history.value.unshift({ ...card.value, id: Date.now() }); }
                        localStorage.setItem('memori-book', JSON.stringify(history.value));
                    },
                    startReview: () => alert("å¤ä¹ è®¡åˆ’å·²ç”Ÿæˆï¼Œè¯·åœ¨å®é™æ—¶åˆ»å¼€å¯ã€‚"),
                    filteredHistory: computed(() => history.value.filter(h => (h.lang || 'jp') === currentLang.value)),
                    flowerField: computed(() => {
                        const count = Math.floor(history.value.filter(h => (h.lang || 'jp') === currentLang.value).length / 50);
                        return Array.from({ length: count }, (_, i) => ({ img: `https://pollinations.ai/p/ethereal_dreamy_${langConfig[currentLang.value].plant}_botanical_illustration?width=200&height=200&seed=${i}` }));
                    }),
                    groupedTimelines: computed(() => {
                        const list = [...timelines.value[historyTab.value]].sort((a, b) => parseInt(a.year) - parseInt(b.year));
                        const groups = {}; list.forEach(e => { if (!groups[e.year]) groups[e.year] = { year: e.year, events: [] }; groups[e.year].events.push(e); });
                        return Object.values(groups);
                    })
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
