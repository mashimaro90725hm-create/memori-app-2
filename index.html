<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memori - Ë®ÄÂè∂„ÅÆËÄÉÂè§Â≠¶</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- üèÆ ÂøÜÊ†ñ‰∏ªÈ¢òÁ≥ªÁªü V4.0 (Á∫ØÂáÄÊñáÂ≠óÁâà) --- */
:root {
  --color-bg-main: #E2E1E4;
  --color-text-main: #2D241E;
  --color-accent: #CB3A56;
  --color-accent-hover: #EF7A82;
  --glass-bg: rgba(255, 253, 248, 0.9);
  --glass-border: rgba(203, 58, 86, 0.15);
}

* { box-sizing: border-box; }
.app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.8s ease, font-family 0.3s; position: relative; color: var(--color-text-main); }
.app-container.with-texture::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }
.glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(110%); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px -1px rgba(45, 36, 30, 0.08); border-radius: 24px; }
.artistic-border { border-radius: 24px; }

/* Â∞ÅÈù¢È°µ */
.cover-stage.classic-theme { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; overflow: hidden; }
.cover-overlay-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(45, 36, 30, 0.6) 0%, rgba(45, 36, 30, 0.2) 60%, transparent 100%); }
.cover-content-layout { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
.cover-text-group.jp-style { flex: 1; color: #f8f4e6; text-shadow: 0 2px 10px rgba(0,0,0,0.6); padding-left: 50px; text-align: right; z-index: 50; }
.cover-title-main { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; margin: 0; letter-spacing: 0.05em; color: #fff; }
.subtitle-main { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; letter-spacing: 0.3em; margin-top: 15px; opacity: 0.95; color: var(--color-bg-main); }
.start-btn-main.jp-btn { margin-top: 60px; font-family: 'Noto Serif JP', serif; padding: 16px 48px; font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent) 0%, #A62C45 100%); color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: all 0.4s; letter-spacing: 0.1em; box-shadow: 0 4px 20px rgba(203, 58, 86, 0.4); pointer-events: auto; position: relative; z-index: 100; }
.cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; justify-content: flex-start; align-items: flex-end; z-index: 1; pointer-events: none; }
.cover-cat-large { max-width: 100%; max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(60, 40, 30, 0.6)); transform: translateX(-10%) scaleX(-1); }
.fade-enter-active, .fade-leave-active { transition: opacity 1s ease; }
.fade-enter-from, .fade-leave-to { opacity: 0; }

/* Sidebar */
.sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
.sidebar-header { padding: 0 10px 16px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
.sidebar-header h3 { font-size: 1.2rem; font-weight: bold; margin: 0; font-family: inherit; }
.import-trigger { font-size: 0.8rem; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
.word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
.word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 10px; border-radius: 16px; cursor: pointer; transition: all 0.2s; color: var(--color-text-main); border-left: 4px solid transparent; position: relative; background: rgba(255, 253, 248, 0.5); }
.word-item.active { background: white; box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); font-weight: bold; color: var(--color-text-main); }
.item-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; position: absolute; right: 12px; }
.word-item:hover .item-actions { opacity: 1; }
.del-icon { opacity: 0.8; border: none; background: none; color: var(--color-accent); cursor: pointer; font-weight: bold; }
.sidebar-footer { padding-top: 25px; display: flex; flex-direction: column; gap: 12px; position: relative; border-top: 1px solid var(--glass-border); }
.action-btn { width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 12px; font-weight: bold; cursor: pointer; background: rgba(255, 253, 248, 0.6); transition: all 0.2s; text-align: center; }
.action-btn.primary { background: var(--color-accent); color: white; border: none; }
.action-btn:hover { transform: translateY(-2px); }

/* Mascots */
.shiba-mascot { position: absolute; bottom: 100%; right: 0px; width: 120px; height: 120px; cursor: pointer; z-index: 20; margin-bottom: 15px; }
.shiba-img { width: 100%; height: 100%; object-fit: contain; }
.cat-mascot-container { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 280px; cursor: pointer; z-index: 100; pointer-events: auto; }
.cat-mascot-img { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }

/* Main Stage */
.main-stage { flex: 1; position: relative; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
.search-bar { margin: 0 20px 25px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
.lang-pills { display: flex; gap: 8px; }
.lang-pill { padding: 5px 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255, 253, 248, 0.5); cursor: pointer; transition: all 0.3s; }
.lang-pill.active { background: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); font-weight: bold; color: var(--color-accent); }
.search-input { border: none; background: transparent; padding: 10px; flex: 1; margin: 0 20px; outline: none; font-size: 1.1rem; font-family: inherit; color: var(--color-text-main); }
.search-btn { border: none; background: transparent; cursor: pointer; font-size: 1.2rem; }

/* Card 3D - Á∫ØÊñáÂ≠óÁâà */
.content-area { flex: 1; display: flex; justify-content: center; align-items: center; }
.card-3d-wrapper { width: 450px; height: 650px; perspective: 1500px; cursor: pointer; z-index: 2; margin: 0 auto; }
.card-body { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
.card-body.is-flipped { transform: rotateY(180deg); }
.card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; overflow: hidden; display: flex; flex-direction: column; background: #fffdf9; border-radius: 24px; }
.card-face.front { background-image: radial-gradient(#E2E1E4 1px, transparent 1px); background-size: 20px 20px; } 

/* ÊñáÂ≠óÂç°ÁâáÊ†∏ÂøÉÊ†∑Âºè */
.text-card-content { flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; }
.main-word { font-size: 4rem; margin: 20px 0; font-family: 'Zen Old Mincho', serif; color: var(--color-text-main); line-height: 1.1; letter-spacing: -0.02em; }
.pronunciation { font-size: 1.4rem; color: var(--color-accent); opacity: 0.8; font-family: sans-serif; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
.meaning-text { font-size: 1.2rem; line-height: 1.8; opacity: 0.9; max-width: 90%; }
.meta-info { margin-top: 30px; display: flex; gap: 10px; }
.meta-tag { padding: 5px 12px; background: rgba(0,0,0,0.05); border-radius: 20px; font-size: 0.8rem; color: #666; }
.overlay-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
.icon-btn { width: 40px; height: 40px; border-radius: 50%; background: white; border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
.icon-btn:hover { transform: scale(1.1); color: var(--color-accent); }
.star-btn i.starred { color: var(--color-accent); }

/* ËÉåÈù¢ */
.card-face.back { transform: rotateY(180deg); background: rgba(255, 253, 248, 0.98); }
.back-scroll { padding: 40px; overflow-y: auto; height: 100%; text-align: left; }
.section-title { font-size: 0.9rem; font-weight: bold; color: var(--color-accent); margin: 30px 0 15px; border-bottom: 1px dashed rgba(203,58,86,0.2); padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
.etymology-text { font-size: 1.05rem; line-height: 1.9; text-align: justify; color: #444; font-family: sans-serif; }
.example-box { margin-bottom: 15px; padding: 15px; background: rgba(45,36,30,0.03); border-radius: 8px; border-left: 3px solid var(--color-accent); }
.ex-origin { font-family: 'Noto Serif SC', serif; font-size: 1.1rem; margin-bottom: 5px; color: var(--color-text-main); }
.ex-trans { font-size: 0.9rem; opacity: 0.7; }

/* Timeline (ÊÅ¢Â§çËá™ÂÆö‰πâËÆæÁΩÆ) */
.history-stage { flex: 1; margin: 0 20px 20px; padding: 30px; display: flex; flex-direction: column; overflow: hidden; }
.history-top { flex-shrink:0; border-bottom: 1px solid var(--glass-border); padding-bottom: 20px; margin-bottom: 20px; }
.history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.history-tabs button { background: none; border: none; font-size: 1.1rem; cursor: pointer; opacity: 0.6; padding: 0 10px; }
.history-tabs button.active { opacity: 1; font-weight: bold; color: var(--color-accent); }
/* ËæìÂÖ•Èù¢Êùø */
.timeline-input-group { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; border: 1px solid var(--glass-border); display: flex; gap: 10px; align-items: center; margin-top: 15px; }
.t-input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd; background: rgba(255,255,255,0.8); }
.t-btn { padding: 8px 15px; background: var(--color-accent); color: white; border-radius: 6px; font-weight: bold; cursor: pointer; }

.timeline-wrapper { flex: 1; overflow-y: auto; padding-right: 10px; }
.timeline-list { position: relative; padding-left: 20px; }
.timeline-spine { position: absolute; left: 80px; top: 0; bottom: 0; width: 2px; background: var(--color-accent); opacity: 0.3; }
.year-group { display: flex; margin-bottom: 25px; }
.t-year-label { width: 80px; text-align: right; padding-right: 20px; font-weight: bold; color: var(--color-text-main); font-family: sans-serif; }
.t-content { flex: 1; background: rgba(255,255,255,0.6); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); position: relative; cursor: pointer; transition: all 0.2s; }
.t-content:hover { background: white; transform: translateX(5px); }
.t-dot { position: absolute; left: -25px; top: 15px; width: 12px; height: 12px; border-radius: 50%; background: var(--color-accent); border: 2px solid #fff; }
.t-del { position: absolute; right: 10px; top: 10px; color: #aaa; cursor: pointer; display: none; }
.t-content:hover .t-del { display: block; }

/* Review Mode */
.review-card-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
.review-card { width: 500px; height: 300px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-family: 'Zen Old Mincho'; position: relative; margin-bottom: 30px; }
.review-answer { margin-top: 20px; width: 500px; text-align: center; }
.srs-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
.srs-btn { padding: 10px 25px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
.srs-btn:active { transform: scale(0.95); }

/* Ê®°ÊÄÅÊ°Ü */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.modal-box { background: white; width: 450px; padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }

/* ‰∫§‰∫íÂºèÊ†áËÆ∞ */
.interactive-word { border-bottom: 1px dashed var(--color-accent); cursor: pointer; }
.interactive-word:hover { background: rgba(203, 58, 86, 0.1); }

/* ÊªöÂä®Êù° */
.custom-scroll::-webkit-scrollbar { width: 5px; }
.custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
.fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
.fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay-gradient"></div>
                <div class="cover-content-layout">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat-large" alt="Cover Cat"></div>
                    <div class="cover-text-group jp-style">
                        <h1 class="cover-title-main">Memori</h1>
                        <p class="subtitle-main">Ë®ÄËëâ„ÅÆËÄÉÂè§Â≠¶</p>
                        <button class="start-btn-main jp-btn" @click="enterApp">Êé¢Á¥¢„ÇíÂßã„ÇÅ„Çã</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container" :style="{ background: langConfig[currentLang].bg, fontFamily: langConfig[currentLang].font }">
            
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header">
                    <h3>{{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }}</h3>
                    <span class="import-trigger" @click="showImportModal = true" title="ÂØºÂÖ•ËæûÂÖ∏"><i class="fa-solid fa-file-import"></i></span>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" 
                         class="word-item" 
                         :class="{ 'active': mode === 'card' && card && item.id === card.id }"
                         @click="loadWord(item)">
                        <span>{{ item.word }}</span>
                        <div class="item-actions"><button class="del-icon" @click.stop="deleteWord(item.id)">√ó</button></div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="shiba-img" alt="Shiba">
                    </div>
                    <button class="action-btn" @click="startReview" title="Â§ç‰π†"><i class="fa-solid fa-layer-group"></i> Â§ç‰π†ÂçïËØç</button>
                    <button class="action-btn" @click="mode = 'gallery'" title="ÂçïËØçÊú¨"><i class="fa-solid fa-book"></i> ÂçïËØçÊú¨</button>
                    <button class="action-btn" @click="mode = 'history'" title="ÂéÜÂè≤Âπ¥Ë°®"><i class="fa-solid fa-clock-rotate-left"></i> ÂéÜÂè≤Âπ¥Ë°®</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism artistic-border">
                    <div class="lang-pills">
                        <button v-for="(cfg, key) in langConfig" :key="key" 
                                class="lang-pill" 
                                :class="{ 'active': currentLang === key }" 
                                @click="switchLang(key)">
                            {{ cfg.flag }}
                        </button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="handleSearch" 
                           :placeholder="`Âú®${langConfig[currentLang].name}‰∏≠ËÄÉÊçÆ (ÊîØÊåÅ‰∏≠Â§ñ‰∫íÊü•)...`" 
                           class="search-input">
                    <button @click="handleSearch" class="search-btn">
                        <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                        <i v-else class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <div class="content-area">
                    <div v-if="mode === 'card' && card" class="card-3d-wrapper" @click="isFlipped = !isFlipped">
                        <div class="card-body" :class="{ 'is-flipped': isFlipped }">
                            <div class="card-face front glass-morphism artistic-border">
                                <div class="overlay-actions" @click.stop>
                                    <button class="icon-btn star-btn" @click.stop="toggleCollect" :title="card.isCollected ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Âä†ÂÖ•ÂçïËØçÊú¨'"><i class="fa-solid fa-star" :class="{ 'starred': card.isCollected }"></i></button>
                                </div>
                                <div class="text-card-content">
                                    <h1 class="main-word">{{ card.word }}</h1>
                                    <div class="pronunciation">
                                        <span>/ {{ card.reading }} /</span>
                                        <button class="icon-btn" @click.stop="speak(card.word, card.lang)"><i class="fa-solid fa-volume-high"></i></button>
                                    </div>
                                    <p class="meaning-text" v-html="formatInteractiveText(card.meaning)"></p>
                                    <div class="meta-info">
                                        <span class="meta-tag" v-if="card.word_details">{{ card.word_details }}</span>
                                        <span class="meta-tag" v-if="card.isLocal">Êú¨Âú∞ÁèçËóè</span>
                                    </div>
                                </div>
                                <div style="padding:10px; text-align:center; opacity:0.5; font-size:0.8rem;">ÁÇπÂáªÊü•Áúã„ÄêËØçÊ∫ê‰∏é‰æãÂè•„Äë</div>
                            </div>
                            <div class="card-face back glass-morphism artistic-border">
                                <div class="back-header" @click.stop><h3>{{ card.word }}</h3><div class="back-actions"><button class="icon-btn" @click.stop="isFlipped = !isFlipped"><i class="fa-solid fa-rotate-left"></i></button></div></div>
                                <div class="back-scroll custom-scroll" @click.stop>
                                    <div class="section-title">üóùÔ∏è ËØçÊ∫êËÄÉÊçÆ (Wikipedia-Style)</div>
                                    <div class="etymology-text" v-html="formatInteractiveText(card.etymology || 'Ê≠£Âú®‰ªé‰∫ëÁ´ØÂèëÊéòÂéÜÂè≤Âú∞Â±Ç...')"></div>
                                    
                                    <div class="section-title">üìú ÂÖ∏Á±ç‰æãÂè•</div>
                                    <div v-if="card.examples && card.examples.length">
                                        <div v-for="(ex, i) in card.examples" :key="i" class="example-box">
                                            <div class="ex-origin" @click.stop="speak(ex.text, card.lang)">
                                                <span v-html="formatInteractiveText(ex.text)"></span> üîä
                                            </div>
                                            <div class="ex-trans">{{ ex.cn }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'gallery'" class="gallery-mode custom-scroll" style="width:100%; height:100%; padding:20px;">
                        <h2 style="font-size:2rem; margin-bottom:20px; font-family:'Zen Old Mincho'">ÂçïËØçÊú¨ ({{ filteredHistory.length }})</h2>
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;">
                            <div v-for="item in filteredHistory" :key="item.id" class="glass-morphism" style="padding:20px; cursor:pointer; position:relative;" @click="loadWord(item)">
                                <h3 style="font-size:1.5rem; font-weight:bold;">{{ item.word }}</h3>
                                <p style="opacity:0.6;">{{ item.reading }}</p>
                                <button @click.stop="deleteWord(item.id)" style="position:absolute; top:10px; right:10px; opacity:0.5; background:none; border:none; cursor:pointer;">√ó</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'review'" class="review-card-wrapper">
                        <div v-if="reviewQueue.length > 0">
                            <div class="review-card glass-morphism">
                                {{ reviewCard.word }}
                            </div>
                            <div v-if="!showReviewAnswer" style="text-align:center;">
                                <button class="action-btn primary" @click="showReviewAnswer = true">Êü•ÁúãÈáä‰πâ</button>
                            </div>
                            <div v-else class="review-answer glass-morphism" style="padding:20px;">
                                <p style="font-size:1.2rem; margin-bottom:10px;">{{ reviewCard.reading }}</p>
                                <p>{{ reviewCard.meaning }}</p>
                                <div class="srs-btns">
                                    <button class="srs-btn" style="background:#CB3A56" @click="handleSRS(1)">Âøò (1Â§©)</button>
                                    <button class="srs-btn" style="background:#F28E16" @click="handleSRS(2)">Èöæ (3Â§©)</button>
                                    <button class="srs-btn" style="background:#8FAB1D" @click="handleSRS(3)">‰∏≠ (7Â§©)</button>
                                    <button class="srs-btn" style="background:#2C9678" @click="handleSRS(4)">Êòì (15Â§©)</button>
                                </div>
                            </div>
                        </div>
                        <div v-else style="text-align:center; opacity:0.6;">
                            <i class="fa-solid fa-mug-hot fa-3x"></i>
                            <p style="margin-top:20px;">ÂΩìÂâçÊ≤°ÊúâÈúÄË¶ÅÂ§ç‰π†ÁöÑÂçïËØç„ÄÇ</p>
                            <button class="action-btn" style="margin-top:10px;" @click="mode='gallery'">ËøîÂõûÂçïËØçÊú¨</button>
                        </div>
                    </div>

                    <div v-if="mode === 'history'" class="history-stage glass-morphism artistic-border">
                        <div class="history-top">
                            <h1 style="font-size:1.8rem; font-weight:bold;">ÂéÜÂè≤Â§ß‰∫ãÂπ¥Ë°®</h1>
                            <div class="history-tabs">
                                <button @click="historyTab = 'asia'" :style="{fontWeight: historyTab==='asia'?'bold':'normal'}">üåè ‰∫öÊ¥≤</button>
                                <button @click="historyTab = 'europe'" :style="{fontWeight: historyTab==='europe'?'bold':'normal'}">üèõÔ∏è Ê¨ßÊ¥≤</button>
                            </div>
                        </div>
                        <div class="timeline-input-group">
                            <input v-model="newEvent.year" placeholder="Âπ¥‰ªΩ (Â¶Ç 1840)" class="t-input" style="flex:1">
                            <input v-model="newEvent.event" placeholder="‰∫ã‰ª∂ÊèèËø∞" class="t-input" style="flex:3">
                            <input v-model="newEvent.tag" placeholder="ÂõæÊ†á" class="t-input" style="flex:0.5; text-align:center;">
                            <button class="t-btn" @click="addTimelineEvent">Ê∑ªÂä†</button>
                        </div>
                        <div class="timeline-wrapper custom-scroll">
                            <div class="timeline-list">
                                <div class="timeline-spine"></div>
                                <div v-for="group in groupedTimelines" :key="group.year" class="year-group">
                                    <div class="t-year-label">{{ group.year }}</div>
                                    <div class="events-container">
                                        <div v-for="item in group.events" :key="item.id" class="t-content">
                                            <div class="t-dot"></div>
                                            {{ item.event }} <span style="font-size:0.8rem; opacity:0.6;">{{ item.tag }}</span>
                                            <i class="fa-solid fa-trash t-del" @click="deleteTimelineEvent(item.id)"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div v-if="mode !== 'history'" class="cat-mascot-container" @click="pokeMascot">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" accept="image/*" style="display:none">
                <div class="cat-img-wrapper" @dblclick="$refs.mascotInput.click()" title="ÂèåÂáªÊõ¥Êç¢Áå´Âí™">
                    <img :src="userCat" class="cat-mascot-img" alt="Cat Mascot">
                </div>
            </div>
        </div>

        <div v-if="showImportModal" class="modal-overlay" @click.self="showImportModal = false">
            <div class="modal-box">
                <h3 style="font-size:1.2rem; font-weight:bold; margin-bottom:15px;">üì• ÊåÇËΩΩÁ¶ªÁ∫øËæûÂÖ∏</h3>
                <p style="font-size:0.9rem; margin-bottom:10px;">ËØ∑‰∏ä‰º† JSON Ê†ºÂºèÁöÑËæûÂÖ∏Êñá‰ª∂</p>
                <input type="file" @change="handleFileSelect" accept=".json">
                <button @click="executeImport" style="width:100%; margin-top:20px; padding:10px; background:var(--color-accent); color:white; border-radius:8px;">Á°ÆËÆ§ÊåÇËΩΩ</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // IndexedDB Êï∞ÊçÆÂ∫ì
        class DictionaryDB {
            constructor() { this.dbName = 'MemoriDB_V4_Academic'; this.db = null; }
            async open() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        ['jp', 'cjp', 'zh', 'lzh', 'en', 'de', 'it', 'lat', 'kr'].forEach(lang => {
                            if (!db.objectStoreNames.contains(lang)) db.createObjectStore(lang, { keyPath: 'word' });
                        });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = (e) => reject(e);
                });
            }
            async find(lang, word) {
                if (!this.db) await this.open();
                return new Promise((resolve) => {
                    if (!this.db.objectStoreNames.contains(lang)) return resolve(null);
                    const tx = this.db.transaction(lang, 'readonly');
                    const req = tx.objectStore(lang).get(word);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            }
            async bulkAdd(lang, items) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    if (!this.db.objectStoreNames.contains(lang)) return reject('Invalid Lang');
                    const tx = this.db.transaction(lang, 'readwrite');
                    const store = tx.objectStore(lang);
                    let count = 0;
                    items.forEach(item => {
                        store.put({ 
                            word: item.word || item.wordName, 
                            reading: item.reading || item.pronunciation || '',
                            meaning: item.meaning || item.wordDesc,
                            isLocal: true
                        });
                        count++;
                    });
                    tx.oncomplete = () => resolve(count);
                    tx.onerror = (e) => reject(e);
                });
            }
        }

        createApp({
            setup() {
                const db = new DictionaryDB();
                const showCover = ref(true);
                const currentLang = ref('cjp');
                const wordInput = ref('');
                const loading = ref(false);
                const imageLoading = ref(false);
                const neroState = ref('idle');
                const isFlipped = ref(false);
                const history = ref([]);
                const card = ref(null);
                const mode = ref('gallery');
                const showImportModal = ref(false);
                const importFile = ref(null);
                const historyTab = ref('asia');
                const newEvent = ref({ year: '', event: '', tag: 'üìå' });

                // Review Logic
                const reviewQueue = ref([]);
                const reviewCard = ref(null);
                const showReviewAnswer = ref(false);

                // ËµÑÊ∫êÈÖçÁΩÆ
                const defaultBg = 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1600&q=80'; 
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };
                const shibaImages = { idle: './shiba/idle.gif', thinking: './shiba/run.gif', happy: './shiba/happy.gif' };
                const userCat = ref(localStorage.getItem('memori-user-cat') || './my-cat.png');

                const langConfig = {
                    cjp: { name: 'Âè§ÂÖ∏Êó•ËØ≠', flag: 'üèØ', code: 'ja-JP', bg: 'linear-gradient(to top, #EBE6DF 0%, #F2EFE8 100%)', accent: '#5A3D30', font: "'Zen Old Mincho', serif" },
                    lzh: { name: 'Âè§‰ª£Ê±âËØ≠', flag: 'üìú', code: 'zh-CN', bg: 'linear-gradient(to top, #E9EAE4 0%, #F4F5F0 100%)', accent: '#41555D', font: "'Zen Old Mincho', serif" },
                    jp: { name: 'Êó•ËØ≠', flag: 'üáØüáµ', code: 'ja-JP', bg: 'linear-gradient(to top, #F9F1F0 0%, #FCEFE8 100%)', accent: '#CB3A56', font: "'Zen Old Mincho', serif" },
                    zh: { name: 'Áé∞‰ª£Ê±âËØ≠', flag: 'üá®üá≥', code: 'zh-CN', bg: 'linear-gradient(120deg, #FBF8F1 0%, #F6F4EF 100%)', accent: '#9D2933', font: "'Noto Serif SC', serif" },
                    en: { name: 'Ëã±ËØ≠', flag: 'üá¨üáß', code: 'en-US', bg: 'linear-gradient(-20deg, #E6E8EB 0%, #EDF1F4 100%)', accent: '#1772B4', font: "'Playfair Display', serif" },
                    de: { name: 'Âæ∑ËØ≠', flag: 'üá©üá™', code: 'de-DE', bg: 'linear-gradient(to top, #E8ECEB 0%, #EFF2F1 100%)', accent: '#374E59', font: "'Playfair Display', serif" },
                    it: { name: 'ÊÑèËØ≠', flag: 'üáÆüáπ', code: 'it-IT', bg: 'linear-gradient(120deg, #F8F4E8 0%, #FAF6EE 100%)', accent: '#8E4932', font: "'Playfair Display', serif" },
                    lat: { name: 'Êãâ‰∏ÅËØ≠', flag: 'üèõÔ∏è', code: 'it-IT', bg: 'linear-gradient(to top, #EAE8E6 0%, #F0EEEC 100%)', accent: '#605A54', font: "'Cinzel', serif" },
                    kr: { name: 'Èü©ËØ≠', flag: 'üá∞üá∑', code: 'ko-KR', bg: 'linear-gradient(to top, #F7EFF2 0%, #F9EDF1 100%)', accent: '#B25D7E', font: "'Noto Serif KR', serif" }
                };

                const filteredHistory = computed(() => history.value.filter(item => item.lang === currentLang.value && item.isCollected));

                // ÂéÜÂè≤Âπ¥Ë°®Êï∞ÊçÆ
                const timelines = ref({
                    asia: [
                        { id: 1, year: 'Ââç7000', event: 'Ê≤≥ÂßÜÊ∏°ÊñáÂåñ', tag: 'üá®üá≥' },
                        { id: 100, year: 'Ââç221', event: 'Áß¶ÂßãÁöáÁªü‰∏Ä', tag: 'üß±' },
                        { id: 1009, year: '1868', event: 'ÊòéÊ≤ªÁª¥Êñ∞', tag: '‚öôÔ∏è' }
                    ],
                    europe: [
                        { id: 2001, year: 'Ââç3000', event: 'Â∑®Áü≥Èòµ', tag: 'ü™®' },
                        { id: 2002, year: '1789', event: 'Ê≥ïÂõΩÂ§ßÈù©ÂëΩ', tag: 'üá´üá∑' }
                    ]
                });
                
                const groupedTimelines = computed(() => { 
                    const list = timelines.value[historyTab.value].sort((a,b) => parseInt(a.year.replace(/\D/g,'')) - parseInt(b.year.replace(/\D/g,'')));
                    return list.map(item => ({ year: item.year, events: [item] })); 
                });

                function addTimelineEvent() {
                    if(!newEvent.value.year || !newEvent.value.event) return;
                    timelines.value[historyTab.value].push({ 
                        id: Date.now(), 
                        year: newEvent.value.year, 
                        event: newEvent.value.event, 
                        tag: newEvent.value.tag 
                    });
                    newEvent.value = { year: '', event: '', tag: 'üìå' };
                    saveTimelines();
                }
                function deleteTimelineEvent(id) {
                    if(confirm('Âà†Èô§Ê≠§ÂéÜÂè≤Êù°ÁõÆÔºü')) {
                        timelines.value[historyTab.value] = timelines.value[historyTab.value].filter(t => t.id !== id);
                        saveTimelines();
                    }
                }
                function saveTimelines() { localStorage.setItem('memori-timelines', JSON.stringify(timelines.value)); }

                onMounted(async () => {
                    await db.open();
                    const saved = localStorage.getItem('memori-book');
                    if (saved) history.value = JSON.parse(saved);
                    const savedTime = localStorage.getItem('memori-timelines');
                    if (savedTime) timelines.value = JSON.parse(savedTime);
                    
                    const img = new Image();
                    img.src = coverImages.bg;
                    img.onerror = () => { coverImages.bg = defaultBg; };
                });

                async function handleSearch() {
                    if (!wordInput.value.trim()) return;
                    loading.value = true;
                    imageLoading.value = true;
                    mode.value = 'card';
                    isFlipped.value = false;
                    
                    const query = wordInput.value.trim();
                    const lang = currentLang.value;

                    // Êú¨Âú∞Êü•Êâæ
                    const localHit = await db.find(lang, query);
                    if (localHit) {
                        card.value = { ...localHit, id: Date.now(), lang, isLocal: true, imageUrl: '' };
                        fetchEnrichment(query, lang);
                        loading.value = false;
                        return;
                    }

                    // ‰∫ëÁ´ØÂèëÊéò
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word: query, lang: lang, type: 'full' })
                        });
                        const data = await res.json();
                        card.value = { id: Date.now(), ...data, lang: lang, isLocal: false, isCollected: false, imageUrl: '' };
                    } catch (e) {
                        alert('ËÄÉÂè§ÊåñÊéòÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API Key');
                    } finally {
                        loading.value = false;
                    }
                }

                async function fetchEnrichment(word, lang) {
                    try {
                        const res = await fetch('/api/openai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ word, lang, type: 'enrich' })
                        });
                        const data = await res.json();
                        if (card.value.word === word) {
                            card.value.etymology = data.etymology;
                            card.value.examples = data.examples;
                        }
                    } catch (e) { console.log('Ë°•ÂÖ®Â§±Ë¥•'); }
                }

                // Â§ç‰π†ÈÄªËæë
                function startReview() {
                    const now = Date.now();
                    // ÊâæÂá∫ÊâÄÊúâÊî∂ËóèÁöÑÂçïËØç‰∏≠ÔºåÂ§ç‰π†Êó∂Èó¥Â∑≤Âà∞ÁöÑ
                    reviewQueue.value = filteredHistory.value.filter(w => !w.nextReview || w.nextReview <= now);
                    if(reviewQueue.value.length === 0) { alert('ÂΩìÂâçÊ≤°ÊúâÈúÄË¶ÅÂ§ç‰π†ÁöÑÂçïËØçÔºÅ'); return; }
                    mode.value = 'review';
                    nextReviewCard();
                }
                function nextReviewCard() {
                    if(reviewQueue.value.length === 0) { alert('Êú¨ËΩÆÂ§ç‰π†ÁªìÊùüÔºÅ'); mode.value = 'gallery'; return; }
                    reviewCard.value = reviewQueue.value.shift();
                    showReviewAnswer.value = false;
                }
                function handleSRS(level) {
                    // 1:1Â§©, 2:3Â§©, 3:7Â§©, 4:15Â§©
                    const days = level === 1 ? 1 : level === 2 ? 3 : level === 3 ? 7 : 15;
                    const word = reviewCard.value;
                    // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÁöÑËØ•ËØç
                    const idx = history.value.findIndex(h => h.id === word.id);
                    if(idx > -1) {
                        history.value[idx].nextReview = Date.now() + (days * 24 * 60 * 60 * 1000);
                        localStorage.setItem('memori-book', JSON.stringify(history.value));
                    }
                    nextReviewCard();
                }

                function saveHistory() { localStorage.setItem('memori-book', JSON.stringify(history.value)); }
                function handleImageError(e) { e.target.style.display = 'none'; }
                function speak(text, lang) { 
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = langConfig[lang]?.code || 'en-US';
                    window.speechSynthesis.speak(u); 
                }
                function handleFileSelect(e) { importFile.value = e.target.files[0]; }
                async function executeImport() {
                    if (!importFile.value) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const count = await db.bulkAdd(currentLang.value, Array.isArray(json) ? json : []);
                            alert(`ÊàêÂäüÂØºÂÖ• ${count} Êù°!`);
                            showImportModal.value = false;
                        } catch(err) { alert('JSON Ê†ºÂºèÈîôËØØ'); }
                    };
                    reader.readAsText(importFile.value);
                }
                function formatInteractiveText(text) { 
                    if(!text) return '';
                    return text.replace(/([\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]+)/g, '<span class="interactive-word" onclick="document.dispatchEvent(new CustomEvent(\'search-word\', {detail: \'$1\'}))">$1</span>');
                }
                document.addEventListener('search-word', (e) => { wordInput.value = e.detail; handleSearch(); });

                function enterApp() { showCover.value = false; }
                function switchLang(key) { currentLang.value = key; mode.value = 'card'; }
                function loadWord(item) { card.value = item; mode.value = 'card'; isFlipped.value = false; }
                function deleteWord(id) { 
                    if(confirm('Âà†Èô§Ê≠§ËØçÔºü')) {
                        history.value = history.value.filter(i => i.id !== id); 
                        saveHistory(); 
                    }
                }
                function deleteGalleryItem(id) { deleteWord(id); }
                function clearCurrentHistory() { if(confirm('Ê∏ÖÁ©∫ÂΩìÂâçËØ≠Ë®ÄÂéÜÂè≤Ôºü')) { history.value = history.value.filter(i => i.lang !== currentLang.value); saveHistory(); } }
                function toggleCollect() { 
                    if(!card.value) return;
                    card.value.isCollected = !card.value.isCollected;
                    // Â¶ÇÊûúÊòØÊî∂ËóèÔºåÂä†ÂÖ•ÂéÜÂè≤ÔºõÂèñÊ∂àÊî∂ËóèÔºå‰ªéÂéÜÂè≤ÁßªÈô§
                    if(card.value.isCollected) {
                        const exists = history.value.find(h => h.word === card.value.word && h.lang === card.value.lang);
                        if(!exists) history.value.unshift({...card.value, nextReview: Date.now()}); 
                    } else {
                        history.value = history.value.filter(h => h.word !== card.value.word || h.lang !== card.value.lang);
                    }
                    saveHistory(); 
                }
                function toggleImageLock() { card.value.isImageLocked = !card.value.isImageLocked; saveHistory(); }
                function pokeMascot() { neroState.value = 'happy'; setTimeout(()=>neroState.value='idle', 1000); }
                function handleMascotUpload(e) { 
                    const f = e.target.files[0]; 
                    if(f) { const r = new FileReader(); r.onload=ev=>{ userCat.value=ev.target.result; localStorage.setItem('memori-user-cat', ev.target.result); }; r.readAsDataURL(f); }
                }

                return {
                    showCover, enterApp, currentLang, wordInput, loading, imageLoading, neroState, isFlipped, history, card, mode, showImportModal, historyTab, newEvent,
                    langConfig, coverImages, shibaImages, userCat, filteredHistory, timelines, groupedTimelines,
                    handleSearch, speak, handleImageError, handleFileSelect, executeImport, formatInteractiveText,
                    switchLang, loadWord, deleteWord, deleteGalleryItem, clearCurrentHistory, toggleCollect, toggleImageLock, pokeMascot, handleMascotUpload,
                    addTimelineEvent, deleteTimelineEvent,
                    startReview, nextReviewCard, handleSRS, reviewQueue, reviewCard, showReviewAnswer
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
