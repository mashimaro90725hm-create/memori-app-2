<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memori - Ë®ÄÂè∂„ÅÆËÄÉÂè§Â≠¶</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
/* --- üèÆ ‰∏≠ÂõΩËâ≤‰∏ªÈ¢òÂèòÈáè (Zhongguose Palette) --- */
:root {
  --color-bg-main: #E2E1E4; /* Ëä°È£üÁôΩ */
  --color-text-main: #2D241E; /* ‰πåËâ≤ */
  --color-accent: #CB3A56; /* ËåúËâ≤ */
  --color-accent-hover: #EF7A82; /* Â´£Á∫¢ */
  --glass-bg: rgba(255, 253, 248, 0.75); 
  --glass-border: rgba(203, 58, 86, 0.15); 
}

* { box-sizing: border-box; }
.app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; transition: background 0.5s ease, font-family 0.3s; position: relative; color: var(--color-text-main); }
.app-container.with-texture::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; mix-blend-mode: multiply; }

.glass-morphism { background: var(--glass-bg); backdrop-filter: blur(20px) saturate(110%); border: 1px solid var(--glass-border); box-shadow: 0 4px 12px -1px rgba(45, 36, 30, 0.08), 0 2px 4px -1px rgba(45, 36, 30, 0.04), inset 0 0 20px rgba(255, 253, 248, 0.3); border-radius: 24px; }
.artistic-border { border-radius: 24px; }

/* üö™ Â∞ÅÈù¢È°µ‰øÆÂ§çÔºöÂ§ÑÁêÜÁå´Âí™ÈÅÆÊå°ÊåâÈíÆÈóÆÈ¢ò */
.cover-stage.classic-theme { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; z-index: 1000; overflow: hidden; }
.cover-overlay-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(45, 36, 30, 0.6) 0%, rgba(45, 36, 30, 0.2) 60%, transparent 100%); }
.cover-content-layout { position: relative; z-index: 2; width: 90%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; height: 80vh; }
.cover-text-group.jp-style { flex: 1; color: #f8f4e6; text-shadow: 0 2px 10px rgba(0,0,0,0.6); padding-left: 50px; text-align: right; z-index: 100; }
.cover-title-main { font-family: 'Zen Old Mincho', serif; font-size: 5rem; font-weight: 700; margin: 0; letter-spacing: 0.05em; color: #fff; }
.subtitle-main { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; letter-spacing: 0.3em; margin-top: 15px; opacity: 0.95; color: var(--color-bg-main); }
.poem-main { font-family: 'Zen Old Mincho', serif; font-size: 1.3rem; line-height: 2; margin-top: 50px; opacity: 0.9; }

/* Êé¢Á¥¢ÈîÆÊ†∏ÂøÉ‰øÆÂ§ç */
.start-btn-main.jp-btn { 
    margin-top: 60px; font-family: 'Noto Serif JP', serif; padding: 16px 48px; font-size: 1.2rem; font-weight: 700; 
    background: linear-gradient(135deg, var(--color-accent) 0%, #A62C45 100%); color: #fff; border: none; border-radius: 4px; 
    cursor: pointer; transition: all 0.4s; letter-spacing: 0.1em; box-shadow: 0 4px 20px rgba(203, 58, 86, 0.4); 
    pointer-events: auto !important; position: relative; z-index: 110; 
}
.start-btn-main.jp-btn:hover { transform: translateY(-3px) scale(1.02); background: linear-gradient(135deg, var(--color-accent-hover) 0%, var(--color-accent) 100%); box-shadow: 0 8px 30px rgba(203, 58, 86, 0.5); }

.cover-cat-wrapper { flex: 0 0 40%; height: 100%; display: flex; justify-content: flex-start; align-items: flex-end; z-index: 1; pointer-events: none; }
.cover-cat-large { max-width: 100%; max-height: 75vh; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(60, 40, 30, 0.6)); transform: translateX(-10%) scaleX(-1); }

/* Sidebar */
.sidebar { width: 280px; display: flex; flex-direction: column; padding: 30px 20px; z-index: 20; margin: 20px 0 20px 20px; }
.sidebar-header { padding: 0 10px 16px; border-bottom: 1px solid var(--glass-border); }
.sidebar-header h3 { font-size: 1.2rem; font-weight: bold; margin: 0; display: flex; justify-content: space-between; font-family: inherit; }
.count { font-size: 0.8rem; opacity: 0.7; font-family: sans-serif; }
.word-list { flex: 1; overflow-y: auto; padding: 15px 0; }
.custom-scroll::-webkit-scrollbar { width: 6px; }
.custom-scroll::-webkit-scrollbar-track { background: rgba(45, 36, 30, 0.05); border-radius: 3px; }
.custom-scroll::-webkit-scrollbar-thumb { background: rgba(45, 36, 30, 0.2); border-radius: 3px; }
.word-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; margin-bottom: 10px; border-radius: 16px; cursor: pointer; transition: all 0.2s; color: var(--color-text-main); border-left: 4px solid transparent; position: relative; background: rgba(255, 253, 248, 0.5); }
.word-item:hover { background: rgba(255, 253, 248, 0.85); transform: translateX(2px); }
.word-item.active { background: white; box-shadow: 0 4px 12px rgba(45, 36, 30, 0.08); font-weight: bold; color: var(--color-text-main); }
.item-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; position: absolute; right: 12px; z-index: 20; background: var(--glass-bg); border-radius: 8px; padding: 3px; box-shadow: 0 2px 8px rgba(45, 36, 30, 0.1); }
.word-item:hover .item-actions { opacity: 1; }
.del-icon { opacity: 0.8; border: none; background: none; color: var(--color-accent); cursor: pointer; font-weight: bold; padding: 4px 8px; font-size: 1.1rem; transition: opacity 0.2s; }
.del-icon:hover { opacity: 1; }
.sidebar-footer { padding-top: 25px; display: flex; flex-direction: column; gap: 12px; position: relative; border-top: 1px solid var(--glass-border); }
.action-btn.artistic-btn { width: 100%; padding: 14px; border: none; border-radius: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: inherit; transition: all 0.2s; letter-spacing: 0.5px; }
.action-btn.primary { color: white; box-shadow: 0 4px 12px rgba(203, 58, 86, 0.25); }
.action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(203, 58, 86, 0.35); background-color: var(--color-accent-hover) !important; }
.action-btn.outline { background: rgba(255, 253, 248, 0.6); color: var(--color-text-main); border: 1px solid var(--glass-border); }
.action-btn.outline:hover { background: white; border-color: var(--color-accent); transform: translateY(-2px); color: var(--color-accent); }

/* Mascots */
.shiba-mascot { position: absolute; bottom: 100%; right: 0px; width: 135px; height: 135px; cursor: pointer; z-index: 20; transition: transform 0.2s; margin-bottom: 15px; }
.shiba-mascot:hover { transform: scale(1.05) rotate(3deg); }
.shiba-img { width: 100%; height: 100%; object-fit: contain; drop-shadow: 0 5px 15px rgba(45, 36, 30, 0.15); }
.shiba-bubble { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: white; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); animation: popIn 0.3s; color: var(--color-text-main); }
.shiba-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: white transparent transparent transparent; }
.cat-mascot-container { position: fixed; bottom: 30px; right: 30px; width: 280px; height: 280px; cursor: pointer; z-index: 100; transition: transform 0.3s ease; }
.cat-mascot-container:hover { transform: scale(1.03); }
.cat-img-wrapper { width: 100%; height: 100%; transform: scaleX(-1); filter: drop-shadow(0 10px 25px rgba(45, 36, 30, 0.3)); }
.cat-mascot-img { width: 100%; height: 100%; object-fit: contain; }
.idle-anim { animation: float 3.5s ease-in-out infinite; }
.thinking-anim { animation: tilt 0.6s ease-in-out infinite alternate; }
.cat-mascot-container.poked .cat-mascot-img { animation: jump 0.5s cubic-bezier(0.28, 0.84, 0.42, 1); }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
@keyframes tilt { 0% { transform: rotate(-6deg); } 100% { transform: rotate(6deg); } }
@keyframes jump { 0% { transform: scale(1,1) translateY(0); } 30% { transform: scale(0.92,1.08) translateY(-50px); } 100% { transform: scale(1,1) translateY(0); } }
.cat-bubble { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 20px; font-size: 1.1rem; font-weight: bold; white-space: nowrap; box-shadow: 0 5px 15px rgba(45, 36, 30, 0.15); animation: popIn 0.3s; color: var(--color-text-main); }
.cat-bubble::after { content: ''; position: absolute; bottom: -8px; left: 50%; margin-left: -8px; border-width: 8px; border-style: solid; border-color: white transparent transparent transparent; }
@keyframes popIn { from { opacity: 0; transform: translateX(-50%) scale(0.5) translateY(20px); } to { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); } }

/* Main Stage & Transitions */
.main-stage { flex: 1; position: relative; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
.search-bar { margin: 0 20px 25px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
.lang-pills { display: flex; gap: 10px; }
.lang-pill { width: 36px; height: 36px; border-radius: 12px; border: 1px solid transparent; background: rgba(255, 253, 248, 0.5); cursor: pointer; font-size: 18px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; color: var(--color-text-main); }
.lang-pill.active { background: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(45, 36, 30, 0.1); border-color: var(--glass-border); }
.search-input { border: none; background: transparent; padding: 10px; flex: 1; margin: 0 25px; outline: none; font-size: 1.2rem; font-family: inherit; color: var(--color-text-main); }
.search-input::placeholder { color: rgba(45, 36, 30, 0.5); }
.search-btn { border: none; background: transparent; cursor: pointer; font-size: 1.3rem; transition: transform 0.2s; }
.search-btn:hover { transform: scale(1.1); color: var(--color-accent-hover) !important; }

/* Timeline List */
.history-stage { flex: 1; margin: 0 20px 20px; padding: 35px; display: flex; flex-direction: column; overflow: hidden; }
.timeline-wrapper { flex: 1; overflow-y: auto; padding-right: 20px; scroll-padding-top: 20px; }
.t-content { flex: 1; background: rgba(255, 253, 248, 0.9); padding: 15px 22px; transition: transform 0.2s, box-shadow 0.2s; position: relative; border: 1px solid var(--glass-border); border-radius: 18px; }
.year-number { font-weight: 800; font-size: 1.2rem; color: var(--color-text-main); background: rgba(255, 253, 248, 0.95); padding: 4px 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(45, 36, 30, 0.06); font-family: sans-serif; border: 1px solid var(--glass-border); }

@keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app">
        <Transition name="fade">
            <div v-if="showCover" class="cover-stage classic-theme" :style="{ backgroundImage: `url(${coverImages.bg})` }">
                <div class="cover-overlay-gradient"></div>
                <div class="cover-content-layout">
                    <div class="cover-cat-wrapper"><img :src="coverImages.cat" class="cover-cat-large" alt="Cover Cat"></div>
                    <div class="cover-text-group jp-style">
                        <h1 class="cover-title-main">Memori</h1>
                        <p class="subtitle-main">Ë®ÄËëâ„ÅÆËÄÉÂè§Â≠¶</p>
                        <div class="poem-main"><p>ÊôÇ„ÅÆÁ†Ç„Å´Âüã„ÇÇ„Çå„Åü„ÄÅ</p><p>Ë®ÄËëâ„ÅÆÊ¨†Áâá„ÇíÊé¢„Åó„Å¶„ÄÇ</p></div>
                        <button class="start-btn-main jp-btn" @click="enterApp">Êé¢Á¥¢„ÇíÂßã„ÇÅ„Çã</button>
                    </div>
                </div>
            </div>
        </Transition>

        <div v-if="!showCover" class="app-container with-texture" :style="{ background: langConfig[currentLang].bg, fontFamily: langConfig[currentLang].font }">
            <aside class="sidebar glass-morphism artistic-border">
                <div class="sidebar-header">
                    <h3 :style="{ color: langConfig[currentLang].accent }">
                        {{ langConfig[currentLang].flag }} {{ langConfig[currentLang].name }} 
                        <span class="count">{{ filteredHistory.length }} ËØç</span>
                    </h3>
                </div>
                <div class="word-list custom-scroll">
                    <div v-for="item in filteredHistory" :key="item.id" class="word-item" :class="{ 'active': mode === 'card' && item.id === card.id }" :style="(mode === 'card' && item.id === card.id) ? { borderLeftColor: langConfig[currentLang].accent } : {}" @click="loadWord(item)">
                        <span class="word-text">{{ item.word }}</span>
                        <div class="item-actions"><button class="del-icon" @click.stop="deleteWord(item.id)">√ó</button></div>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="shiba-mascot" @click="pokeMascot">
                        <img :src="shibaImages[neroState]" class="shiba-img" alt="Shiba">
                        <div v-if="neroState === 'thinking'" class="shiba-bubble">ÂóÖÂóÖ...</div>
                        <div v-if="neroState === 'happy'" class="shiba-bubble">È¶ôÔºÅ</div>
                    </div>
                    <button class="action-btn primary artistic-btn" @click="startReview" :style="{ backgroundColor: langConfig[currentLang].accent }"><i class="fa-solid fa-layer-group"></i> Â§ç‰π†</button>
                    <button class="action-btn outline artistic-btn" @click="mode = 'history'"><i class="fa-solid fa-scroll"></i> ÂéÜÂè≤Âπ¥Ë°®</button>
                </div>
            </aside>

            <main class="main-stage">
                <div class="search-bar glass-morphism artistic-border">
                    <div class="lang-pills">
                        <button v-for="(cfg, key) in langConfig" :key="key" @click="switchLang(key)" class="lang-pill" :class="{ 'active': currentLang === key }" :title="cfg.scent">{{ cfg.flag }}</button>
                    </div>
                    <input v-model="wordInput" @keyup.enter="generateCard" :placeholder="`ÂØªÊâæ${langConfig[currentLang].name}ÁöÑÂë≥ÈÅì...`" class="search-input">
                    <button @click="generateCard" class="search-btn" :disabled="loading" :style="{ color: langConfig[currentLang].accent }"><i v-if="loading" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-magnifying-glass"></i></button>
                </div>

                <Transition name="fade-mode" mode="out-in">
                    <div v-if="mode === 'card'" class="content-area" key="card">
                        <div class="flex justify-center items-center h-full">
                            <div class="bg-white w-[400px] min-h-[500px] rounded-[24px] shadow-lg p-10 flex flex-col items-center text-center border border-[#EAE3D9] animate-in slide-in-from-bottom-5">
                                <div class="text-[#CB3A56] font-sans text-sm tracking-widest mb-2 uppercase">{{ card.reading }}</div>
                                <h2 class="text-4xl font-bold font-serif tracking-widest text-[#2D241E] mb-6">{{ card.word }}</h2>
                                <div class="w-full h-px bg-gradient-to-r from-transparent via-[#D5C9BB] to-transparent mb-8"></div>
                                <div class="text-lg leading-relaxed text-[#2D241E] mb-8 text-left w-full overflow-y-auto max-h-[250px] custom-scroll" v-html="card.meaning"></div>
                                <div class="mt-auto flex gap-4 w-full">
                                    <button class="flex-1 bg-[#CB3A56] text-white font-bold py-4 rounded-xl shadow-md hover:bg-[#EF7A82] transition-all" @click="toggleCollect">{{ card.isCollected ? 'Â∑≤Êî∂Ëóè' : 'Êî∂ËóèÂçïËØç' }}</button>
                                    <button class="w-16 bg-[#F0EAE1] text-[#5C4B3C] rounded-xl flex items-center justify-center text-xl hover:bg-white transition-all border border-[#EAE3D9]" @click="speak(card.word)"><i class="fa-solid fa-volume-high"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="mode === 'history'" class="history-stage glass-morphism artistic-border" key="history">
                        <div class="flex justify-between items-center mb-8 border-b border-pink-100 pb-4">
                            <h1 class="text-3xl font-serif font-bold text-[#CB3A56]">ÂéÜÂè≤Â§ß‰∫ãÂπ¥Ë°®</h1>
                            <button class="text-3xl text-gray-300 hover:text-[#CB3A56]" @click="mode = 'card'"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="timeline-wrapper custom-scroll">
                            <div v-for="group in groupedTimelines" :key="group.year" class="flex gap-8 mb-10 relative">
                                <div class="w-24 text-right pt-2 sticky top-0"><span class="year-number">{{ group.year }}</span></div>
                                <div class="flex-1 flex flex-col gap-4">
                                    <div v-for="item in group.events" :key="item.id" class="t-content group" draggable="true" @dragstart="onDragStart($event, item)" @drop="onDrop($event, item)" @dragover.prevent>
                                        <div class="flex items-center gap-4">
                                            <span class="text-2xl">{{ item.tag }}</span>
                                            <span class="text-lg font-serif flex-1">{{ item.event }}</span>
                                            <button class="opacity-0 group-hover:opacity-100 text-red-400 font-bold px-2 transition-opacity" @click="deleteTimelineEvent(item.id)">√ó</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </Transition>
            </main>

            <div v-if="mode !== 'history'" class="cat-mascot-container" @click="pokeMascot" :class="{ 'poked': neroState === 'happy' }" title="ÂèåÂáª‰∏ä‰º†Áå´Âí™" @dblclick="triggerMascotInput">
                <input type="file" ref="mascotInput" @change="handleMascotUpload" accept="image/*" style="display:none">
                <div class="cat-img-wrapper"><img :src="userCat" class="cat-mascot-img" alt="Cat Mascot"></div>
                <div v-if="neroState === 'thinking'" class="cat-bubble">ÊåñÊéò‰∏≠...</div>
                <div v-if="neroState === 'happy'" class="cat-bubble">Âñµ~‚ú®</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        createApp({
            setup() {
                const showCover = ref(true);
                const currentLang = ref('jp');
                const wordInput = ref('');
                const loading = ref(false);
                const neroState = ref('idle');
                const history = ref([]); 
                const mode = ref('card');
                const mascotInput = ref(null);
                const reviewCounts = ref(JSON.parse(localStorage.getItem('memori-review-counts') || '{}'));
                const userCat = ref(localStorage.getItem('memori-user-cat') || './my-cat.png');
                const shibaImages = { idle: './shiba/idle.gif', thinking: './shiba/run.gif', happy: './shiba/happy.gif' };
                const coverImages = { bg: './cover-bg.jpg', cat: './cover-cat.png' };

                const card = ref({ id: Date.now(), word: 'Memori', reading: 'me-mo-ri', meaning: 'Ê¨¢ËøéÊù•Âà∞ËØ≠Ë®ÄËÄÉÂè§ÂèëÊéòÁé∞Âú∫', examples: [], lang: 'jp', isCollected: false });

                const langConfig = {
                    jp: { name: 'Êó•ËØ≠', flag: 'üáØüáµ', voice: 'ja-JP', bg: 'linear-gradient(to top, #F9F1F0 0%, #FCEFE8 100%)', accent: '#CB3A56', font: "'Zen Old Mincho', serif" },
                    zh: { name: 'Ê±âËØ≠', flag: 'üá®üá≥', voice: 'zh-CN', bg: 'linear-gradient(120deg, #FBF8F1 0%, #F6F4EF 100%)', accent: '#9D2933', font: "'Noto Serif SC', serif" },
                    en: { name: 'Ëã±ËØ≠', flag: 'üá¨üáß', voice: 'en-US', bg: 'linear-gradient(-20deg, #E6E8EB 0%, #EDF1F4 100%)', accent: '#1772B4', font: "'Playfair Display', serif" },
                    lat: { name: 'Êãâ‰∏Å', flag: 'üèõÔ∏è', voice: 'it-IT', bg: '#EAE8E6', accent: '#605A54', font: "'Cinzel', serif" }
                };

                const timelines = ref({ asia: [ { id: 1, year: 'Ââç7000', event: 'Ê≤≥ÂßÜÊ∏°ÊñáÂåñ', tag: 'üá®üá≥' } ], europe: [] });

                const filteredHistory = computed(() => history.value.filter(item => (item.lang || 'jp') === currentLang.value));
                const groupedTimelines = computed(() => {
                    const list = timelines.value.asia.concat(timelines.value.europe);
                    const groups = {};
                    list.forEach(e => { if(!groups[e.year]) groups[e.year] = { year: e.year, events: [] }; groups[e.year].events.push(e); });
                    return Object.values(groups);
                });

                async function generateCard() {
                    if (!wordInput.value) return;
                    loading.value = true; neroState.value = 'thinking'; mode.value = 'card';
                    try {
                        const res = await fetch('/api/openai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ word: wordInput.value, lang: currentLang.value }) });
                        const data = await res.json();
                        card.value = { id: Date.now(), ...data, lang: currentLang.value, isCollected: false };
                        speak(card.value.word);
                        neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 2000);
                        wordInput.value = '';
                    } catch (e) { alert('ÊåñÊéòÂ§±Ë¥•'); } finally { loading.value = false; }
                }

                function toggleCollect() {
                    if (card.value.isCollected) {
                        history.value = history.value.filter(h => h.id !== card.value.id);
                        card.value.isCollected = false;
                    } else {
                        card.value.isCollected = true;
                        history.value.unshift({...card.value, nextReview: Date.now(), interval: 0});
                    }
                    localStorage.setItem('memori-book', JSON.stringify(history.value));
                }

                function speak(t) {
                    window.speechSynthesis.cancel();
                    const ut = new SpeechSynthesisUtterance(t);
                    ut.lang = langConfig[currentLang.value].voice;
                    window.speechSynthesis.speak(ut);
                }

                onMounted(() => {
                    const saved = localStorage.getItem('memori-book'); if (saved) history.value = JSON.parse(saved);
                    const savedT = localStorage.getItem('memori-timelines-v19'); if (savedT) timelines.value = JSON.parse(savedT);
                });

                return {
                    showCover, enterApp: () => showCover.value = false, currentLang, wordInput, loading, neroState, history, mode, mascotInput, userCat, shibaImages, coverImages, card, langConfig, filteredHistory, groupedTimelines,
                    generateCard, toggleCollect, speak, switchLang: (l) => { currentLang.value = l; mode.value = 'card'; }, loadWord: (item) => { card.value = item; mode.value = 'card'; }, deleteWord: (id) => { history.value = history.value.filter(h => h.id !== id); localStorage.setItem('memori-book', JSON.stringify(history.value)); },
                    startReview: () => { const due = history.value.filter(h => h.lang === currentLang.value); if (!due.length) return alert("ÊöÇÊó†Â§ç‰π†‰ªªÂä°"); alert("ÂºÄÂßãÂ§ç‰π†ÔºÅ"); },
                    deleteTimelineEvent: (id) => { timelines.value.asia = timelines.value.asia.filter(e => e.id !== id); },
                    pokeMascot: () => { neroState.value = 'happy'; setTimeout(() => neroState.value = 'idle', 1000); },
                    handleMascotUpload: (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { userCat.value = ev.target.result; localStorage.setItem('memori-user-cat', ev.target.result); }; reader.readAsDataURL(file); } }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
